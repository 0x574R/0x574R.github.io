# Shellcode Basics

## ¿Qué es Shellcode?

Shellcode es código máquina diseñado para ser inyectado y ejecutado en la memoria de un proceso. Se llama "shellcode" porque tradicionalmente su objetivo era obtener una shell.

## Características

- **Position Independent**: No depende de direcciones absolutas
- **Null-free**: Evita bytes nulos (`0x00`) que terminan strings
- **Pequeño**: Minimiza el tamaño para caber en buffers limitados

## Desarrollo Básico

### Estructura x86-64

```nasm
; exit.asm - Syscall exit(0)
section .text
    global _start

_start:
    xor rdi, rdi        ; rdi = 0 (exit code)
    mov al, 60          ; syscall number (exit)
    syscall
```

### Compilación

```bash
# Ensamblar
nasm -f elf64 exit.asm -o exit.o

# Linkear
ld exit.o -o exit

# Extraer shellcode
objcopy -O binary exit exit.bin
xxd -i exit.bin
```

### Extracción con objdump

```bash
objdump -d exit | grep -Po '\s\K[a-f0-9]{2}(?=\s)' | sed 's/^/\\x/g' | tr -d '\n'
```

## Técnicas Comunes

### Evitar Null Bytes

=== "❌ Malo"
    ```nasm
    mov rax, 0      ; Contiene 0x00
    mov rdi, 0
    ```

=== "✅ Bueno"
    ```nasm
    xor rax, rax    ; rax = 0, sin null bytes
    xor rdi, rdi
    ```

### Push String

```nasm
; Push "/bin/sh" a la pila
xor rax, rax
push rax                    ; null terminator
mov rdi, 0x68732f6e69622f   ; /bin/sh en little endian
push rdi
mov rdi, rsp                ; rdi apunta al string
```

## Shellcode Loader en C

```c
#include <stdio.h>
#include <string.h>
#include <sys/mman.h>

unsigned char shellcode[] = 
    "\x48\x31\xff"      // xor rdi, rdi
    "\xb0\x3c"          // mov al, 60
    "\x0f\x05";         // syscall

int main() {
    void *exec = mmap(NULL, sizeof(shellcode), 
                      PROT_READ | PROT_WRITE | PROT_EXEC,
                      MAP_ANONYMOUS | MAP_PRIVATE, -1, 0);
    
    memcpy(exec, shellcode, sizeof(shellcode));
    ((void(*)())exec)();
    
    return 0;
}
```

```bash
gcc -z execstack -o loader loader.c
./loader
```

## Recursos

| Recurso | Descripción |
|---------|-------------|
| [Syscall Table](https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/) | Tabla de syscalls x86-64 |
| [Shell-Storm](http://shell-storm.org/shellcode/) | Base de datos de shellcodes |
| [pwntools](https://github.com/Gallopsled/pwntools) | Framework para exploit dev |

---

!!! note "Siguiente paso"
    En el próximo artículo veremos técnicas de inyección de procesos.
