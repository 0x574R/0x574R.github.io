# Shellcode Basics

## ¿Qué es shellcode?

**Shellcode** es código máquina diseñado para ser inyectado y ejecutado en memoria dentro del contexto de un proceso.
Se llama "shellcode" porque históricamente se usaba para obtener una *shell*, pero hoy se utiliza para muchas más cosas.

---

## Características típicas

- **Position Independent (PIC)**: no depende de direcciones absolutas
- **Null-free**: evita bytes `0x00` que rompen strings
- **Compacto**: minimiza tamaño para caber en buffers limitados
- **Self-contained**: no depende de librerías externas

!!! note "Contexto"
    En x86_64, la mayoría de shellcodes modernos usan syscalls directas (sin `libc`).

---

## Estructura x86_64 (Linux)

### Convención de registros para syscalls

- `rax`: número de syscall
- `rdi`, `rsi`, `rdx`, `r10`, `r8`, `r9`: argumentos
- `rax`: valor de retorno

!!! tip "Registro clobber"
    Tras `syscall`, se clobberizan `rcx` y `r11` (además de `rax` por el retorno).

---

## Ejemplo mínimo: `exit(0)`

```nasm
; exit.asm - syscall exit(0)
section .text
global _start

_start:
    xor rdi, rdi      ; status = 0
    mov eax, 60       ; __NR_exit
    syscall
```

---

## Ejemplo: write("RAZOR\n")

```nasm
section .text
global _start

_start:
    ; write(1, msg, len)
    mov eax, 1                ; __NR_write
    mov edi, 1                ; fd = stdout
    lea rsi, [rel msg]
    mov edx, msg_len
    syscall

    ; exit(0)
    xor edi, edi
    mov eax, 60
    syscall

section .rodata
msg: db "RAZOR", 10
msg_len: equ $-msg
```

---

## Loader simple en C

```c
#include <stdio.h>
#include <string.h>
#include <sys/mman.h>

unsigned char sc[] = {
  /* shellcode bytes */
};

int main() {
  void *p = mmap(0, 4096, PROT_READ|PROT_WRITE|PROT_EXEC,
                 MAP_ANON|MAP_PRIVATE, -1, 0);
  memcpy(p, sc, sizeof(sc));
  ((void(*)())p)();
}
```

!!! warning "Nota de seguridad"
    Ejecutar memoria RWX es sospechoso y puede activar EDR/AV. Para laboratorio está bien,
    pero en entornos reales se usan técnicas más sigilosas.

---

## Técnicas comunes

- Evitar **null bytes**
- Construir strings con **push/xor**
- Resolver syscalls por **número**
- Usar *stagers* (descargar payloads más grandes)

---

## Recursos

- Shell-Storm (payloads): https://shell-storm.org
- Linux x86_64 syscalls: https://filippo.io/linux-syscall-table/
